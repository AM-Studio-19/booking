<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM Studio ç·šä¸Šé ç´„</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #f9f8f6; color: #5d4037; }
    
    /* V37: æ¥µç°¡å¡ç‰‡æŒ‰éˆ• (ä»¿ App é¢¨æ ¼) */
    .option-btn { 
      @apply w-full p-5 rounded-2xl mb-3 flex justify-between items-center transition-all duration-200 shadow-sm relative overflow-hidden;
      background-color: #ffffff;      /* ç´”ç™½åº•ï¼Œæœ€æ˜äº® */
      color: #4b5563;                /* æ·±ç°å­— */
      border: 1px solid #f0ebe9;     /* æ¥µæ·¡çš„é‚Šæ¡† */
    }
    
    /* æ»‘é¼ ç¶“é */
    .option-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(141, 110, 99, 0.08); 
      border-color: #d7ccc8;
    }
    
    /* é¸ä¸­ç‹€æ…‹ï¼šå¥¶èŒ¶è‰²æ¡† + æ‰“å‹¾ */
    .option-btn.active { 
      background-color: #fffaf9;     /* æ¥µæ·ºç²‰ç™½åº• */
      color: #5d4037;                /* æ·±å’–å•¡å­— */
      border: 2px solid #8d6e63;     /* æ˜é¡¯çš„é‚Šæ¡† */
      font-weight: bold;
    }

    /* éš±è—åŸç”Ÿç®­é ­ï¼Œæ”¹ç”¨æ‰“å‹¾ */
    .option-btn .check-icon { display: none; }
    .option-btn.active .check-icon { display: block; color: #8d6e63; }

    .guest-block { @apply border-l-4 border-[#8d6e63] pl-5 mb-10 relative bg-white p-5 rounded-r-2xl shadow-sm; }
    
    .spinner {
      border: 3px solid #f3f3f3; border-top: 3px solid #8d6e63; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .date-cell { @apply rounded-lg transition-all duration-200; }
    .date-cell.selected { background-color: #8d6e63; color: white; font-weight: bold; box-shadow: 0 4px 6px rgba(141, 110, 99, 0.2); }
    .date-cell.has-rule { border-bottom: 3px solid #d97706; }
    
    .status-tab { @apply px-4 py-2 rounded-full text-sm font-bold cursor-pointer transition-all border shadow-sm; }
    .status-tab.active { @apply bg-[#8d6e63] text-white border-[#8d6e63] shadow-md; }
    .status-tab.inactive { @apply bg-white text-[#8d6e63] border-[#e7e0da] hover:bg-[#faf7f5]; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>

  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #8d6e63; background-color: #faf9f6;">
      <div class="spinner"></div>
      <p id="loading-text" class="mt-4 font-bold tracking-widest text-sm">AM STUDIO</p>
    </div>
  </div>

  <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; padding:20px; text-align:center;">
    <div style="max-width:500px; margin:50px auto; border:2px solid #ef4444; padding:20px; background:#fff; border-radius:8px;">
        <h2 style="color:#ef4444; font-size:24px; margin-bottom:10px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="error-msg" style="color:#333; margin-bottom:20px; word-break:break-all;"></p>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#8d6e63; color:white; border:none; border-radius:4px;">é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <script>
    window.onerror = function(msg, url, line) {
      document.getElementById('root').style.display = 'none';
      document.getElementById('error-box').style.display = 'block';
      document.getElementById('error-msg').innerHTML = `<strong>åŸå› ï¼š</strong>${msg}<br><br><small>(${url}:${line})</small>`;
      return false;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    
    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    const LIFF_ID = '2008567948-KGMPJPGe'; 
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';
    
    const BANK_INFO = { code: '822 (ä¸­åœ‹ä¿¡è¨—)', account: '1234-5678-9012', name: 'AM Studio', amountPerPerson: 1000 };

    const MAIN_CATS = ["éœ§çœ‰", "éœ§å”‡"]; 
    const SUB_CATS = ["é¦–æ¬¡", "è£œè‰²"];
    const TOUCHUP_SESSIONS = ["ç¬¬ä¸€æ¬¡å›è£œ", "ç¬¬äºŒæ¬¡ä»¥ä¸Š"];

    // --- Init ---
    let db, auth;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.error(e); }

    // --- Icons ---
    const Icon = ({ path, size = 20, className="" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );
    const Icons = {
        map: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
        user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
        chevronRight: <path d="m9 18 6-6-6-6"/>,
        chevronLeft: <path d="m15 18-6-6 6-6"/>,
        check: <polyline points="20 6 9 17 4 12"/>,
        settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
        trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
        plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
        msg: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>,
        search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
        edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
        zap: <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></>,
        tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>,
        up: <polyline points="18 15 12 9 6 15"/>,
        down: <polyline points="6 9 12 15 18 9"/>,
        back: <path d="M19 12H5m7 7l-7-7 7-7"/>,
        cross: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>
    };

    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }
    ];
    const DEFAULT_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DEFAULT_TEMPLATES = [
        { title: 'é ç´„ç¢ºèª', text: 'æ‚¨å¥½ï¼Œæ‚¨çš„é ç´„å·²ç¢ºèªï¼\næ™‚é–“ï¼š{{date}} {{time}}\nåœ°é»ï¼š{{location}}\næœå‹™ï¼š{{service}}\næœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚' },
        { title: 'è¨‚é‡‘å‚¬æ”¶', text: 'æ‚¨å¥½ï¼Œæé†’æ‚¨å°šæœªæ”¯ä»˜è¨‚é‡‘ã€‚\nè«‹åŒ¯æ¬¾è‡³ï¼š822 (ä¸­åœ‹ä¿¡è¨—) 1234-5678-9012\né‡‘é¡ï¼š$1000\nåŒ¯æ¬¾å¾Œè«‹è‡³æŸ¥è©¢é é¢å›å ±ï¼Œè¬è¬ï¼' },
        { title: 'å·²æ”¶è¨‚é‡‘', text: 'æ‚¨å¥½ï¼Œå·²æ”¶åˆ°æ‚¨çš„è¨‚é‡‘åŒ¯æ¬¾ï¼Œé ç´„æ­£å¼ä¿ç•™ã€‚æ„Ÿè¬æ‚¨ï¼' },
        { title: 'é ç´„å–æ¶ˆ', text: 'æ‚¨å¥½ï¼Œæ‚¨çš„é ç´„å·²å–æ¶ˆã€‚è‹¥æœ‰éœ€è¦è«‹å†æ¬¡é ç´„ï¼Œè¬è¬ã€‚' }
    ];

    // --- Components ---
    
    const ServiceSelector = ({ services, onSelect, onCancel }) => {
        const [stage, setStage] = useState('main'); 
        const [mainCat, setMainCat] = useState(null);
        const [subCat, setSubCat] = useState(null);
        const [session, setSession] = useState(null);
        const [isDarkLip, setIsDarkLip] = useState(false);

        const sortedServices = useMemo(() => {
            return [...services].sort((a, b) => (a.order || 999) - (b.order || 999));
        }, [services]);

        const handleMain = (c) => { setMainCat(c); setStage('sub'); };
        const handleSub = (t) => { 
            setSubCat(t); 
            if(t === 'è£œè‰²') setStage('session');
            else setStage('confirm');
        };
        const handleSession = (s) => {
            setSession(s);
            setStage('time');
        };
        const handleTime = (timeRange) => {
            const target = sortedServices.find(s => 
                s.category === mainCat && 
                s.type === subCat && 
                s.session === session && 
                s.timeRange === timeRange
            );
            if(target) onSelect(target); else alert('æŸ¥ç„¡æ­¤æ™‚æ®µè³‡æ–™');
        };
        const handleConfirmFirst = () => {
             const target = sortedServices.find(s => s.category === mainCat && s.type === subCat);
             if(target) {
                 let finalService = { ...target };
                 if (mainCat === 'éœ§å”‡' && isDarkLip) {
                     finalService.name += ' (å«çƒå”‡æ·¡è‰²)';
                     finalService.price += 1300;
                     finalService.isDarkLip = true; 
                 }
                 onSelect(finalService);
             } else {
                 alert('æŸ¥ç„¡è³‡æ–™');
             }
        };

        const BackBtn = () => (
            <button onClick={()=>{
                if(stage==='confirm') setStage('sub');
                else if(stage==='time') setStage('session');
                else if(stage==='session') setStage('sub');
                else if(stage==='sub') setStage('main');
                else if(stage==='main') onCancel();
            }} className="mb-4 text-base text-[#8d6e63] flex items-center gap-2 font-bold px-4 py-2 rounded-xl hover:bg-white bg-[#f9f8f6] border border-[#e7e0da] shadow-sm">
                <Icon path={Icons.back} size={20}/> {stage==='main' ? 'å–æ¶ˆ' : 'è¿”å›ä¸Šä¸€æ­¥'}
            </button>
        );

        if(stage === 'main') return (
            <div className="space-y-4 animate-fade-in">
                <div className="flex justify-between items-center mb-2">
                    <p className="text-sm text-[#8d6e63] font-bold tracking-wide">è«‹é¸æ“‡æœå‹™é …ç›®ï¼š</p>
                    <button onClick={onCancel} className="text-xs text-gray-400 hover:text-gray-600 p-2">å–æ¶ˆ</button>
                </div>
                <div className="grid gap-3">
                    {MAIN_CATS.map(c => (
                        <button key={c} onClick={()=>handleMain(c)} className="option-btn text-xl font-bold">
                            {c}
                            {/* V37: ç§»é™¤ç®­é ­ï¼ŒåŠ å…¥éš±è—çš„æ‰“å‹¾åœ–ç¤ºä¾›é¸ä¸­ç‹€æ…‹ä½¿ç”¨ (é›–ç„¶é€™é‚Šæ˜¯è·³è½‰ï¼Œä½†ä¿æŒçµæ§‹ä¸€è‡´) */}
                        </button>
                    ))}
                </div>
            </div>
        );
        
        if(stage === 'sub') return (
            <div className="space-y-3 animate-fade-in">
                <BackBtn/>
                <h3 className="font-bold text-xl text-[#4e342e] mb-2 px-1">{mainCat}</h3>
                <p className="text-sm text-[#8d6e63] px-1 mb-2">è«‹é¸æ“‡é¡å‹ï¼š</p>
                {SUB_CATS.map(t => <button key={t} onClick={()=>handleSub(t)} className="option-btn font-bold">{t}</button>)}
            </div>
        );
        
        if(stage === 'confirm') {
            const baseSvc = sortedServices.find(s => s.category === mainCat && s.type === subCat);
            const basePrice = baseSvc ? baseSvc.price : 0;
            return (
                <div className="animate-fade-in">
                    <BackBtn/>
                    <h3 className="font-bold mb-4 text-lg text-[#4e342e] px-1">{mainCat} - {subCat}</h3>
                    {mainCat === 'éœ§å”‡' && subCat === 'é¦–æ¬¡' && (
                        <div className="mb-6 p-4 bg-white border-2 border-[#d7ccc8] rounded-2xl shadow-sm cursor-pointer hover:bg-[#fff8f6] transition-colors" onClick={()=>setIsDarkLip(!isDarkLip)}>
                            <label className="flex items-center gap-4 cursor-pointer pointer-events-none">
                                <div className={`w-6 h-6 rounded-full border flex items-center justify-center transition-all ${isDarkLip?'bg-[#8d6e63] border-[#8d6e63]':'bg-white border-gray-400'}`}>
                                    {isDarkLip && <Icon path={Icons.check} className="text-white" size={16}/>}
                                </div>
                                <div>
                                    <div className="font-bold text-[#5d4037] text-lg">ğŸ‘„ éœ€è¦çƒå”‡/æ·¡è‰²è™•ç†ï¼Ÿ</div>
                                    <div className="text-sm text-gray-500 mt-1">è‹¥å”‡è‰²è¼ƒæ·±æˆ–æš—æ²ˆï¼Œéœ€å…ˆé€²è¡Œæ·¡è‰²è™•ç† (+$1300)</div>
                                </div>
                            </label>
                        </div>
                    )}
                    <div className="mb-6 text-center p-6 bg-[#fff8f6] rounded-2xl border border-[#e7e0da]">
                        <div className="text-sm text-gray-500 mb-1">é ä¼°é‡‘é¡</div>
                        <div className="text-4xl font-bold text-[#8d6e63]">
                            ${isDarkLip ? basePrice + 1300 : basePrice}
                        </div>
                    </div>
                    <button onClick={handleConfirmFirst} className="w-full bg-[#8d6e63] text-white py-4 rounded-xl shadow-lg font-bold text-lg hover:bg-[#795548] active:scale-[0.98] transition-all">ç¢ºèªé¸æ“‡æ­¤é …ç›®</button>
                </div>
            )
        }
        
        if(stage === 'session') return (
            <div className="space-y-3 animate-fade-in">
                <BackBtn/>
                <h3 className="font-bold text-xl text-[#4e342e] px-1">{mainCat} - è£œè‰²</h3>
                <p className="text-sm text-[#8d6e63] px-1 mb-2">æ˜¯ç¬¬å¹¾æ¬¡è£œè‰²å‘¢ï¼Ÿ</p>
                {TOUCHUP_SESSIONS.map(s => <button key={s} onClick={()=>handleSession(s)} className="option-btn font-bold">{s}</button>)}
            </div>
        );
        
        if(stage === 'time') {
            const ranges = sortedServices
                .filter(s => s.category === mainCat && s.type === 'è£œè‰²' && s.session === session)
                .map(s => ({ label: s.timeRange, price: s.price }))
                .filter((v,i,a) => a.findIndex(t => t.label === v.label) === i);
            
            return (
                <div className="space-y-3 animate-fade-in">
                    <BackBtn/>
                    <h3 className="font-bold text-xl text-[#4e342e] px-1">{mainCat} - {session}</h3>
                    <p className="text-sm text-[#8d6e63] px-1 mb-2">è·é›¢ä¸Šæ¬¡æ–½ä½œå¤šä¹…äº†ï¼Ÿ</p>
                    {ranges.length > 0 ? ranges.map(r => (
                        <button key={r.label} onClick={()=>handleTime(r.label)} className="option-btn group">
                            <span className="font-bold text-lg">{r.label}</span>
                            <span className="font-bold text-[#8d6e63] bg-[#efebe9] px-3 py-1 rounded-lg group-hover:bg-[#8d6e63] group-hover:text-white transition-all">${r.price}</span>
                        </button>
                    )) : <div className="text-gray-400 text-center py-8 bg-gray-50 rounded-xl border-2 border-dashed">å°šç„¡æ­¤æ™‚æ®µçš„å ±åƒ¹è³‡æ–™</div>}
                </div>
            );
        }
    };

    const StatusCheck = ({ user, onBack }) => {
        const [phone, setPhone] = useState('');
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);
        const [reportId, setReportId] = useState(null);
        const [last5, setLast5] = useState('');

        const search = async () => {
            if(!phone) return alert("è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼");
            setLoading(true);
            try {
                const snap = await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
                    .where('customerPhone', '==', phone).get();
                if (snap.empty) {
                    alert("æŸ¥ç„¡æ­¤é›»è©±çš„é ç´„è³‡æ–™"); setResults([]);
                } else {
                    const data = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    data.sort((a,b) => new Date(b.date) - new Date(a.date));
                    setResults(data);
                }
            } catch(e) { alert("æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤: " + e.message); }
            setLoading(false);
        };

        const submitPayment = async () => {
            if(!last5) return alert('è«‹è¼¸å…¥å¾Œäº”ç¢¼');
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(reportId).update({
                paymentStatus: 'reported', paymentInfo: { last5, at: new Date().toISOString() }
            });
            alert('å›å ±æˆåŠŸï¼ç­‰å¾…åº—å®¶ç¢ºèªã€‚'); setReportId(null); search();
        };

        return (
            <div className="min-h-screen bg-[#f4f1ea] p-4">
                <div className="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <h2 className="font-bold text-lg mb-4 text-[#4e342e]">é ç´„æŸ¥è©¢ / åŒ¯æ¬¾å›å ±</h2>
                    <div className="flex gap-2">
                        <input className="flex-1 p-2 border rounded-lg" placeholder="è«‹è¼¸å…¥é ç´„é›»è©±" value={phone} onChange={e=>setPhone(e.target.value)} />
                        <button onClick={search} className="bg-[#8d6e63] text-white px-4 rounded-lg">{loading?'...':'æŸ¥è©¢'}</button>
                    </div>
                </div>
                <div className="space-y-3">
                    {results.map(r => (
                        <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex justify-between mb-2">
                                <span className="font-bold text-[#8d6e63]">{r.date} {r.time}</span>
                                <span className={`text-xs px-2 py-1 rounded ${r.status==='confirmed'?'bg-green-100 text-green-700':r.status==='cancelled'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{r.status==='confirmed'?'âœ… æˆåŠŸ':r.status==='cancelled'?'âŒ å–æ¶ˆ':'â³ å¾…ç¢ºèª'}</span>
                            </div>
                            <div className="text-sm text-gray-600 mb-2">{r.serviceName} {r.guestIndex && `(ç¬¬${r.guestIndex}ä½)`}</div>
                            <div className="text-sm font-bold text-[#5d4037] mb-2">
                                è¨‚é‡‘ï¼š${BANK_INFO.amountPerPerson}
                            </div>
                            <div className="border-t pt-2 flex justify-between items-center mt-2">
                                <span className="text-xs text-gray-500">ç‹€æ…‹ï¼š{r.paymentStatus==='verified' ? <span className="text-green-600 font-bold">å·²å…¥å¸³</span> : r.paymentStatus==='reported' ? <span className="text-blue-600 font-bold">å¯©æ ¸ä¸­</span> : <span className="text-red-500">æœªæ”¯ä»˜</span>}</span>
                                {r.paymentStatus === 'unpaid' && r.status !== 'cancelled' && (<button onClick={()=>setReportId(r.id)} className="text-xs bg-[#8d6e63] text-white px-3 py-1 rounded">å›å ±</button>)}
                            </div>
                            {reportId === r.id && (
                                <div className="mt-3 bg-gray-50 p-3 rounded flex gap-2">
                                    <input className="flex-1 p-1 border rounded text-sm" placeholder="å¸³è™Ÿå¾Œäº”ç¢¼" value={last5} onChange={e=>setLast5(e.target.value)} />
                                    <button onClick={submitPayment} className="bg-blue-600 text-white px-3 text-xs rounded">é€å‡º</button>
                                    <button onClick={()=>setReportId(null)} className="text-gray-400 text-xs">å–æ¶ˆ</button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                <button onClick={onBack} className="mt-6 w-full py-3 text-gray-400 text-sm">è¿”å›é¦–é </button>
            </div>
        )
    };

    // --- Admin Login ---
    const AdminLogin = ({ onBack, onLogin }) => {
        const [pin, setPin] = useState('');
        return <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea] p-6"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center"><h2 className="text-xl font-bold mb-6 text-[#4e342e]">å¾Œå°ç™»å…¥</h2><input type="password" placeholder="PIN" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center text-xl tracking-widest border focus:border-[#8d6e63] outline-none" value={pin} onChange={e=>setPin(e.target.value)} /><div className="grid grid-cols-2 gap-3"><button onClick={onBack} className="py-3 rounded-xl bg-gray-100 text-gray-500">å–æ¶ˆ</button><button onClick={()=>pin===ADMIN_PIN?onLogin():alert('å¯†ç¢¼éŒ¯èª¤')} className="py-3 rounded-xl bg-[#8d6e63] text-white font-bold">ç™»å…¥</button></div></div></div>;
    }

    const AdminPanel = ({ user, settings, onBack, services, addons, discounts }) => {
        const [tab, setTab] = useState('cal'); 
        const [filterStatus, setFilterStatus] = useState('all');
        const [books, setBooks] = useState([]);
        const [editDates, setEditDates] = useState({kaohsiung:'', tainan:''});
        const [editSlots, setEditSlots] = useState({kaohsiung:'', tainan:''});
        const [selectedDay, setSelectedDay] = useState(null);
        const [daySlots, setDaySlots] = useState('');
        const [msgModal, setMsgModal] = useState(null); 
        const [templates, setTemplates] = useState(DEFAULT_TEMPLATES);
        const [editMode, setEditMode] = useState(false); 
        // Admin Calendar State
        const [calDate, setCalDate] = useState(new Date());
        const [calSelected, setCalSelected] = useState(null);
        
        const bookingRefs = useRef({});

        const [newSvc, setNewSvc] = useState({ cat: MAIN_CATS[0], type: SUB_CATS[0], session: TOUCHUP_SESSIONS[0], timeRange: '', price: '', duration: '90' });
        const [newDiscName, setNewDiscName] = useState('');
        const [newDiscAmount, setNewDiscAmount] = useState('200');

        useEffect(() => {
            if(settings.kaohsiung) {
                setEditDates(p => ({...p, kaohsiung: settings.kaohsiung.allowedDates?.join(',') || ''}));
                setEditSlots(p => ({...p, kaohsiung: settings.kaohsiung.timeSlots?.join(',') || ''}));
            }
            if(settings.tainan) {
                setEditDates(p => ({...p, tainan: settings.tainan.allowedDates?.join(',') || ''}));
                setEditSlots(p => ({...p, tainan: settings.tainan.timeSlots?.join(',') || ''}));
            }
            if(settings.templates) setTemplates(settings.templates);
        }, [settings]);

        useEffect(() => {
            db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
              .orderBy('date', 'desc').limit(100).onSnapshot(s => setBooks(s.docs.map(d=>({id:d.id, ...d.data()}))));
        }, []);

        // Calendar view for Admin
        const renderAdminOverview = () => {
            const y = calDate.getFullYear();
            const m = calDate.getMonth();
            const days = new Date(y, m+1, 0).getDate();
            const start = new Date(y, m, 1).getDay();
            
            const bookMap = {};
            books.forEach(b => {
                if(b.status !== 'cancelled') {
                    if(!bookMap[b.date]) bookMap[b.date] = {count:0, hasPending:false};
                    bookMap[b.date].count++;
                    if(b.status === 'pending' || b.paymentStatus === 'reported') bookMap[b.date].hasPending = true;
                }
            });

            return (
                <div className="space-y-4">
                    <div className="bg-white p-4 rounded-xl border shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                             <button onClick={()=>setCalDate(new Date(y, m-1))} className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">&lt;</button>
                             <span className="font-bold text-lg text-[#4e342e]">{y}å¹´ {m+1}æœˆ</span>
                             <button onClick={()=>setCalDate(new Date(y, m+1))} className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">&gt;</button>
                        </div>
                        <div className="grid grid-cols-7 gap-2 text-center text-xs mb-2">
                             {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="text-gray-400">{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {Array.from({length:start}).map((_,i)=><div key={'e'+i}/>)}
                            {Array.from({length:days}).map((_,i)=>{
                                const d = i+1;
                                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                const info = bookMap[dStr];
                                const isSel = calSelected === dStr;
                                return (
                                    <div key={d} onClick={()=>setCalSelected(dStr)} className={`aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer border transition-all ${isSel ? 'border-[#8d6e63] bg-[#efebe9] shadow-inner' : 'border-gray-100 hover:bg-gray-50'}`}>
                                        <span className={`font-bold ${isSel?'text-[#8d6e63]':'text-gray-700'}`}>{d}</span>
                                        {info && (
                                            <div className="flex gap-0.5 mt-1">
                                                <span className={`dot ${info.hasPending ? 'yellow' : 'green'}`}></span>
                                                {info.count > 1 && <span className="text-[8px] text-gray-400">+{info.count-1}</span>}
                                            </div>
                                        )}
                                        {info && info.count === 1 && <div className="text-[8px] text-gray-400 truncate w-full text-center px-1">é ç´„</div>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    
                    {/* Daily List */}
                    {calSelected && (
                        <div className="bg-white p-4 rounded-xl shadow-sm border animate-fade-in">
                            <h3 className="font-bold mb-3 text-[#4e342e] flex items-center gap-2">
                                <Icon path={Icons.calendar} size={18}/> {calSelected} é ç´„æ¸…å–®
                            </h3>
                            <div className="space-y-3">
                                {books.filter(b => b.date === calSelected).length === 0 ? (
                                    <p className="text-gray-400 text-sm text-center py-4">ç•¶æ—¥ç„¡é ç´„</p>
                                ) : (
                                    books.filter(b => b.date === calSelected).map(b => (
                                        <div key={b.id} 
                                            onClick={()=>{ setTab('book'); setTimeout(() => {
                                                const el = document.getElementById(`book-${b.id}`);
                                                if(el) {
                                                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                    el.classList.add('highlight-row');
                                                    setTimeout(() => el.classList.remove('highlight-row'), 2000);
                                                }
                                            }, 100); }}
                                            className={`border p-3 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-50 ${b.status==='cancelled'?'opacity-50 bg-gray-50':''}`}>
                                            <div>
                                                <div className="font-bold text-[#5d4037]">{b.time} - {b.customerName}</div>
                                                <div className="text-xs text-gray-500">{b.serviceName} ({b.locationName})</div>
                                            </div>
                                            <div className={`text-xs px-2 py-1 rounded ${b.status==='confirmed'?'bg-green-100 text-green-700':b.status==='cancelled'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>
                                                {b.status==='confirmed'?'å·²ç¢ºèª':b.status==='cancelled'?'å–æ¶ˆ':'å¾…ç¢ºèª'}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}
                </div>
            )
        };

        const moveService = async (index, direction) => {
             const sorted = [...services].sort((a, b) => (a.order || 999) - (b.order || 999));
             if (direction === 'up' && index > 0) {
                 const temp = sorted[index].order || index;
                 sorted[index].order = sorted[index-1].order || (index-1);
                 sorted[index-1].order = temp;
                 await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(sorted[index].id).update({order: sorted[index].order});
                 await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(sorted[index-1].id).update({order: sorted[index-1].order});
             } else if (direction === 'down' && index < sorted.length - 1) {
                 const temp = sorted[index].order || index;
                 sorted[index].order = sorted[index+1].order || (index+1);
                 sorted[index+1].order = temp;
                 await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(sorted[index].id).update({order: sorted[index].order});
                 await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(sorted[index+1].id).update({order: sorted[index+1].order});
             }
        };

        const handleDateClick = (locId, dStr) => {
             if (editMode) {
                 setSelectedDay({ locId, date: dStr });
                 const special = settings[locId]?.specialRules?.[dStr];
                 setDaySlots(special ? special.join(',') : '');
             } else {
                 const current = editDates[locId].split(',').filter(x=>x);
                 const set = new Set(current);
                 if(set.has(dStr)) set.delete(dStr); else set.add(dStr);
                 setEditDates({...editDates, [locId]: Array.from(set).sort().join(',')});
             }
        };
 
        const saveSettings = async (locId) => {
             const data = {
                 allowedDates: editDates[locId].split(',').filter(x=>x),
                 timeSlots: editSlots[locId].split(',').filter(x=>x),
                 specialRules: settings[locId]?.specialRules || {}
             };
             await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(locId).set(data);
             alert('è¨­å®šå·²å„²å­˜');
        };
 
        const saveDayRule = async () => {
             if(!selectedDay) return;
             const { locId, date } = selectedDay;
             const currentRules = settings[locId]?.specialRules || {};
             if (!daySlots.trim()) delete currentRules[date]; else currentRules[date] = daySlots.split(',').map(x=>x.trim()).filter(x=>x);
             await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(locId).update({ specialRules: currentRules });
             alert(`${date} çš„ç‰¹æ®Šæ™‚æ®µå·²å„²å­˜ï¼`); setSelectedDay(null);
        };
 
        const copyDefaultSlots = (locId) => {
             setDaySlots(editSlots[locId]);
        }
 
        const saveTemplates = async () => {
             await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('templates').set({ templates });
             alert('è¨Šæ¯ç¯„æœ¬å·²å„²å­˜');
        };
 
        const sendTemplateMsg = async (tpl) => {
             if(!msgModal) return;
             const b = msgModal;
             let text = tpl.text.replace('{{date}}', b.date).replace('{{time}}', b.time).replace('{{location}}', b.locationName).replace('{{service}}', b.serviceName);
             if (window.liff?.isInClient()) { await window.liff.sendMessages([{type:'text', text}]); alert('è¨Šæ¯å·²å‚³é€'); } 
             else { navigator.clipboard.writeText(text); alert('å·²è¤‡è£½è¨Šæ¯ï¼Œè«‹è²¼ä¸Šçµ¦é¡§å®¢'); }
             setMsgModal(null);
        };
 
        const submitSvcV26 = async () => {
             if(!newSvc.price) return;
             
             let fullName = `${newSvc.cat} - ${newSvc.type}`;
             if(newSvc.type === 'è£œè‰²') fullName += ` (${newSvc.session} - ${newSvc.timeRange})`;
             
             const maxOrder = services.reduce((max, s) => Math.max(max, s.order || 0), 0);
 
             await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({
                 name: fullName,
                 category: newSvc.cat,
                 type: newSvc.type,
                 session: newSvc.type === 'è£œè‰²' ? newSvc.session : null,
                 timeRange: newSvc.type === 'è£œè‰²' ? newSvc.timeRange : null,
                 price: Number(newSvc.price),
                 duration: Number(newSvc.duration),
                 order: maxOrder + 1
             });
             alert('æœå‹™å·²æ–°å¢');
        };
 
        const initV26Data = async () => {
             if(!confirm('é€™å°‡æœƒå»ºç«‹åœ–ç‰‡ä¸­çš„åƒ¹ç›®è¡¨è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
             const batch = db.batch();
             const sCol = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services');
             const samples = [
                 { category: 'éœ§çœ‰', type: 'é¦–æ¬¡', price: 4800, duration: 120 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: 'é¦–æ¬¡åŠå¹´è£œè‰²', price: 1000, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: '6-8å€‹æœˆè£œè‰²', price: 1700, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: '8-12å€‹æœˆè£œè‰²', price: 2700, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: 'ä¸€å¹´ä»¥ä¸Šè£œè‰²', price: 3300, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: '4å€‹æœˆå…§è£œè‰²', price: 900, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: '4-8å€‹æœˆè£œè‰²', price: 1500, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: '8-12å€‹æœˆè£œè‰²', price: 2500, duration: 90 },
                 { category: 'éœ§çœ‰', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: 'ä¸€å¹´ä»¥ä¸Šè£œè‰²', price: 3000, duration: 90 },
                 { category: 'éœ§å”‡', type: 'é¦–æ¬¡', price: 5200, duration: 150 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: '3å€‹æœˆå…§è£œè‰²', price: 0, duration: 120 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: '4-6å€‹æœˆè£œè‰²', price: 1000, duration: 120 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: '6-12å€‹æœˆè£œè‰²', price: 2500, duration: 120 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬ä¸€æ¬¡å›è£œ', timeRange: 'ä¸€å¹´ä»¥ä¸Šè£œè‰²', price: 4000, duration: 120 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: 'åŠå¹´å…§è£œè‰²', price: 1200, duration: 120 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: 'ä¸€å¹´å…§è£œè‰²', price: 2000, duration: 120 },
                 { category: 'éœ§å”‡', type: 'è£œè‰²', session: 'ç¬¬äºŒæ¬¡ä»¥ä¸Š', timeRange: 'ä¸€å¹´ä»¥ä¸Šè£œè‰²', price: 3500, duration: 120 },
             ];
             samples.forEach((s, i) => {
                 const ref = sCol.doc();
                 let fname = `${s.category} - ${s.type}`;
                 if(s.type==='è£œè‰²') fname += ` (${s.session} - ${s.timeRange})`;
                 batch.set(ref, { ...s, name: fname, order: i });
             });
             const dCol = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('discounts');
             const dSamples = [{ name: 'é†«è­·äººå“¡', amount: 200 }, { name: 'å­¸ç”Ÿ', amount: 200 }, { name: 'è»å…¬æ•™', amount: 200 }, { name: 'èˆŠå®¢æ¨è–¦', amount: 200 }, { name: 'ç•¶æœˆå£½æ˜Ÿ', amount: 200 }];
             dSamples.forEach(d => { const ref = dCol.doc(); batch.set(ref, d); });
             await batch.commit();
             alert('åƒ¹ç›®è¡¨ç¯„æœ¬å·²åŒ¯å…¥ï¼');
        };
         
        const addDiscount = async () => {
             if(!newDiscName) return;
             await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('discounts').add({ name: newDiscName, amount: Number(newDiscAmount) });
             setNewDiscName('');
        };

        const filteredBooks = books.filter(b => {
             if (filterStatus === 'all') return true;
             if (filterStatus === 'pending') return b.status === 'pending';
             if (filterStatus === 'verifying') return b.paymentStatus === 'reported';
             if (filterStatus === 'paid') return b.paymentStatus === 'verified';
             if (filterStatus === 'cancelled') return b.status === 'cancelled';
             return true;
        });
 
        const sortedServices = [...services].sort((a, b) => (a.order || 999) - (b.order || 999));

        return (
            <div className="min-h-screen bg-gray-50 p-4">
                <div className="bg-white p-4 sticky top-0 border-b flex justify-between items-center shadow-sm mb-4 z-20">
                    <h2 className="font-bold">å¾Œå°ç®¡ç† (V35)</h2>
                    <button onClick={onBack} className="text-sm bg-gray-100 px-3 py-1 rounded">é›¢é–‹</button>
                </div>
                
                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onClick={()=>setTab('cal')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='cal'?'bg-[#8d6e63] text-white':'bg-white'}`}>æœˆæ›†</button>
                    <button onClick={()=>setTab('book')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='book'?'bg-[#8d6e63] text-white':'bg-white'}`}>é ç´„</button>
                    <button onClick={()=>setTab('svc')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='svc'?'bg-[#8d6e63] text-white':'bg-white'}`}>æœå‹™</button>
                    <button onClick={()=>setTab('set')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='set'?'bg-[#8d6e63] text-white':'bg-white'}`}>ç‡Ÿæ¥­</button>
                    <button onClick={()=>setTab('disc')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='disc'?'bg-[#8d6e63] text-white':'bg-white'}`}>æŠ˜æ‰£</button>
                    <button onClick={()=>setTab('msg')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='msg'?'bg-[#8d6e63] text-white':'bg-white'}`}>è¨Šæ¯</button>
                </div>

                {tab === 'cal' && renderAdminOverview()}

                {tab === 'book' && (
                    <div>
                         <div className="flex gap-2 mb-4 overflow-x-auto">
                            {[
                                {id:'all', label:'å…¨éƒ¨'},
                                {id:'pending', label:'å¾…ç¢ºèª'},
                                {id:'verifying', label:'å¾…æ ¸å¸³'},
                                {id:'paid', label:'å·²ç¢ºèª'},
                                {id:'cancelled', label:'å·²å–æ¶ˆ'}
                            ].map(f => (
                                <button key={f.id} onClick={()=>setFilterStatus(f.id)} 
                                    className={`status-tab ${filterStatus===f.id ? 'active' : 'inactive'}`}>
                                    {f.label}
                                </button>
                            ))}
                         </div>
                        <div className="space-y-4">
                            {filteredBooks.map(b => (
                                <div id={`book-${b.id}`} key={b.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-sm transition-colors">
                                    <div className="flex justify-between mb-2">
                                        <div className="font-bold text-lg text-[#8d6e63]">{b.date} {b.time}</div>
                                        <div className={`px-2 py-1 rounded text-xs ${b.status==='confirmed'?'bg-green-100 text-green-700':b.status==='cancelled'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{b.status==='confirmed'?'å·²ç¢ºèª':b.status==='cancelled'?'å·²å–æ¶ˆ':'å¾…ç¢ºèª'}</div>
                                    </div>
                                    <div className="space-y-1 text-gray-600">
                                        <div>{b.locationName}ãƒ»{b.serviceName} {b.guestIndex && `(ç¬¬${b.guestIndex}ä½)`}</div>
                                        <div>{b.customerName} ({b.customerPhone})</div>
                                        <div className="text-[#8d6e63] font-bold">ç¸½é¡ï¼š${b.totalPrice}</div>
                                        {b.paymentStatus === 'reported' && <div className="text-blue-600 font-bold bg-blue-50 p-2 rounded">ğŸ’° é¡§å®¢å·²åŒ¯æ¬¾ï¼šå¾Œäº”ç¢¼ {b.paymentInfo?.last5}</div>}
                                        {b.paymentStatus === 'verified' && <div className="text-green-600 font-bold">ğŸ’° è¨‚é‡‘å·²ç¢ºèª</div>}
                                    </div>
                                    <div className="flex gap-2 mt-3 pt-3 border-t">
                                        <button onClick={()=>setMsgModal(b)} className="flex-1 bg-gray-100 py-2 rounded flex items-center justify-center gap-1"><Icon path={Icons.msg} size={16}/> å‚³è¨Š</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({status: 'confirmed'})} className="flex-1 bg-green-50 text-green-700 border border-green-200 py-2 rounded">ç¢ºèª</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({paymentStatus: 'verified'})} className="flex-1 bg-blue-50 text-blue-700 border border-blue-200 py-2 rounded">æ”¶è¨‚</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({status: 'cancelled'})} className="px-3 text-red-400 border border-red-200 rounded">âŒ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {tab === 'svc' && (
                    <div className="space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-[#4e342e]">æ–°å¢æœå‹™ (å±¤ç´š)</h3>
                                <button onClick={initV26Data} className="text-xs text-blue-500 underline">âš¡ åŒ¯å…¥åœ–ç‰‡åƒ¹ç›®è¡¨</button>
                            </div>
                            <div className="space-y-3 text-sm">
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">å¤§åˆ†é¡</label>
                                    <select className="w-full border p-2 rounded" value={newSvc.cat} onChange={e=>setNewSvc({...newSvc, cat:e.target.value})}>
                                        {MAIN_CATS.map(c=><option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">é¡å‹</label>
                                    <select className="w-full border p-2 rounded" value={newSvc.type} onChange={e=>setNewSvc({...newSvc, type:e.target.value})}>
                                        {SUB_CATS.map(c=><option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                {newSvc.type === 'è£œè‰²' && (
                                    <div className="space-y-3 p-3 bg-gray-50 rounded border">
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">å›è£œæ¬¡æ•¸</label>
                                            <select className="w-full border p-2 rounded" value={newSvc.session} onChange={e=>setNewSvc({...newSvc, session:e.target.value})}>
                                                {TOUCHUP_SESSIONS.map(c=><option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">æ™‚é–“å€é–“ (ä¾‹å¦‚: 6-8å€‹æœˆå…§)</label>
                                            <input className="w-full border p-2 rounded" placeholder="æ‰‹å‹•è¼¸å…¥å€é–“åç¨±" value={newSvc.timeRange} onChange={e=>setNewSvc({...newSvc, timeRange:e.target.value})}/>
                                        </div>
                                    </div>
                                )}
                                <div className="flex gap-2">
                                    <div className="flex-1">
                                        <label className="block text-xs text-gray-500 mb-1">åƒ¹æ ¼</label>
                                        <input type="number" className="w-full border p-2 rounded" placeholder="$" value={newSvc.price} onChange={e=>setNewSvc({...newSvc, price:e.target.value})}/>
                                    </div>
                                    <div className="w-24">
                                        <label className="block text-xs text-gray-500 mb-1">åˆ†é˜</label>
                                        <input type="number" className="w-full border p-2 rounded" placeholder="min" value={newSvc.duration} onChange={e=>setNewSvc({...newSvc, duration:e.target.value})}/>
                                    </div>
                                </div>
                                <button onClick={submitSvcV26} className="w-full bg-[#8d6e63] text-white py-2 rounded">æ–°å¢æœå‹™</button>
                            </div>

                            <div className="mt-6 border-t pt-4">
                                <h4 className="font-bold text-sm text-gray-500 mb-2">ç¾æœ‰æœå‹™åˆ—è¡¨</h4>
                                <div className="space-y-2">
                                    {sortedServices.map((s, idx)=>(
                                        <div key={s.id} className="flex justify-between items-center p-2 border rounded bg-gray-50 text-sm">
                                            <span>{s.name} (${s.price})</span>
                                            <div className="flex gap-2">
                                                <button onClick={()=>moveService(idx, 'up')} className="text-gray-400 hover:text-gray-600 disabled:opacity-20" disabled={idx===0}><Icon path={Icons.up} size={16}/></button>
                                                <button onClick={()=>moveService(idx, 'down')} className="text-gray-400 hover:text-gray-600 disabled:opacity-20" disabled={idx===sortedServices.length-1}><Icon path={Icons.down} size={16}/></button>
                                                <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-400 ml-2"><Icon path={Icons.trash} size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {tab === 'disc' && (
                    <div className="space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 className="font-bold text-[#4e342e] mb-4">å„ªæƒ èº«ä»½ç®¡ç†</h3>
                            <div className="flex gap-2 mb-4">
                                <input className="flex-1 border p-2 rounded" placeholder="èº«ä»½åç¨± (å¦‚: å­¸ç”Ÿ)" value={newDiscName} onChange={e=>setNewDiscName(e.target.value)}/>
                                <input className="w-24 border p-2 rounded" type="number" placeholder="æŠ˜æŠµé¡" value={newDiscAmount} onChange={e=>setNewDiscAmount(e.target.value)}/>
                                <button onClick={addDiscount} className="bg-[#8d6e63] text-white px-4 rounded">æ–°å¢</button>
                            </div>
                            <div className="space-y-2">
                                {discounts.map(d => (
                                    <div key={d.id} className="flex justify-between p-3 border rounded bg-gray-50">
                                        <span>{d.name} (æŠ˜æŠµ ${d.amount})</span>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('discounts').doc(d.id).delete()} className="text-red-400"><Icon path={Icons.trash}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {tab === 'msg' && (
                        <div className="space-y-4">
                            <h3 className="font-bold text-[#4e342e]">å¸¸ç”¨å›è¦†è¨­å®š</h3>
                            {templates.map((tpl, i) => (
                                <div key={i} className="bg-white p-3 rounded-lg border">
                                    <input className="font-bold w-full mb-2 p-1 border-b" value={tpl.title} onChange={e=>{ const newT = [...templates]; newT[i].title = e.target.value; setTemplates(newT); }} />
                                    <textarea className="w-full text-sm p-2 bg-gray-50 rounded h-24" value={tpl.text} onChange={e=>{ const newT = [...templates]; newT[i].text = e.target.value; setTemplates(newT); }} />
                                </div>
                            ))}
                            <button onClick={saveTemplates} className="w-full bg-[#8d6e63] text-white py-3 rounded-xl shadow">å„²å­˜æ‰€æœ‰è¨Šæ¯è¨­å®š</button>
                        </div>
                )}

                {tab === 'set' && (
                        <div className="space-y-6">
                            <div className="flex items-center gap-2 mb-4 bg-yellow-50 p-2 rounded text-sm text-yellow-800">
                                <button onClick={()=>setEditMode(!editMode)} className={`w-10 h-6 rounded-full flex items-center p-1 transition-colors ${editMode?'bg-yellow-500 justify-end':'bg-gray-300'}`}>
                                    <div className="w-4 h-4 bg-white rounded-full"></div>
                                </button>
                                <span>{editMode ? 'âœï¸ æ¨¡å¼ï¼šè¨­å®šå–®æ—¥ç‰¹æ®Šæ™‚æ®µ (é»æ“Šæ—¥æœŸç·¨è¼¯)' : 'ğŸ‘† æ¨¡å¼ï¼šå¿«é€Ÿé–‹é—œæ—¥æœŸ (é»æ“Šåˆ‡æ›)'}</span>
                            </div>

                            {['kaohsiung','tainan'].map(locId => (
                                <div key={locId} className="border p-4 rounded-xl bg-white">
                                    <h3 className="font-bold mb-2 capitalize">{locId} è¨­å®š</h3>
                                    {renderSettingsCalendar(locId)}
                                    <div className="mt-2 text-xs text-gray-400 text-center">
                                        {editMode ? 'é»æ“Šæ—¥æœŸå¯è¨­å®šç•¶å¤©å°ˆå±¬ç‡Ÿæ¥­æ™‚é–“' : 'é»æ“Šæ—¥æœŸå¯å¿«é€Ÿ é–‹æ”¾ / é—œé–‰ é ç´„'}
                                    </div>
                                    {!editMode && (
                                        <div className="mt-4">
                                            <label className="text-xs font-bold block mb-1">é è¨­æ™‚æ®µ (å…¨åŸŸ)</label>
                                            <input className="w-full border p-2 rounded text-sm" value={editSlots[locId]} onChange={e=>setEditSlots({...editSlots, [locId]:e.target.value})} />
                                            <button onClick={()=>saveSettings(locId)} className="mt-2 w-full bg-[#8d6e63] text-white py-2 rounded text-sm">å„²å­˜åŸºæœ¬è¨­å®š</button>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {selectedDay && (
                                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                    <div className="bg-white w-full max-w-sm rounded-xl p-6">
                                        <h3 className="font-bold mb-4 text-lg border-b pb-2">{selectedDay.date} ç‰¹æ®Šè¨­å®š</h3>
                                        <p className="text-sm text-gray-500 mb-2">åœ¨æ­¤è¼¸å…¥è©²æ—¥çš„ç‰¹æ®Šç‡Ÿæ¥­æ™‚é–“ï¼Œç•™ç©ºå‰‡ä¾é è¨­è¦å‰‡æˆ–é—œé–‰ã€‚</p>
                                        
                                        <div className="flex gap-2 mb-2">
                                            <button onClick={()=>copyDefaultSlots(selectedDay.locId)} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200 flex items-center gap-1">
                                                <Icon path={Icons.zap} size={12}/> å¸¶å…¥é è¨­æ™‚æ®µ
                                            </button>
                                        </div>

                                        <input className="w-full border p-3 rounded mb-4" placeholder="ä¾‹å¦‚: 10:00, 14:00" value={daySlots} onChange={e=>setDaySlots(e.target.value)} />
                                        <div className="flex gap-2">
                                            <button onClick={()=>setSelectedDay(null)} className="flex-1 py-2 bg-gray-100 rounded">å–æ¶ˆ</button>
                                            <button onClick={saveDayRule} className="flex-1 py-2 bg-[#8d6e63] text-white rounded">å„²å­˜å–®æ—¥</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                {msgModal && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white w-full max-w-sm rounded-xl p-4">
                            <h3 className="font-bold mb-4">é¸æ“‡å‚³é€è¨Šæ¯</h3>
                            <div className="space-y-2">{templates.map((t,i) => (<button key={i} onClick={()=>sendTemplateMsg(t)} className="w-full text-left p-3 border rounded hover:bg-gray-50"><div className="font-bold text-[#5d4037]">{t.title}</div><div className="text-xs text-gray-400 truncate">{t.text}</div></button>))}</div>
                            <button onClick={()=>setMsgModal(null)} className="mt-4 w-full py-2 text-gray-400">å–æ¶ˆ</button>
                        </div>
                    </div>
                )}

            </div>
        );
    };

    // --- Main App (V37) ---
    function App() {
      const [user, setUser] = useState(null);
      const [page, setPage] = useState('home'); 
      const [step, setStep] = useState(1);
      const [loc, setLoc] = useState(null);
      const [guests, setGuests] = useState([{ id: 1, services: [], addons: [], time: null, customTime: '', name: '', phone: '', discount: null }]);
      const [date, setDate] = useState(new Date());
      const [info, setInfo] = useState({notes:''});
      const [isTwoPeople, setIsTwoPeople] = useState(false);
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [discounts, setDiscounts] = useState([]);
      const [settings, setSettings] = useState({});
      const [booked, setBooked] = useState([]);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('p') === 'check') setPage('check-status');
        auth.signInAnonymously().catch(e => console.warn(e));
        if (window.liff) window.liff.init({ liffId: LIFF_ID });
        return auth.onAuthStateChanged(setUser);
      }, []);

      useEffect(() => {
        if (!user) return;
        const pub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        pub.collection('services').onSnapshot(s => setServices(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('addons').onSnapshot(s => setAddons(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('discounts').onSnapshot(s => setDiscounts(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('settings').onSnapshot(s => { 
            const obj = {}; s.forEach(d => obj[d.id] = d.data()); setSettings(obj); 
        });
      }, [user]);

      useEffect(() => {
        if (!loc || !date) return;
        const dStr = date.toISOString().split('T')[0];
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', loc.id).where('date', '==', dStr)
          .onSnapshot(s => setBooked(s.docs.map(d => d.data().time)));
      }, [loc, date]);

      const isDateOpen = (d) => {
          if (!loc) return true;
          const conf = settings[loc.id];
          if (!conf?.allowedDates?.length) return true;
          return conf.allowedDates.includes(d.toISOString().split('T')[0]);
      };
      
      const getSlots = (d) => {
          if (!loc) return DEFAULT_SLOTS;
          const dStr = d.toISOString().split('T')[0];
          const conf = settings[loc.id];
          if (conf?.specialRules && conf.specialRules[dStr]) return conf.specialRules[dStr];
          return conf?.timeSlots?.length ? conf.timeSlots : DEFAULT_SLOTS;
      };

      // Actions
      const addGuest = () => setGuests([...guests, { id: Date.now(), services: [], addons: [], time: null, customTime: '', name: '', phone: '', discount: null }]);
      const removeGuest = (idx) => { const g = [...guests]; g.splice(idx, 1); setGuests(g); };
      const updateGuest = (idx, field, val) => { const g = [...guests]; g[idx][field] = val; setGuests(g); };
      
      const addServiceToGuest = (idx, s) => {
          const g = [...guests];
          if (s.type === 'è£œè‰²') g[idx].services = [s]; 
          else {
             if (g[idx].services.length > 0 && g[idx].services[0].type === 'è£œè‰²') g[idx].services = [];
             if(!g[idx].services.find(item=>item.id===s.id)) g[idx].services.push(s);
          }
          setGuests(g);
      };
      const removeServiceFromGuest = (idx, sId) => {
          const g = [...guests];
          g[idx].services = g[idx].services.filter(s => s.id !== sId);
          setGuests(g);
      };
      const toggleGuestAddon = (idx, ad) => {
          const g = [...guests];
          const has = g[idx].addons.find(a=>a.id===ad.id);
          g[idx].addons = has ? g[idx].addons.filter(a=>a.id!==ad.id) : [...g[idx].addons, ad];
          setGuests(g);
      };
      
      const [showSelector, setShowSelector] = useState(null); 

      const calculateTotal = () => {
          let total = 0;
          guests.forEach(g => {
              g.services.forEach(s => total += s.price);
              const isTouchUp = g.services.some(s => s.type === 'è£œè‰²');
              if (g.discount) {
                  if (isTouchUp) {
                      if (g.discount.name.includes('å£½æ˜Ÿ')) total -= 100;
                  } else {
                      total -= g.discount.amount;
                  }
              }
          });
          if (guests.length >= 2) {
             guests.forEach(g => {
                 const isTouchUp = g.services.some(s => s.type === 'è£œè‰²');
                 if (!isTouchUp) total -= 200;
             });
          }
          return total;
      };

      const handleSubmit = async () => {
          if (!user) return alert('é€£ç·šä¸­...');
          const batch = db.batch();
          const dStr = date.toISOString().split('T')[0];
          const groupId = Date.now().toString(); 
          const totalP = calculateTotal();

          try {
              guests.forEach((g, idx) => {
                  const tVal = g.time === 'å¾®èª¿æ™‚æ®µç”³è«‹' ? `å¾®èª¿ ${g.customTime}` : g.time;
                  const svcNames = g.services.map(s=>s.name).join('+');
                  const discountName = g.discount ? g.discount.name : '';
                  const orderRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc();
                  const orderData = {
                      locationId: loc.id, locationName: loc.name,
                      serviceId: g.services.map(s=>s.id), serviceName: svcNames,
                      addons: [], 
                      date: dStr, time: tVal,
                      customerName: g.name, customerPhone: g.phone,
                      notes: info.notes,
                      discountIdentity: discountName, 
                      groupId, guestIndex: idx + 1,
                      totalPrice: totalP, 
                      status: 'pending', paymentStatus: 'unpaid', msgSent: false,
                      createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
                  };
                  batch.set(orderRef, orderData);
              });

              await batch.commit();
              
              const deposit = guests.length * BANK_INFO.amountPerPerson;
              const reportLink = `https://liff.line.me/${LIFF_ID}?p=check`;
              const msg = `ã€é ç´„ç”³è«‹é€šçŸ¥ã€‘\nğŸ“ ${loc.name}\nğŸ“… ${dStr}\nğŸ‘¤ äººæ•¸ï¼š${guests.length}ä½\nğŸ’° ç¸½é‡‘é¡ï¼š$${totalP}\nâš ï¸ è¨‚é‡‘ï¼š$${deposit} (æ¯äºº$${BANK_INFO.amountPerPerson})\n\nğŸ”— å›å ±åŒ¯æ¬¾ï¼š\n${reportLink}`;
              
              if (window.liff?.isInClient()) {
                  try { await window.liff.sendMessages([{ type: 'text', text: msg }]); } catch (err) {}
              } else {
                  alert("é ç´„å·²é€å‡ºï¼\nè«‹è¤‡è£½é€£çµå›å ±åŒ¯æ¬¾ï¼š\n" + reportLink);
              }
              setStep(6);
          } catch (e) { alert('Error: ' + e.message); }
      };

      const reset = () => {
          setStep(1); setLoc(null); setGuests([{ id: 1, services: [], addons: [], time: null, customTime: '', name: '', phone: '', discount: null }]);
          setInfo({notes:''}); setPage('home');
      };

      if (page === 'admin-login') return <AdminLogin onBack={()=>setPage('home')} onLogin={()=>setPage('admin')} />;
      if (page === 'admin') return <AdminPanel user={user} settings={settings} onBack={()=>setPage('home')} services={services} addons={addons} discounts={discounts} />;
      if (page === 'check-status') return <StatusCheck user={user} onBack={()=>setPage('home')} />;

      if (page === 'home') {
          return (
              <div className="min-h-screen flex flex-col items-center justify-center p-6 relative">
                  <button onClick={()=>setPage('admin-login')} className="absolute top-4 left-4 p-2 text-gray-300 hover:text-gray-500"><Icon path={Icons.settings}/></button>
                  <div className="max-w-md w-full text-center space-y-8">
                      <div><h1 className="text-4xl font-bold tracking-widest text-[#4e342e] mb-2">AM Studio</h1><p className="text-[#8d6e63] tracking-wider">ç·šä¸Šé ç´„ç³»çµ±</p></div>
                      <div className="grid gap-4">
                          {LOCATIONS.map(l => (
                              <button key={l.id} onClick={()=>{setLoc(l); setPage('booking'); setStep(2);}} className="big-card-btn">
                                  <div className="text-3xl mb-2 text-[#8d6e63]"><Icon path={Icons.map} size={32}/></div>
                                  <div className="text-lg font-bold text-[#4e342e] mb-1">{l.name}</div>
                                  <div className="text-sm text-gray-400">é»æ“Šé–‹å§‹é ç´„</div>
                              </button>
                          ))}
                          <button onClick={()=>setPage('check-status')} className="w-full bg-white border border-[#d7ccc8] text-[#8d6e63] p-4 rounded-3xl flex items-center justify-center gap-2 hover:bg-[#efebe9] shadow-sm"><Icon path={Icons.search} size={18}/> æŸ¥è©¢é ç´„ / å›å ±åŒ¯æ¬¾</button>
                      </div>
                  </div>
              </div>
          );
      }

      const depositTotal = guests.length * BANK_INFO.amountPerPerson;

      return (
          <div className="min-h-screen bg-white md:bg-[#f4f1ea] flex flex-col">
              <div className="bg-white p-4 sticky top-0 z-10 border-b flex items-center justify-between shadow-sm">
                  <button onClick={()=>{ if(step===2) reset(); else setStep(s=>s-1); }} className="p-2 text-[#8d6e63]"><Icon path={Icons.chevronLeft}/></button>
                  <span className="font-bold text-[#4e342e] text-sm">{step===2?'é¸æ“‡é …ç›®':step===3?'é¸æ“‡æ™‚é–“':step===4?'åŸºæœ¬è³‡æ–™':step===5?'è¨‚é‡‘èªªæ˜':'é ç´„å®Œæˆ'}</span>
                  <div className="w-8"></div>
              </div>

              <div className="flex-1 p-6 max-w-lg mx-auto w-full overflow-y-auto pb-20">
                  {step === 2 && (
                      <div className="space-y-8 fade-in">
                          {guests.map((g, i) => (
                              <div key={g.id} className="guest-block">
                                  <div className="flex justify-between items-center mb-3">
                                      <h3 className="text-lg font-bold text-[#5d4037]">ç¬¬ {i+1} ä½</h3>
                                      {i > 0 && <button onClick={()=>removeGuest(i)} className="text-xs text-red-400 border border-red-200 px-2 py-1 rounded"><Icon path={Icons.trash} size={14}/></button>}
                                  </div>
                                  
                                  {g.services.length > 0 && (
                                      <div className="space-y-2 mb-4">
                                          {g.services.map(s => (
                                              <div key={s.id} className="flex justify-between items-center p-4 bg-white rounded-2xl border border-[#d7ccc8] shadow-sm">
                                                  <div>
                                                      <div className="font-bold text-[#4e342e] text-lg">{s.name}</div>
                                                      <div className="text-sm text-gray-500">${s.price}</div>
                                                  </div>
                                                  <button onClick={()=>removeServiceFromGuest(i, s.id)} className="text-red-400 p-2 bg-red-50 rounded-full"><Icon path={Icons.trash} size={16}/></button>
                                              </div>
                                          ))}
                                      </div>
                                  )}

                                  {showSelector !== i ? (
                                      <button onClick={()=>setShowSelector(i)} className="w-full py-4 bg-white border-2 border-dashed border-[#8d6e63] text-[#8d6e63] rounded-2xl flex items-center justify-center gap-2 hover:bg-[#efebe9] transition-colors font-bold shadow-sm">
                                          <Icon path={Icons.plus}/> {g.services.length>0 ? 'å†åŠ ä¸€é …æœå‹™' : 'æ–°å¢æœå‹™é …ç›®'}
                                      </button>
                                  ) : (
                                      <div className="mt-2">
                                          <ServiceSelector services={services} onSelect={(s)=>{ addServiceToGuest(i, s); setShowSelector(null); }} onCancel={()=>setShowSelector(null)} />
                                      </div>
                                  )}
                                  
                                  <div className="mt-6">
                                      <label className="text-xs font-bold text-gray-500 block mb-2 flex items-center gap-1"><Icon path={Icons.tag} size={14}/> å„ªæƒ èº«ä»½</label>
                                      <select className="w-full p-3 rounded-xl border bg-white text-sm focus:ring-2 focus:ring-[#8d6e63] outline-none shadow-sm" value={g.discount ? g.discount.id : ''} onChange={(e) => { const selected = discounts.find(d => d.id === e.target.value); updateGuest(i, 'discount', selected || null); }}>
                                          <option value="">ç„¡ (ä¿æŒåŸåƒ¹)</option>
                                          {discounts.filter(d => { const isTouchUp = g.services.some(s => s.type === 'è£œè‰²'); if (isTouchUp) return d.name.includes('å£½æ˜Ÿ'); return true; }).map(d => (<option key={d.id} value={d.id}>{d.name} (æŠ˜æŠµ ${d.amount})</option>))}
                                      </select>
                                      {g.services.some(s=>s.type==='è£œè‰²') && <p className="text-[10px] text-red-400 mt-2 px-1">â€» è£œè‰²é …ç›®åƒ…é©ç”¨å£½æ˜Ÿå„ªæƒ ï¼Œæ•ä¸é©ç”¨å…¶ä»–æŠ˜æ‰£</p>}
                                  </div>
                              </div>
                          ))}
                          
                          <button onClick={addGuest} className="w-full py-3 bg-[#8d6e63] text-white rounded-xl flex items-center justify-center gap-2 shadow-lg hover:bg-[#795548] font-bold transition-all transform hover:scale-[1.02]">
                              <Icon path={Icons.plus}/> æ–°å¢ä¸€ä½åŒä¼´ ({guests.length >= 1 ? 'å¤šäººåŒè¡Œ' : 'å…©äººåŒè¡Œ'})
                          </button>

                          <div className="bg-[#5d4037] text-white p-5 rounded-2xl flex justify-between items-center shadow-xl sticky bottom-4 border-t-4 border-[#8d6e63]">
                              <div className="text-sm">
                                  ç¸½è¨ˆäººæ•¸ï¼š{guests.length} ä½
                                  {guests.length >= 2 && <span className="block text-xs opacity-80 mt-1">(å·²å«å…©äººåŒè¡Œå„ªæƒ )</span>}
                              </div>
                              <div className="font-bold text-2xl">${calculateTotal()}</div>
                          </div>
                      </div>
                  )}

                  {/* Step 3: Date & Time */}
                  {step === 3 && (
                      <div className="space-y-6 fade-in">
                          <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                              <div className="flex justify-between items-center mb-4">
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()-1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronLeft}/></button>
                                  <span className="font-bold text-lg">{date.getFullYear()}å¹´ {date.getMonth()+1}æœˆ</span>
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()+1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronRight}/></button>
                              </div>
                              <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><span key={d} className="text-xs text-gray-400">{d}</span>)}</div>
                              <div className="grid grid-cols-7 gap-1">
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth(), 1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                      const d = i+1;
                                      const curr = new Date(date.getFullYear(), date.getMonth(), d);
                                      const open = isDateOpen(curr);
                                      const isPast = curr < new Date().setHours(0,0,0,0);
                                      const isSel = d === date.getDate();
                                      return <button key={d} disabled={isPast || !open} onClick={()=>{setDate(curr);}} className={`h-9 w-9 rounded-full text-sm flex items-center justify-center transition-all ${isSel?'bg-[#8d6e63] text-white shadow-md':(isPast||!open)?'text-gray-200':'hover:bg-[#efebe9]'}`}>{d}</button>
                                  })}
                              </div>
                          </div>
                          {isDateOpen(date) ? (
                              <div className="space-y-6">
                                  <div className="text-red-500 text-xs text-center bg-red-50 p-2 rounded">âš ï¸ å¤šäººåŒè¡Œå»ºè­°é¸æ“‡é€£çºŒæ™‚æ®µ</div>
                                  {guests.map((g, idx) => {
                                      const myTime = g.time;
                                      const taken = booked.concat(guests.filter((_, i)=>i!==idx).map(og=>og.time).filter(t=>t));
                                      return (
                                          <div key={g.id} className="bg-white p-5 rounded-2xl border shadow-sm">
                                              <div className="font-bold text-[#5d4037] mb-3">ç¬¬ {idx+1} ä½æ™‚æ®µ</div>
                                              <div className="grid grid-cols-3 gap-2">
                                                  {getSlots(date).map(t => (
                                                      <button key={t} disabled={taken.includes(t)} onClick={()=>{ updateGuest(idx, 'time', t); updateGuest(idx, 'customTime', ''); }} className={`py-2 rounded-lg border text-xs font-bold transition-all ${myTime===t?'bg-[#8d6e63] text-white border-[#8d6e63] shadow-md':taken.includes(t)?'bg-gray-100 text-gray-300 cursor-not-allowed':'bg-white hover:border-[#8d6e63]'}`}>{t}</button>
                                                  ))}
                                              </div>
                                              {myTime === 'å¾®èª¿æ™‚æ®µç”³è«‹' && (
                                                  <input type="time" className="mt-3 w-full border p-3 rounded-xl text-lg text-center bg-[#fdfbf7]" value={g.customTime} onChange={e=>updateGuest(idx, 'customTime', e.target.value)} />
                                              )}
                                          </div>
                                      )
                                  })}
                              </div>
                          ) : <div className="text-center py-8 bg-gray-50 rounded-xl text-gray-400">æ­¤æ—¥æœŸæœªé–‹æ”¾</div>}
                      </div>
                  )}
                  
                  {step === 4 && (
                      <div className="space-y-6 fade-in">
                          <div className="space-y-4">
                              {guests.map((g, i) => (
                                  <div key={g.id} className="bg-white p-5 rounded-2xl border shadow-sm">
                                      <h3 className="text-sm font-bold text-[#5d4037] mb-4 border-b pb-2">ç¬¬ {i+1} ä½é¡§å®¢è³‡æ–™</h3>
                                      <div className="space-y-4">
                                          <input className="w-full p-3 bg-[#fdfbf7] rounded-xl border border-transparent focus:border-[#8d6e63] outline-none transition-all" placeholder="å§“å" value={g.name} onChange={e=>updateGuest(i, 'name', e.target.value)} />
                                          <input className="w-full p-3 bg-[#fdfbf7] rounded-xl border border-transparent focus:border-[#8d6e63] outline-none transition-all" type="tel" placeholder="é›»è©±" value={g.phone} onChange={e=>updateGuest(i, 'phone', e.target.value)} />
                                      </div>
                                  </div>
                              ))}
                              <div><label className="block text-xs font-bold text-gray-500 mb-2 ml-1">å…¶ä»–å‚™è¨»</label><textarea className="w-full p-4 bg-white rounded-2xl border border-gray-200 focus:border-[#8d6e63] h-24 resize-none outline-none transition-all" placeholder="éœ€å¸ç”²ã€çš®è†šæ•æ„Ÿ..." value={info.notes} onChange={e=>setInfo({...info,notes:e.target.value})} /></div>
                          </div>
                          <div className="flex justify-between text-sm border-t pt-4 px-2"><span className="text-gray-500">ç¸½é‡‘é¡</span><span className="font-bold text-[#8d6e63] text-xl">${calculateTotal()}</span></div>
                      </div>
                  )}

                  {step === 5 && (
                      <div className="space-y-6 fade-in">
                          <h2 className="text-xl font-bold text-[#4e342e]">è¨‚é‡‘èªªæ˜</h2>
                          <div className="bg-orange-50 border border-orange-200 p-6 rounded-2xl text-sm leading-relaxed text-[#5d4037]">
                              <p className="mb-4 font-bold text-base">ç¸½äººæ•¸ï¼š{guests.length} ä½</p>
                              <div className="bg-white p-5 rounded-xl border border-orange-100 mb-4 shadow-sm">
                                  <p className="mb-1 text-gray-500 text-xs">åŒ¯æ¬¾è³‡è¨Š</p>
                                  <p className="font-bold text-lg mb-1">{BANK_INFO.code}</p>
                                  <p className="font-bold text-2xl tracking-widest mb-1">{BANK_INFO.account}</p>
                                  <p className="text-sm">{BANK_INFO.name}</p>
                                  <div className="mt-4 pt-3 border-t border-dashed border-gray-200 flex justify-between items-center">
                                      <span className="font-bold">æ‡‰ä»˜è¨‚é‡‘</span>
                                      <span className="text-red-600 font-bold text-xl">${depositTotal}</span>
                                  </div>
                              </div>
                              <p className="text-xs text-gray-500 mt-4">â€» è«‹æ–¼é ç´„é€å‡ºå¾Œ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ï¼Œä¸¦ä½¿ç”¨é¦–é çš„ã€ŒæŸ¥è©¢/å›å ±ã€åŠŸèƒ½ä¸Šå‚³å¸³è™Ÿå¾Œäº”ç¢¼ã€‚</p>
                          </div>
                          <div className="flex items-center gap-3 p-2">
                              <input type="checkbox" id="agree" className="w-5 h-5 accent-[#8d6e63]"/>
                              <label htmlFor="agree" className="text-sm font-bold text-[#5d4037]">æˆ‘å·²é–±è®€ä¸¦åŒæ„æ”¯ä»˜è¨‚é‡‘è¦å‰‡</label>
                          </div>
                      </div>
                  )}

                  {step === 6 && (
                      <div className="text-center pt-10 fade-in">
                          <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 shadow-sm"><Icon path={Icons.check} size={48}/></div>
                          <h2 className="text-3xl font-bold mb-3 text-[#4e342e]">é ç´„é€å‡ºæˆåŠŸï¼</h2>
                          <p className="text-gray-500 mb-8">è«‹è¨˜å¾—åŒ¯æ¬¾ä¸¦å›å ±ã€‚</p>
                          <button onClick={reset} className="w-full bg-[#8d6e63] text-white py-4 rounded-2xl shadow-lg shadow-[#8d6e63]/30 font-bold text-lg hover:bg-[#795548] transition-all">è¿”å›é¦–é </button>
                      </div>
                  )}
              </div>

              {step < 6 && (
                  <div className="p-4 bg-white border-t safe-bottom">
                      <button onClick={()=>{
                          if(step===2 && guests.some(g=>g.services.length===0)) return alert('è«‹ç‚ºæ¯ä½å®¢äººé¸æ“‡æœå‹™');
                          if(step===3 && guests.some(g=>!g.time || (g.time==='å¾®èª¿æ™‚æ®µç”³è«‹' && !g.customTime))) return alert('è«‹ç‚ºæ¯ä½å®¢äººé¸æ“‡æ™‚é–“');
                          if(step===4 && guests.some(g=>!g.name || !g.phone)) return alert('è«‹å¡«å¯«æ‰€æœ‰è³‡æ–™');
                          if(step===5 && !document.getElementById('agree').checked) return alert('è«‹å‹¾é¸åŒæ„');
                          if(step===5) handleSubmit(); else setStep(s=>s+1);
                      }} className="w-full bg-[#8d6e63] text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-[#8d6e63]/30 active:scale-[0.98] transition-transform">
                          {step===5 ? 'é€å‡ºé ç´„' : 'ä¸‹ä¸€æ­¥'}
                      </button>
                  </div>
              )}
          </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
