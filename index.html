<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·šä¸Šé ç´„ç³»çµ±</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #f4f1ea; }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #8d6e63; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #debug-console {
        position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: #fff;
        padding: 10px; font-size: 12px; max-height: 150px; overflow-y: auto; z-index: 9999; display: none;
    }
  </style>

  <!-- æ ¸å¿ƒç¨‹å¼åº« -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body>
  
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #8d6e63;">
      <div class="spinner"></div>
      <p>ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>
  </div>

  <!-- éŒ¯èª¤é¡¯ç¤ºå™¨ (Debug Console) -->
  <div id="error-display" style="display:none; position:fixed; top:0; left:0; right:0; padding:20px; background:#fee2e2; color:#991b1b; border-bottom:2px solid #ef4444; z-index:9999;">
    <h3 style="font-weight:bold; margin-bottom:5px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h3>
    <pre id="error-text" style="white-space:pre-wrap; font-size:12px;"></pre>
    <button onclick="location.reload()" style="margin-top:10px; padding:5px 10px; background:#fff; border:1px solid #991b1b;">é‡æ–°æ•´ç†</button>
  </div>

  <script>
    // å…¨åŸŸéŒ¯èª¤æ””æˆª
    window.onerror = function(msg, url, line) {
        document.getElementById('root').style.display = 'none';
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-text').innerText = `Error: ${msg}\nLine: ${line}\nURL: ${url}`;
        return false;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // ------------------------------------------------------------------
    // âš ï¸âš ï¸âš ï¸ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase è¨­å®š (é€™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥) âš ï¸âš ï¸âš ï¸
    // ------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
       appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    // ------------------------------------------------------------------

    const LIFF_ID = '2008567948-rNVLPLYb';
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';

    // åˆå§‹åŒ– Firebase
    let db, auth;
    let isConfigValid = firebaseConfig.apiKey !== "è«‹å¡«å…¥æ‚¨çš„apiKey";

    if (isConfigValid) {
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error(e);
            document.getElementById('error-text').innerText = "Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message;
            document.getElementById('error-display').style.display = 'block';
        }
    }

    // --- å…ƒä»¶å€ ---
    const Icon = ({ path, size = 24 }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        {path}
      </svg>
    );
    // ç°¡åŒ–åœ–ç¤ºå®šç¾©ä»¥é¿å…èªæ³•éŒ¯èª¤
    const Icons = {
      MapPin: <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>,
      ChevronRight: <path d="m9 18 6-6-6-6"/>,
      ChevronLeft: <path d="m15 18-6-6 6-6"/>,
      Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>,
      Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
      User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
      Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
      FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>,
      CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
      Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
      Plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
      Info: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>
    };

    const LOCATIONS = [{ id: 'tainan', name: 'å°å—å·¥ä½œå®¤' }, { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }];
    const DEFAULT_TIME_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DISCOUNT_NOTE = "â€» å„ªæƒ èº«åˆ†åŒ…å«ï¼šå­¸ç”Ÿã€é†«è­·ã€è»å…¬æ•™ã€ç•¶æœˆå£½æ˜Ÿã€èˆŠå®¢ä»‹ç´¹ (è«‹æ–¼ç¾å ´å‡ºç¤ºè­‰æ˜)";

    function AppointmentApp() {
      // å¦‚æœè¨­å®šç„¡æ•ˆï¼Œé¡¯ç¤ºè­¦å‘Š
      if (!isConfigValid) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-white">
                <div className="text-4xl mb-4">âš ï¸</div>
                <h1 className="text-xl font-bold text-red-600 mb-2">å°šæœªè¨­å®šè³‡æ–™åº«</h1>
                <p className="text-gray-600 mb-2">è«‹ä½¿ç”¨é›»è…¦æ–‡å­—ç·¨è¼¯å™¨é–‹å•Ÿ <code>index.html</code></p>
                <p className="text-gray-600">æœå°‹ <code>const firebaseConfig</code> ä¸¦å¡«å…¥æ‚¨çš„è¨­å®šã€‚</p>
            </div>
        );
      }

      const [user, setUser] = useState(null);
      const [view, setView] = useState('home'); 
      const [bookingStep, setBookingStep] = useState(1);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [selectedService, setSelectedService] = useState(null);
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedTime, setSelectedTime] = useState(null);
      const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', notes: '' });
      
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [bookedSlots, setBookedSlots] = useState([]); 
      const [locationSettings, setLocationSettings] = useState({});
      const [adminPinInput, setAdminPinInput] = useState('');

      useEffect(() => {
        // å®‰å…¨ç™»å…¥ï¼Œè‹¥å¤±æ•—é¡¯ç¤ºéŒ¯èª¤ä½†ä¸ crash
        auth.signInAnonymously().catch(err => {
            console.error("Auth Error", err);
            // é€™è£¡ä¸é˜»æ“‹ï¼Œå› ç‚ºå¾Œå°å¯èƒ½åªéœ€è¦è®€å–
        });
        if (window.liff) window.liff.init({ liffId: LIFF_ID }).catch(e => console.log('Liff init fail', e));
        return auth.onAuthStateChanged(setUser);
      }, []);

      // ç›£è½è³‡æ–™ï¼Œå¢åŠ éŒ¯èª¤è™•ç†ä»¥å…ç™½ç•«é¢
      useEffect(() => {
        if (!user) return;
        const safeSnap = (ref, setter) => ref.onSnapshot(
            snap => setter(snap.docs.map(d => ({id:d.id, ...d.data()}))),
            err => console.error("Data Fetch Error:", err)
        );

        const dbRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        
        safeSnap(dbRef.collection('services').orderBy('name'), setServices);
        safeSnap(dbRef.collection('addons'), setAddons);
        
        dbRef.collection('settings').onSnapshot(snap => {
            const s = {}; snap.forEach(d => s[d.id] = d.data());
            setLocationSettings(s);
        }, err => console.error("Settings Error", err));

      }, [user]);

      // é ç´„è³‡æ–™ç›£è½
      useEffect(() => {
        if (!user || !selectedLocation || !selectedDate) return;
        const dateStr = selectedDate.toISOString().split('T')[0];
        const q = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', selectedLocation.id).where('date', '==', dateStr);
        
        q.onSnapshot(snap => setBookedSlots(snap.docs.map(d => d.data().time)), err => console.error(err));
      }, [user, selectedLocation, selectedDate]);

      // Methods
      const isDateAvailable = (date) => {
        if (!selectedLocation) return true;
        const settings = locationSettings[selectedLocation.id];
        if (!settings?.allowedDates?.length) return true;
        return settings.allowedDates.includes(date.toISOString().split('T')[0]);
      };

      const getCurrentTimeSlots = () => {
        if (!selectedLocation) return DEFAULT_TIME_SLOTS;
        const settings = locationSettings[selectedLocation.id];
        return (settings?.timeSlots?.length) ? settings.timeSlots : DEFAULT_TIME_SLOTS;
      };

      const handleSubmit = async () => {
        if (!user) return alert("å°šæœªé€£ç·šï¼Œè«‹ç¨å¾Œ");
        const data = {
          locationId: selectedLocation.id, locationName: selectedLocation.name,
          serviceId: selectedService.id, serviceName: selectedService.name,
          addons: selectedAddons, date: selectedDate.toISOString().split('T')[0],
          time: selectedTime, customerName: customerInfo.name, customerPhone: customerInfo.phone,
          notes: customerInfo.notes, createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
        };
        try {
          await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add(data);
          const msg = `ã€é ç´„é€šçŸ¥ã€‘\nğŸ  ${data.locationName}\nğŸ“… ${data.date} ${data.time}\nğŸ’† ${data.serviceName}\nğŸ‘¤ ${data.customerName}`;
          if (window.liff?.isInClient()) await window.liff.sendMessages([{ type: 'text', text: msg }]);
          setBookingStep(5);
        } catch (e) { alert('é ç´„å¤±æ•—: ' + e.message); }
      };

      const reset = () => {
        setBookingStep(1); setSelectedLocation(null); setSelectedService(null);
        setSelectedAddons([]); setSelectedTime(null); setCustomerInfo({name:'',phone:'',notes:''}); setView('home');
      };

      // --- Views ---
      if (view === 'admin-login') {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="bg-white p-8 rounded shadow-lg w-80 text-center border">
              <h2 className="text-xl font-bold mb-4">å¾Œå°ç™»å…¥</h2>
              <input type="password" placeholder="PIN" className="w-full border p-2 mb-4" value={adminPinInput} onChange={e=>setAdminPinInput(e.target.value)} />
              <div className="flex gap-2">
                <button onClick={()=>setView('home')} className="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button>
                <button onClick={()=>adminPinInput===ADMIN_PIN?setView('admin-dashboard'):alert('Error')} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">ç™»å…¥</button>
              </div>
            </div>
          </div>
        );
      }

      if (view === 'admin-dashboard') {
        return <AdminDashboard onBack={()=>setView('home')} user={user} services={services} settings={locationSettings} />;
      }

      if (view === 'home') {
        return (
          <div className="min-h-screen p-6 flex flex-col items-center justify-center bg-[#f4f1ea]">
             <button onClick={()=>setView('admin-login')} className="absolute top-4 left-4 p-2 opacity-30"><Icon path={Icons.Settings}/></button>
             <div className="bg-[#fdfbf7] p-8 rounded-sm shadow-xl border border-[#e8e4dc] max-w-md w-full text-center">
                <h1 className="text-3xl font-bold mb-2 text-[#4e342e] tracking-widest">ç·šä¸Šé ç´„</h1>
                <p className="text-[#8d6e63] mb-8 text-sm">è«‹é¸æ“‡æœå‹™æ“šé»</p>
                <div className="space-y-4">
                  {LOCATIONS.map(loc => (
                    <button key={loc.id} onClick={()=>{setSelectedLocation(loc); setView('booking'); setBookingStep(2)}} 
                      className="w-full bg-white border-2 border-[#d7ccc8] hover:border-[#8d6e63] p-6 rounded-lg flex items-center justify-between group transition-all">
                      <div className="flex items-center gap-4">
                        <span className="bg-[#efebe9] p-3 rounded-full text-[#5d4037]"><Icon path={Icons.MapPin}/></span>
                        <h3 className="text-xl font-bold text-[#4e342e]">{loc.name}</h3>
                      </div>
                      <span className="text-[#d7ccc8] group-hover:text-[#8d6e63]"><Icon path={Icons.ChevronRight}/></span>
                    </button>
                  ))}
                </div>
             </div>
          </div>
        );
      }

      // Booking UI
      return (
        <div className="min-h-screen py-6 px-4 bg-[#f4f1ea]">
          <div className="max-w-lg mx-auto bg-[#fdfbf7] min-h-[85vh] rounded-sm shadow-xl border border-[#e8e4dc] flex flex-col">
            <div className="p-6 border-b border-[#e8e4dc] flex items-center justify-between bg-white/50">
               <button onClick={()=>bookingStep===2?reset():setBookingStep(s=>s-1)} className="text-[#8d6e63]"><Icon path={Icons.ChevronLeft}/></button>
               <span className="font-bold text-[#4e342e]">{bookingStep===2?'é¸æ“‡æœå‹™':bookingStep===3?'é¸æ“‡æ™‚é–“':'è³‡æ–™ç¢ºèª'}</span>
               <div className="w-6"></div>
            </div>
            <div className="flex-1 p-6 overflow-y-auto">
              {bookingStep===2 && (
                <div className="space-y-6">
                  <div className="bg-[#efebe9]/50 p-4 rounded text-xs text-[#6d4c41] flex gap-2"><span className="mt-0.5"><Icon path={Icons.Info} size={16}/></span>{DISCOUNT_NOTE}</div>
                  <div className="grid gap-3">
                    {services.map(s=>(
                      <label key={s.id} className={`flex items-center justify-between p-4 border rounded-lg cursor-pointer ${selectedService?.id===s.id?'border-[#8d6e63] bg-[#efebe9]':'border-gray-200'}`}>
                        <div className="flex items-center gap-3">
                          <input type="radio" name="svc" className="accent-[#8d6e63] w-5 h-5" checked={selectedService?.id===s.id} onChange={()=>setSelectedService(s)}/>
                          <div><div className="font-bold">{s.name}</div><div className="text-sm text-[#8d6e63]">${s.price} / {s.duration}åˆ†</div></div>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>
              )}
              {bookingStep===3 && (
                 <div className="space-y-6">
                   <div className="bg-white p-4 rounded border shadow-sm">
                     <div className="flex justify-between items-center mb-4">
                       <button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()-1)))} className="p-1 hover:bg-gray-100"><Icon path={Icons.ChevronLeft}/></button>
                       <span className="font-bold">{selectedDate.getFullYear()}/{selectedDate.getMonth()+1}</span>
                       <button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()+1)))} className="p-1 hover:bg-gray-100"><Icon path={Icons.ChevronRight}/></button>
                     </div>
                     <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d} className="text-xs text-gray-400">{d}</div>)}</div>
                     <div className="grid grid-cols-7 gap-1">
                        {Array.from({length:new Date(selectedDate.getFullYear(),selectedDate.getMonth(),1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                        {Array.from({length:new Date(selectedDate.getFullYear(),selectedDate.getMonth()+1,0).getDate()}).map((_,i)=>{
                            const d=i+1, cur=new Date(selectedDate.getFullYear(),selectedDate.getMonth(),d), avail=isDateAvailable(cur), past=cur<new Date().setHours(0,0,0,0);
                            const isSel=d===selectedDate.getDate();
                            return <button key={d} disabled={past||!avail} onClick={()=>{setSelectedDate(cur);setSelectedTime(null)}} 
                              className={`h-8 w-8 rounded-full text-sm mx-auto flex items-center justify-center relative ${isSel?'bg-[#8d6e63] text-white':past||!avail?'text-gray-200':'hover:bg-[#efebe9]'}`}>
                              {d}{!past&&avail&&!isSel&&<div className="absolute bottom-1 w-1 h-1 bg-[#8d6e63] rounded-full"/>}
                            </button>
                        })}
                     </div>
                   </div>
                   {isDateAvailable(selectedDate)?(
                     <div className="grid grid-cols-2 gap-3">
                       {getCurrentTimeSlots().map(t=>(
                         <button key={t} disabled={bookedSlots.includes(t)} onClick={()=>setSelectedTime(t)} className={`py-3 rounded border text-sm ${selectedTime===t?'bg-[#8d6e63] text-white':bookedSlots.includes(t)?'bg-gray-100 text-gray-300':'bg-white hover:border-[#8d6e63]'}`}>{t}</button>
                       ))}
                     </div>
                   ):<div className="text-center text-red-400 text-sm">æœªé–‹æ”¾é ç´„</div>}
                 </div>
              )}
              {bookingStep===4 && (
                <div className="space-y-4">
                  <div className="bg-[#efebe9] p-4 rounded text-sm space-y-2 border border-[#d7ccc8]">
                    <div className="flex justify-between"><span className="text-[#a1887f]">åœ°é»</span><b>{selectedLocation?.name}</b></div>
                    <div className="flex justify-between"><span className="text-[#a1887f]">æ™‚é–“</span><b>{selectedDate.toLocaleDateString()} {selectedTime}</b></div>
                    <div className="flex justify-between"><span className="text-[#a1887f]">é …ç›®</span><b>{selectedService?.name}</b></div>
                  </div>
                  <input type="text" placeholder="å§“å" className="w-full border-b-2 bg-transparent py-2 outline-none" value={customerInfo.name} onChange={e=>setCustomerInfo({...customerInfo,name:e.target.value})}/>
                  <input type="tel" placeholder="é›»è©±" className="w-full border-b-2 bg-transparent py-2 outline-none" value={customerInfo.phone} onChange={e=>setCustomerInfo({...customerInfo,phone:e.target.value})}/>
                  <textarea placeholder="å‚™è¨»" className="w-full border-b-2 bg-transparent py-2 outline-none resize-none" rows={2} value={customerInfo.notes} onChange={e=>setCustomerInfo({...customerInfo,notes:e.target.value})}/>
                </div>
              )}
              {bookingStep===5 && (
                <div className="text-center py-10">
                  <div className="text-green-600 mb-4"><Icon path={Icons.CheckCircle} size={48}/></div>
                  <h2 className="text-2xl font-bold mb-6">é ç´„æˆåŠŸï¼</h2>
                  <button onClick={reset} className="bg-[#8d6e63] text-white px-8 py-3 rounded">å›é¦–é </button>
                </div>
              )}
            </div>
            {bookingStep<5 && (
              <div className="p-6 border-t bg-white/50">
                <button onClick={()=>{
                   if(bookingStep===2&&!selectedService)return alert('è«‹é¸æ“‡æœå‹™');
                   if(bookingStep===3&&!selectedTime)return alert('è«‹é¸æ“‡æ™‚é–“');
                   if(bookingStep===4&&(!customerInfo.name||!customerInfo.phone))return alert('è«‹å¡«å¯«è³‡æ–™');
                   bookingStep===4?handleSubmit():setBookingStep(s=>s+1);
                }} className="w-full bg-[#8d6e63] text-white py-3 rounded shadow hover:bg-[#795548]">{bookingStep===4?'ç¢ºèªé ç´„':'ä¸‹ä¸€æ­¥'}</button>
              </div>
            )}
          </div>
        </div>
      );
    }

    function AdminDashboard({ onBack, user, services, settings }) {
      const [tab, setTab] = useState('set');
      const [books, setBooks] = useState([]);
      const [kaD, setKaD] = useState(settings['kaohsiung']?.allowedDates?.join(',')||'');
      const [kaT, setKaT] = useState(settings['kaohsiung']?.timeSlots?.join(',')||DEFAULT_TIME_SLOTS.join(','));
      const [taD, setTaD] = useState(settings['tainan']?.allowedDates?.join(',')||'');
      const [taT, setTaT] = useState(settings['tainan']?.timeSlots?.join(',')||DEFAULT_TIME_SLOTS.join(','));

      useEffect(()=>{
        if(!user)return;
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').orderBy('date','desc').onSnapshot(s=>setBooks(s.docs.map(d=>({id:d.id,...d.data()}))));
      },[user]);

      const save = async (id, d, t) => {
        await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(id).set({
          allowedDates: d.split(',').map(x=>x.trim()).filter(x=>x), timeSlots: t.split(',').map(x=>x.trim()).filter(x=>x)
        }); alert('Saved');
      };

      const init = async () => {
         if(!confirm('Reset Services?'))return;
         const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services');
         [{name:'éœ§çœ‰(ä¸€èˆ¬)',price:4800,duration:90},{name:'éœ§çœ‰(å„ªæƒ )',price:4600,duration:90},{name:'éœ§å”‡(ä¸€èˆ¬)',price:5200,duration:120},{name:'éœ§å”‡(å„ªæƒ )',price:5000,duration:120}].forEach(d=>ref.add(d));
         alert('Done');
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4">
           <div className="bg-white rounded shadow max-w-4xl mx-auto overflow-hidden">
             <div className="flex justify-between p-4 border-b"><b>å¾Œå°ç®¡ç†</b><button onClick={onBack} className="bg-gray-500 text-white px-3 py-1 rounded text-sm">é›¢é–‹</button></div>
             <div className="flex border-b text-sm"><button onClick={()=>setTab('set')} className={`flex-1 py-3 ${tab==='set'?'text-[#8d6e63] font-bold':''}`}>è¨­å®š</button><button onClick={()=>setTab('svc')} className={`flex-1 py-3 ${tab==='svc'?'text-[#8d6e63] font-bold':''}`}>æœå‹™</button><button onClick={()=>setTab('book')} className={`flex-1 py-3 ${tab==='book'?'text-[#8d6e63] font-bold':''}`}>é ç´„</button></div>
             <div className="p-4">
               {tab==='set' && (
                 <div className="space-y-4 text-sm">
                   <div className="border p-3 rounded bg-orange-50">
                     <b className="text-orange-800 block mb-2">é«˜é›„</b>
                     <textarea className="w-full border p-2 h-16 mb-2" value={kaD} onChange={e=>setKaD(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)"/>
                     <button onClick={()=>setKaD("2025-12-12,2025-12-13,2025-12-14,2025-12-15,2025-12-26,2025-12-27,2025-12-28,2025-12-29")} className="text-blue-600 underline text-xs mb-2 block">åŒ¯å…¥12æœˆ</button>
                     <input className="w-full border p-2 mb-2" value={kaT} onChange={e=>setKaT(e.target.value)}/>
                     <button onClick={()=>save('kaohsiung',kaD,kaT)} className="bg-orange-600 text-white px-3 py-1 rounded">å„²å­˜</button>
                   </div>
                   <div className="border p-3 rounded bg-blue-50">
                     <b className="text-blue-800 block mb-2">å°å—</b>
                     <textarea className="w-full border p-2 h-16 mb-2" value={taD} onChange={e=>setTaD(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)"/>
                     <input className="w-full border p-2 mb-2" value={taT} onChange={e=>setTaT(e.target.value)}/>
                     <button onClick={()=>save('tainan',taD,taT)} className="bg-blue-800 text-white px-3 py-1 rounded">å„²å­˜</button>
                   </div>
                 </div>
               )}
               {tab==='svc' && (
                 <div>
                   <button onClick={init} className="bg-yellow-600 text-white px-3 py-1 rounded text-sm mb-4">é‡ç½®é è¨­æœå‹™</button>
                   <div className="space-y-2">{services.map(s=><div key={s.id} className="flex justify-between border p-2 rounded text-sm"><span>{s.name} (${s.price})</span><button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-500"><Icon path={Icons.Trash2} size={16}/></button></div>)}</div>
                   <button onClick={async()=>{const n=prompt('å');const p=prompt('åƒ¹');if(n&&p)await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({name:n,price:Number(p),duration:90})}} className="mt-4 border border-[#8d6e63] text-[#8d6e63] px-4 py-2 rounded flex items-center gap-2 text-sm"><Icon path={Icons.Plus} size={16}/>æ–°å¢</button>
                 </div>
               )}
               {tab==='book' && (
                 <div className="space-y-2">{books.map(b=><div key={b.id} className="border-b p-2 text-sm flex justify-between"><div><div className="font-bold text-[#8d6e63]">{b.date} {b.time}</div><div>{b.serviceName} - {b.customerName}</div></div><button onClick={()=>confirm('Del?')&&db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).delete()} className="text-red-400"><Icon path={Icons.Trash2} size={16}/></button></div>)}</div>
               )}
             </div>
           </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppointmentApp />);
  </script>
</body>
</html>
