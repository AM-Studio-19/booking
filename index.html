<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM Studio ç·šä¸Šé ç´„</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #fdfbf7; color: #5d4037; }
    
    .option-card { transition: all 0.2s; border: 2px solid #e5e7eb; }
    .option-card:hover { border-color: #d7ccc8; }
    .option-card.active { border-color: #8d6e63; background-color: #efebe9; color: #3e2723; }
    
    .mode-btn { transition: all 0.2s; }
    .mode-btn.active { background-color: #5d4037; color: white; border-color: #5d4037; }
    
    .spinner {
      border: 3px solid #f3f3f3; border-top: 3px solid #8d6e63; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .date-cell.selected { background-color: #8d6e63; color: white; font-weight: bold; }
    .date-cell.has-rule { border-bottom: 2px solid #d97706; }
  </style>

  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #8d6e63;">
      <div class="spinner"></div>
      <p id="loading-text">ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>
  </div>

  <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; padding:20px; text-align:center;">
    <div style="max-width:500px; margin:50px auto; border:2px solid #ef4444; padding:20px; background:#fff; border-radius:8px;">
        <h2 style="color:#ef4444; font-size:24px; margin-bottom:10px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="error-msg" style="color:#333; margin-bottom:20px; word-break:break-all;"></p>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#8d6e63; color:white; border:none; border-radius:4px;">é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <script>
    window.onerror = function(msg, url, line) {
      document.getElementById('root').style.display = 'none';
      document.getElementById('error-box').style.display = 'block';
      document.getElementById('error-msg').innerHTML = `<strong>åŸå› ï¼š</strong>${msg}<br><br><small>(${url}:${line})</small>`;
      return false;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    const LIFF_ID = '2008567948-KGMPJPGe'; 
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';
    
    const BANK_INFO = { code: '822 (ä¸­åœ‹ä¿¡è¨—)', account: '1234-5678-9012', name: 'AM Studio', amount: 1000 };

    // --- Init ---
    let db, auth;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.error(e); }

    // --- Icons ---
    const Icon = ({ path, size = 20, className="" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );
    const Icons = {
        map: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
        user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
        chevronRight: <path d="m9 18 6-6-6-6"/>,
        chevronLeft: <path d="m15 18-6-6 6-6"/>,
        check: <polyline points="20 6 9 17 4 12"/>,
        settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
        trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
        plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
        msg: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>,
        search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
        edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
        zap: <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></>
    };

    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }
    ];
    const DEFAULT_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    
    // é è¨­è¨Šæ¯ç¯„æœ¬
    const DEFAULT_TEMPLATES = [
        { title: 'é ç´„ç¢ºèª', text: 'æ‚¨å¥½ï¼Œæ‚¨çš„é ç´„å·²ç¢ºèªï¼\næ™‚é–“ï¼š{{date}} {{time}}\nåœ°é»ï¼š{{location}}\næœå‹™ï¼š{{service}}\næœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚' },
        { title: 'è¨‚é‡‘å‚¬æ”¶', text: 'æ‚¨å¥½ï¼Œæé†’æ‚¨å°šæœªæ”¯ä»˜è¨‚é‡‘ã€‚\nè«‹åŒ¯æ¬¾è‡³ï¼š822 (ä¸­åœ‹ä¿¡è¨—) 1234-5678-9012\né‡‘é¡ï¼š$1000\nåŒ¯æ¬¾å¾Œè«‹è‡³æŸ¥è©¢é é¢å›å ±ï¼Œè¬è¬ï¼' },
        { title: 'å·²æ”¶è¨‚é‡‘', text: 'æ‚¨å¥½ï¼Œå·²æ”¶åˆ°æ‚¨çš„è¨‚é‡‘åŒ¯æ¬¾ï¼Œé ç´„æ­£å¼ä¿ç•™ã€‚æ„Ÿè¬æ‚¨ï¼' },
        { title: 'é ç´„å–æ¶ˆ', text: 'æ‚¨å¥½ï¼Œæ‚¨çš„é ç´„å·²å–æ¶ˆã€‚è‹¥æœ‰éœ€è¦è«‹å†æ¬¡é ç´„ï¼Œè¬è¬ã€‚' }
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [page, setPage] = useState('home'); 
      const [step, setStep] = useState(1);
      const [loc, setLoc] = useState(null);
      
      const [svcs, setSvcs] = useState([]);
      const [adds, setAdds] = useState([]);
      const [date, setDate] = useState(new Date());
      const [time, setTime] = useState(null);
      const [customTime, setCustomTime] = useState('');
      const [info, setInfo] = useState({name:'', phone:'', notes:'', name2: ''});
      
      const [isTwoPeople, setIsTwoPeople] = useState(false);
      const [lastOrder, setLastOrder] = useState(null);

      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [settings, setSettings] = useState({});
      const [booked, setBooked] = useState([]);

      useEffect(() => {
        auth.signInAnonymously().catch(e => console.warn(e));
        if (window.liff) window.liff.init({ liffId: LIFF_ID });
        return auth.onAuthStateChanged(setUser);
      }, []);

      useEffect(() => {
        if (!user) return;
        const pub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        pub.collection('services').orderBy('name').onSnapshot(s => setServices(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('addons').onSnapshot(s => setAddons(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('settings').onSnapshot(s => { 
            const obj = {}; s.forEach(d => obj[d.id] = d.data()); setSettings(obj); 
        });
      }, [user]);

      useEffect(() => {
        if (!loc || !date) return;
        const dStr = date.toISOString().split('T')[0];
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', loc.id).where('date', '==', dStr)
          .onSnapshot(s => setBooked(s.docs.map(d => d.data().time)));
      }, [loc, date]);

      const isDateOpen = (d) => {
          if (!loc) return true;
          const conf = settings[loc.id];
          if (!conf?.allowedDates?.length) return true;
          return conf.allowedDates.includes(d.toISOString().split('T')[0]);
      };
      
      const getSlots = (d) => {
          if (!loc) return DEFAULT_SLOTS;
          const dStr = d.toISOString().split('T')[0];
          const conf = settings[loc.id];
          if (conf?.specialRules && conf.specialRules[dStr]) return conf.specialRules[dStr];
          return conf?.timeSlots?.length ? conf.timeSlots : DEFAULT_SLOTS;
      };

      const calculateTotals = () => {
          let price = 0;
          let duration = 0;
          svcs.forEach(s => { price += s.price; duration += s.duration; });
          
          if (isTwoPeople) { 
              price *= 2; 
              duration *= 2; 
              price -= 400; // å…©äººåŒè¡Œå„ªæƒ ï¼Œæ¯äººæŠ˜200ï¼Œå…±æŠ˜400
          }
          
          adds.forEach(a => { price += a.price; duration += a.duration; });
          return { price, duration };
      };

      const toggleService = (s) => {
          const exists = svcs.find(item => item.id === s.id);
          if (exists) setSvcs(svcs.filter(item => item.id !== s.id));
          else setSvcs([...svcs, s]);
      };

      const handleSubmit = async () => {
          if (!user) return alert('é€£ç·šä¸­...');
          const tVal = time === 'å¾®èª¿æ™‚æ®µç”³è«‹' ? `å¾®èª¿ ${customTime}` : time;
          const addStr = adds.map(a => a.name).join(', ');
          const totals = calculateTotals();
          const svcNames = svcs.map(s => s.name).join(' + ');

          const order = {
              locationId: loc.id, locationName: loc.name,
              serviceId: svcs.map(s=>s.id), serviceName: svcNames,
              addons: adds, date: date.toISOString().split('T')[0],
              time: tVal, customerName: info.name, customerPhone: info.phone,
              notes: info.notes, 
              isTwoPeople, secondPersonName: info.name2,
              totalPrice: totals.price, 
              totalDuration: totals.duration,
              status: 'pending', paymentStatus: 'unpaid', msgSent: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
          };

          try {
              const ref = await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add(order);
              setLastOrder(order);
              const msg = `ã€é ç´„ç”³è«‹é€šçŸ¥ã€‘\nğŸ“ ${order.locationName}\nğŸ“… ${order.date} ${order.time}\nğŸ’… ${order.serviceName}${isTwoPeople ? ' (å…©äººåŒè¡Œå„ªæƒ )' : ''}\nğŸ’° é ä¼°ç¸½é¡ï¼š$${totals.price}\nğŸ‘¤ ${order.customerName}\nâš ï¸ è«‹ç­‰å€™åº—å®¶ç¢ºèªé€šçŸ¥ï¼Œä¸¦å®Œæˆè¨‚é‡‘æ”¯ä»˜ã€‚`;
              if (window.liff?.isInClient()) {
                  try { await window.liff.sendMessages([{ type: 'text', text: msg }]); await ref.update({ msgSent: true }); } catch (err) {}
              }
              setStep(6);
          } catch (e) { alert('Error: ' + e.message); }
      };

      const reset = () => {
          setStep(1); setLoc(null); setSvcs([]); setAdds([]); setTime(null); setCustomTime(''); setInfo({name:'', phone:'', notes:'', name2:''}); setIsTwoPeople(false);
          setPage('home');
      };

      if (page === 'admin-login') return <AdminLogin onBack={()=>setPage('home')} onLogin={()=>setPage('admin')} />;
      if (page === 'admin') return <AdminPanel user={user} settings={settings} onBack={()=>setPage('home')} services={services} addons={addons} />;
      if (page === 'check-status') return <StatusCheck user={user} onBack={()=>setPage('home')} />;

      if (page === 'home') {
          return (
              <div className="min-h-screen flex flex-col items-center justify-center p-6 relative">
                  <button onClick={()=>setPage('admin-login')} className="absolute top-4 left-4 p-2 text-gray-300 hover:text-gray-500"><Icon path={Icons.settings}/></button>
                  <div className="max-w-md w-full text-center space-y-8">
                      <div><h1 className="text-4xl font-bold tracking-widest text-[#4e342e] mb-2">AM Studio</h1><p className="text-[#8d6e63] tracking-wider">ç·šä¸Šé ç´„ç³»çµ±</p></div>
                      <div className="grid gap-4">
                          {LOCATIONS.map(l => (
                              <button key={l.id} onClick={()=>{setLoc(l); setPage('booking'); setStep(2);}} className="group bg-white border-2 border-[#e5e7eb] hover:border-[#8d6e63] p-6 rounded-xl flex items-center justify-between transition-all shadow-sm hover:shadow-md">
                                  <div className="flex items-center gap-4"><div className="w-12 h-12 bg-[#efebe9] rounded-full flex items-center justify-center text-[#5d4037] group-hover:bg-[#8d6e63] group-hover:text-white transition-colors"><Icon path={Icons.map} size={24}/></div><div className="text-left"><h3 className="text-lg font-bold text-[#4e342e]">{l.name}</h3><p className="text-xs text-gray-400">ç«‹å³é ç´„</p></div></div>
                                  <div className="text-gray-300 group-hover:text-[#8d6e63]"><Icon path={Icons.chevronRight}/></div>
                              </button>
                          ))}
                          <button onClick={()=>setPage('check-status')} className="w-full bg-white border border-[#d7ccc8] text-[#8d6e63] p-4 rounded-xl flex items-center justify-center gap-2 hover:bg-[#efebe9]"><Icon path={Icons.search} size={18}/> æŸ¥è©¢é ç´„ / å›å ±åŒ¯æ¬¾</button>
                      </div>
                  </div>
              </div>
          );
      }

      const totals = calculateTotals();

      return (
          <div className="min-h-screen bg-white md:bg-[#f4f1ea] flex flex-col">
              <div className="bg-white p-4 sticky top-0 z-10 border-b flex items-center justify-between shadow-sm">
                  <button onClick={()=>{ if(step===2) reset(); else setStep(s=>s-1); }} className="p-2 text-[#8d6e63]"><Icon path={Icons.chevronLeft}/></button>
                  <span className="font-bold text-[#4e342e] text-sm">{step===2?'é¸æ“‡é …ç›®':step===3?'é¸æ“‡æ™‚é–“':step===4?'åŸºæœ¬è³‡æ–™':step===5?'è¨‚é‡‘èªªæ˜':'é ç´„å®Œæˆ'}</span>
                  <div className="w-8"></div>
              </div>

              <div className="flex-1 p-6 max-w-lg mx-auto w-full overflow-y-auto pb-20">
                  {step === 2 && (
                      <div className="space-y-6 fade-in">
                          {/* é ç´„æ¨¡å¼åˆ‡æ› */}
                          <div className="flex bg-gray-100 p-1 rounded-xl mb-4">
                              <button onClick={()=>setIsTwoPeople(false)} className={`flex-1 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 mode-btn ${!isTwoPeople ? 'active' : 'text-gray-500 hover:bg-gray-200'}`}>
                                  <Icon path={Icons.user}/> å–®äººé ç´„
                              </button>
                              <button onClick={()=>setIsTwoPeople(true)} className={`flex-1 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 mode-btn ${isTwoPeople ? 'active' : 'text-gray-500 hover:bg-gray-200'}`}>
                                  <Icon path={Icons.users}/> å…©äººåŒè¡Œ
                              </button>
                          </div>

                          {isTwoPeople && (
                              <div className="bg-orange-50 border border-orange-200 p-4 rounded-lg text-xs text-orange-900 mb-4 leading-relaxed">
                                  <b className="text-sm">ğŸ å…©äººåŒè¡Œå°ˆå±¬å„ªæƒ ï¼šæ¯äººæŠ˜æŠµ $200 (å…±çœ $400)</b><br/>
                                  â€¢ è‹¥å…©äººæ“ä½œç›¸åŒé …ç›®ï¼šè«‹ç›´æ¥é¸æ“‡è©²é …ç›®ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—é›™äººåƒ¹æ ¼èˆ‡æ™‚é–“ã€‚<br/>
                                  â€¢ è‹¥å…©äººæ“ä½œä¸åŒé …ç›®ï¼šè«‹å‹¾é¸æ‰€æœ‰éœ€è¦çš„é …ç›®ï¼Œç³»çµ±å°‡è‡ªå‹•ç–ŠåŠ ã€‚<br/>
                                  <span className="text-red-600 font-bold mt-1 block">â— è‹¥è¦ç´„ä¸åŒæ™‚é–“ï¼šè«‹å›åˆ°ã€Œå–®äººé ç´„ã€åˆ†åˆ¥å¡«å¯«ï¼Œä¸¦åœ¨å‚™è¨»æ¬„è¨»æ˜åŒè¡Œè€…ã€‚</span>
                              </div>
                          )}

                          <div className="flex justify-between items-center mt-2">
                              <h2 className="text-xl font-bold text-[#4e342e]">é¸æ“‡æœå‹™ (å¯è¤‡é¸)</h2>
                              <div className="text-sm text-[#8d6e63]">å·²é¸ {svcs.length} é …</div>
                          </div>
                          
                          <div className="grid gap-3">{services.map(s => {
                              const isSel = svcs.find(i => i.id === s.id);
                              return (
                                  <button key={s.id} onClick={()=>toggleService(s)} className={`option-card p-4 rounded-xl flex items-center justify-between text-left ${isSel ? 'active' : 'bg-white'}`}>
                                      <div>
                                          <div className="font-bold text-lg">{s.name}</div>
                                          <div className="text-sm opacity-70">${s.price}ãƒ»{s.duration}åˆ†</div>
                                      </div>
                                      {isSel && <div className="text-[#8d6e63] font-bold flex items-center gap-1">{isTwoPeople ? 'x2' : ''} <Icon path={Icons.check}/></div>}
                                  </button>
                              );
                          })}</div>
                          
                          {addons.length > 0 && (
                              <div className="pt-4 border-t border-dashed">
                                  <h3 className="font-bold text-[#4e342e] mb-3 text-sm">åŠ è³¼ / å„ªæƒ  (å¯è¤‡é¸)</h3>
                                  <div className="grid grid-cols-2 gap-3">{addons.map(ad => {
                                      const checked = adds.some(a=>a.id===ad.id);
                                      return (
                                          <button key={ad.id} onClick={()=>{ if(checked) setAdds(adds.filter(a=>a.id!==ad.id)); else setAdds([...adds,ad]); }}
                                              className={`option-card p-3 rounded-lg text-sm text-center ${checked ? 'active' : 'bg-white'}`}>
                                              <div className="font-bold">{ad.name}</div><div className="text-xs opacity-70">{ad.price > 0 ? '+' : ''}{ad.price}</div>
                                          </button>
                                      );
                                  })}</div>
                              </div>
                          )}
                          
                          {/* å³æ™‚ç¸½è¦½ */}
                          <div className="bg-[#8d6e63] text-white p-4 rounded-xl flex justify-between items-center shadow-lg sticky bottom-4">
                              <div className="text-sm">
                                  é ä¼°æ™‚é•·ï¼š{totals.duration} åˆ†é˜
                                  {isTwoPeople && <span className="block text-xs opacity-80">(å«å…©äººåŒè¡Œå„ªæƒ  -$400)</span>}
                              </div>
                              <div className="font-bold text-lg">${totals.price}</div>
                          </div>
                      </div>
                  )}

                  {step === 3 && (
                      <div className="space-y-6 fade-in">
                          <div className="bg-[#fdfbf7] border border-[#d7ccc8] p-3 rounded-lg text-center text-sm text-[#8d6e63] font-bold">
                              æœ¬æ¬¡æœå‹™é è¨ˆéœ€è¦ {totals.duration} åˆ†é˜
                          </div>
                          <div className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                              <div className="flex justify-between items-center mb-4">
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()-1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronLeft}/></button>
                                  <span className="font-bold text-lg">{date.getFullYear()}å¹´ {date.getMonth()+1}æœˆ</span>
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()+1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronRight}/></button>
                              </div>
                              <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><span key={d} className="text-xs text-gray-400">{d}</span>)}</div>
                              <div className="grid grid-cols-7 gap-1">
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth(), 1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                      const d = i+1;
                                      const curr = new Date(date.getFullYear(), date.getMonth(), d);
                                      const open = isDateOpen(curr);
                                      const isPast = curr < new Date().setHours(0,0,0,0);
                                      const isSel = d === date.getDate();
                                      return <button key={d} disabled={isPast || !open} onClick={()=>{setDate(curr); setTime(null);}} className={`h-9 w-9 rounded-full text-sm flex items-center justify-center transition-all ${isSel?'bg-[#8d6e63] text-white shadow-md':(isPast||!open)?'text-gray-200':'hover:bg-[#efebe9]'}`}>{d}</button>
                                  })}
                              </div>
                          </div>
                          {isDateOpen(date) ? (
                              <div>
                                  <h3 className="font-bold text-[#4e342e] mb-3 flex items-center gap-2"><Icon path={Icons.clock}/> é¸æ“‡æ™‚æ®µ</h3>
                                  <div className="grid grid-cols-2 gap-3">
                                      {getSlots(date).map(t => (
                                          <button key={t} disabled={booked.includes(t)} onClick={()=>{setTime(t); setCustomTime('');}} className={`option-card py-3 rounded-lg text-sm font-medium ${time===t?'active':'bg-white'} ${booked.includes(t)?'opacity-40 cursor-not-allowed bg-gray-50':''}`}>{t} {booked.includes(t) && '(å·²æ»¿)'}</button>
                                      ))}
                                  </div>
                                  {time === 'å¾®èª¿æ™‚æ®µç”³è«‹' && (
                                      <div className="mt-4 bg-[#efebe9] p-4 rounded-xl fade-in"><label className="text-xs font-bold text-[#8d6e63] block mb-2">è«‹è¼¸å…¥æ‚¨æƒ³é ç´„çš„æ™‚é–“ï¼š</label><input type="time" className="w-full p-3 rounded-lg border-none text-center text-xl font-bold text-[#5d4037] bg-white shadow-inner" value={customTime} onChange={e=>setCustomTime(e.target.value)} /></div>
                                  )}
                              </div>
                          ) : <div className="text-center py-8 bg-gray-50 rounded-xl text-gray-400">æ­¤æ—¥æœŸæœªé–‹æ”¾</div>}
                      </div>
                  )}

                  {step === 4 && (
                      <div className="space-y-6 fade-in">
                          <div className="bg-[#fff8f6] border border-[#f5ebe9] p-5 rounded-xl space-y-3 shadow-sm">
                              <div className="flex justify-between text-sm"><span className="text-gray-500">åœ°é»</span><span className="font-bold">{loc.name}</span></div>
                              <div className="flex justify-between text-sm"><span className="text-gray-500">æ™‚é–“</span><span className="font-bold">{date.toLocaleDateString()} {time==='å¾®èª¿æ™‚æ®µç”³è«‹'?customTime:time}</span></div>
                              <div className="flex justify-between text-sm"><span className="text-gray-500">é …ç›®</span><span className="font-bold">{svcs.map(s=>s.name).join(' + ')} {isTwoPeople && '(å…©äºº)'}</span></div>
                              {adds.length>0 && <div className="flex justify-between text-sm"><span className="text-gray-500">åŠ è³¼</span><span className="font-bold">{adds.map(a=>a.name).join(',')}</span></div>}
                              <div className="flex justify-between text-sm border-t pt-2 mt-2"><span className="text-gray-500">é ä¼°ç¸½é¡</span><span className="font-bold text-[#8d6e63]">${totals.price}</span></div>
                          </div>
                          <div className="space-y-4">
                              <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">å§“å</label><input className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63]" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" value={info.name} onChange={e=>setInfo({...info,name:e.target.value})} /></div>
                              {isTwoPeople && (<div className="fade-in"><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">ç¬¬äºŒä½é¡§å®¢å§“å</label><input className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63]" placeholder="è«‹è¼¸å…¥ç¬¬äºŒä½å§“å" value={info.name2} onChange={e=>setInfo({...info,name2:e.target.value})} /></div>)}
                              <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">é›»è©±</label><input className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63]" type="tel" placeholder="09xx-xxx-xxx" value={info.phone} onChange={e=>setInfo({...info,phone:e.target.value})} /></div>
                              <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">å‚™è¨»</label><textarea className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63] h-24 resize-none" placeholder="éœ€å¸ç”²ã€çš®è†šæ•æ„Ÿ..." value={info.notes} onChange={e=>setInfo({...info,notes:e.target.value})} /></div>
                          </div>
                      </div>
                  )}

                  {step === 5 && (
                      <div className="space-y-6 fade-in">
                          <h2 className="text-xl font-bold text-[#4e342e]">è¨‚é‡‘èªªæ˜</h2>
                          <div className="bg-orange-50 border border-orange-200 p-5 rounded-xl text-sm leading-relaxed text-[#5d4037]">
                              <p className="mb-4 font-bold">ç‚ºä¿ç•™æ‚¨çš„é ç´„æ™‚æ®µï¼Œè«‹é ä»˜è¨‚é‡‘ã€‚</p>
                              <div className="bg-white p-4 rounded-lg border border-orange-100 mb-4">
                                  <p>éŠ€è¡Œï¼š<span className="font-bold">{BANK_INFO.code}</span></p>
                                  <p>å¸³è™Ÿï¼š<span className="font-bold text-lg">{BANK_INFO.account}</span></p>
                                  <p>æˆ¶åï¼š{BANK_INFO.name}</p>
                                  <p className="mt-2 text-red-600 font-bold">è¨‚é‡‘é‡‘é¡ï¼š${BANK_INFO.amount}</p>
                              </div>
                              <p className="text-xs text-gray-500">â€» è«‹æ–¼é ç´„é€å‡ºå¾Œ 24 å°æ™‚å…§å®ŒæˆåŒ¯æ¬¾ï¼Œä¸¦ä½¿ç”¨é¦–é çš„ã€ŒæŸ¥è©¢/å›å ±ã€åŠŸèƒ½ä¸Šå‚³å¸³è™Ÿå¾Œäº”ç¢¼ã€‚</p>
                          </div>
                          <div className="flex items-center gap-2">
                              <input type="checkbox" id="agree" className="w-5 h-5 accent-[#8d6e63]"/>
                              <label htmlFor="agree" className="text-sm">æˆ‘å·²é–±è®€ä¸¦åŒæ„æ”¯ä»˜è¨‚é‡‘è¦å‰‡</label>
                          </div>
                      </div>
                  )}

                  {step === 6 && (
                      <div className="text-center pt-10 fade-in">
                          <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600"><Icon path={Icons.check} size={40}/></div>
                          <h2 className="text-2xl font-bold mb-2 text-[#4e342e]">é ç´„é€å‡ºæˆåŠŸï¼</h2>
                          <p className="text-gray-500 text-sm mb-8">è«‹è¨˜å¾—åŒ¯æ¬¾ä¸¦å›å ±å¾Œäº”ç¢¼ï¼Œæˆ‘å€‘ç¢ºèªå¾Œæœƒç™¼é€é€šçŸ¥ã€‚</p>
                          <button onClick={reset} className="w-full bg-[#8d6e63] text-white py-3 rounded-xl shadow-lg shadow-[#8d6e63]/30">è¿”å›é¦–é </button>
                      </div>
                  )}
              </div>

              {step < 6 && (
                  <div className="p-4 bg-white border-t safe-bottom">
                      <button onClick={()=>{
                          if(step===2 && svcs.length===0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€é …æœå‹™');
                          if(step===3 && !time) return alert('è«‹é¸æ“‡æ™‚é–“');
                          if(step===4 && (!info.name || !info.phone)) return alert('è«‹å¡«å¯«è³‡æ–™');
                          if(step===5 && !document.getElementById('agree').checked) return alert('è«‹å‹¾é¸åŒæ„');
                          if(step===5) handleSubmit(); else setStep(s=>s+1);
                      }} className="w-full bg-[#8d6e63] text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-[#8d6e63]/30 active:scale-[0.98] transition-transform">
                          {step===5 ? 'é€å‡ºé ç´„' : 'ä¸‹ä¸€æ­¥'}
                      </button>
                  </div>
              )}
          </div>
      );
    }

    const StatusCheck = ({ user, onBack }) => {
        const [phone, setPhone] = useState('');
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);
        const [reportId, setReportId] = useState(null);
        const [last5, setLast5] = useState('');

        const search = async () => {
            if(!phone) return alert("è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼");
            setLoading(true);
            try {
                const snap = await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
                    .where('customerPhone', '==', phone).get();
                if (snap.empty) {
                    alert("æŸ¥ç„¡æ­¤é›»è©±çš„é ç´„è³‡æ–™"); setResults([]);
                } else {
                    const data = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    data.sort((a,b) => new Date(b.date) - new Date(a.date));
                    setResults(data);
                }
            } catch(e) { alert("æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤: " + e.message); }
            setLoading(false);
        };

        const submitPayment = async () => {
            if(!last5) return alert('è«‹è¼¸å…¥å¾Œäº”ç¢¼');
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(reportId).update({
                paymentStatus: 'reported', paymentInfo: { last5, at: new Date().toISOString() }
            });
            alert('å›å ±æˆåŠŸï¼ç­‰å¾…åº—å®¶ç¢ºèªã€‚'); setReportId(null); search();
        };

        return (
            <div className="min-h-screen bg-[#f4f1ea] p-4">
                <div className="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <h2 className="font-bold text-lg mb-4 text-[#4e342e]">é ç´„æŸ¥è©¢ / åŒ¯æ¬¾å›å ±</h2>
                    <div className="flex gap-2">
                        <input className="flex-1 p-2 border rounded-lg" placeholder="è«‹è¼¸å…¥é ç´„é›»è©±" value={phone} onChange={e=>setPhone(e.target.value)} />
                        <button onClick={search} className="bg-[#8d6e63] text-white px-4 rounded-lg">{loading?'...':'æŸ¥è©¢'}</button>
                    </div>
                </div>
                <div className="space-y-3">
                    {results.map(r => (
                        <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex justify-between mb-2">
                                <span className="font-bold text-[#8d6e63]">{r.date} {r.time}</span>
                                <span className={`text-xs px-2 py-1 rounded ${r.status==='confirmed'?'bg-green-100 text-green-700':r.status==='cancelled'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{r.status==='confirmed'?'âœ… æˆåŠŸ':r.status==='cancelled'?'âŒ å–æ¶ˆ':'â³ å¾…ç¢ºèª'}</span>
                            </div>
                            <div className="text-sm text-gray-600 mb-2">{r.serviceName} {r.isTwoPeople && '(å…©äºº)'}</div>
                            <div className="text-sm font-bold text-[#5d4037] mb-2">ç¸½é¡ï¼š${r.totalPrice || 0} / è¨‚é‡‘ï¼š${BANK_INFO.amount}</div>
                            
                            <div className="border-t pt-2 flex justify-between items-center mt-2">
                                <span className="text-xs text-gray-500">è¨‚é‡‘ï¼š
                                    {r.paymentStatus==='verified' ? <span className="text-green-600 font-bold"> å·²å…¥å¸³</span> : 
                                     r.paymentStatus==='reported' ? <span className="text-blue-600 font-bold"> å¯©æ ¸ä¸­</span> : 
                                     <span className="text-red-500"> æœªæ”¯ä»˜</span>}
                                </span>
                                {r.paymentStatus === 'unpaid' && r.status !== 'cancelled' && (
                                    <button onClick={()=>setReportId(r.id)} className="text-xs bg-[#8d6e63] text-white px-3 py-1 rounded">å›å ±</button>
                                )}
                            </div>
                            {reportId === r.id && (
                                <div className="mt-3 bg-gray-50 p-3 rounded flex gap-2">
                                    <input className="flex-1 p-1 border rounded text-sm" placeholder="å¸³è™Ÿå¾Œäº”ç¢¼" value={last5} onChange={e=>setLast5(e.target.value)} />
                                    <button onClick={submitPayment} className="bg-blue-600 text-white px-3 text-xs rounded">é€å‡º</button>
                                    <button onClick={()=>setReportId(null)} className="text-gray-400 text-xs">å–æ¶ˆ</button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                <button onClick={onBack} className="mt-6 w-full py-3 text-gray-400 text-sm">è¿”å›é¦–é </button>
            </div>
        )
    }

    const AdminLogin = ({ onBack, onLogin }) => {
        const [pin, setPin] = useState('');
        return <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea] p-6"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center"><h2 className="text-xl font-bold mb-6 text-[#4e342e]">å¾Œå°ç™»å…¥</h2><input type="password" placeholder="PIN" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center text-xl tracking-widest border focus:border-[#8d6e63] outline-none" value={pin} onChange={e=>setPin(e.target.value)} /><div className="grid grid-cols-2 gap-3"><button onClick={onBack} className="py-3 rounded-xl bg-gray-100 text-gray-500">å–æ¶ˆ</button><button onClick={()=>pin===ADMIN_PIN?onLogin():alert('å¯†ç¢¼éŒ¯èª¤')} className="py-3 rounded-xl bg-[#8d6e63] text-white font-bold">ç™»å…¥</button></div></div></div>;
    }

    const AdminPanel = ({ user, settings, onBack, services, addons }) => {
        const [tab, setTab] = useState('book');
        const [books, setBooks] = useState([]);
        const [editDates, setEditDates] = useState({kaohsiung:'', tainan:''});
        const [editSlots, setEditSlots] = useState({kaohsiung:'', tainan:''});
        const [selectedDay, setSelectedDay] = useState(null);
        const [daySlots, setDaySlots] = useState('');
        const [msgModal, setMsgModal] = useState(null); 
        const [templates, setTemplates] = useState(DEFAULT_TEMPLATES);
        const [editMode, setEditMode] = useState(false); // Mode switch for calendar

        const [newSvc, setNewSvc] = useState({name:'', price:'', duration:'90'});
        const [newAddon, setNewAddon] = useState({name:'', price:'', duration:'0'});

        useEffect(() => {
            if(settings.kaohsiung) {
                setEditDates(p => ({...p, kaohsiung: settings.kaohsiung.allowedDates?.join(',') || ''}));
                setEditSlots(p => ({...p, kaohsiung: settings.kaohsiung.timeSlots?.join(',') || ''}));
            }
            if(settings.tainan) {
                setEditDates(p => ({...p, tainan: settings.tainan.allowedDates?.join(',') || ''}));
                setEditSlots(p => ({...p, tainan: settings.tainan.timeSlots?.join(',') || ''}));
            }
            if(settings.templates) setTemplates(settings.templates);
        }, [settings]);

        useEffect(() => {
            db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
              .orderBy('date', 'desc').limit(50).onSnapshot(s => setBooks(s.docs.map(d=>({id:d.id, ...d.data()}))));
        }, []);

        const handleDateClick = (locId, dStr) => {
            if (editMode) {
                setSelectedDay({ locId, date: dStr });
                const special = settings[locId]?.specialRules?.[dStr];
                setDaySlots(special ? special.join(',') : '');
            } else {
                const current = editDates[locId].split(',').filter(x=>x);
                const set = new Set(current);
                if(set.has(dStr)) set.delete(dStr); else set.add(dStr);
                setEditDates({...editDates, [locId]: Array.from(set).sort().join(',')});
            }
        };

        const saveSettings = async (locId) => {
            const data = {
                allowedDates: editDates[locId].split(',').filter(x=>x),
                timeSlots: editSlots[locId].split(',').filter(x=>x),
                specialRules: settings[locId]?.specialRules || {}
            };
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(locId).set(data);
            alert('è¨­å®šå·²å„²å­˜');
        };

        const saveDayRule = async () => {
            if(!selectedDay) return;
            const { locId, date } = selectedDay;
            const currentRules = settings[locId]?.specialRules || {};
            if (!daySlots.trim()) delete currentRules[date]; else currentRules[date] = daySlots.split(',').map(x=>x.trim()).filter(x=>x);
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(locId).update({ specialRules: currentRules });
            alert(`${date} çš„ç‰¹æ®Šæ™‚æ®µå·²å„²å­˜ï¼`); setSelectedDay(null);
        };

        const copyDefaultSlots = (locId) => {
            setDaySlots(editSlots[locId]);
        }

        const saveTemplates = async () => {
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc('templates').set({ templates });
            alert('è¨Šæ¯ç¯„æœ¬å·²å„²å­˜');
        };

        const sendTemplateMsg = async (tpl) => {
            if(!msgModal) return;
            const b = msgModal;
            let text = tpl.text.replace('{{date}}', b.date).replace('{{time}}', b.time).replace('{{location}}', b.locationName).replace('{{service}}', b.serviceName);
            if (window.liff?.isInClient()) { await window.liff.sendMessages([{type:'text', text}]); alert('è¨Šæ¯å·²å‚³é€'); } 
            else { navigator.clipboard.writeText(text); alert('å·²è¤‡è£½è¨Šæ¯ï¼Œè«‹è²¼ä¸Šçµ¦é¡§å®¢'); }
            setMsgModal(null);
        };

        const submitSvc = async () => {
            if(!newSvc.name || !newSvc.price) return;
            if(Number(newSvc.price) < 0) return alert('ä¸»æœå‹™é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸');
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({ name: newSvc.name, price: Number(newSvc.price), duration: Number(newSvc.duration) });
            setNewSvc({name:'', price:'', duration:'90'});
        };
        
        const submitAddon = async () => {
            if(!newAddon.name || !newAddon.price) return;
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('addons').add({ name: newAddon.name, price: Number(newAddon.price), duration: Number(newAddon.duration) });
            setNewAddon({name:'', price:'', duration:'0'});
        };

        const renderCalendar = (locId) => {
            const today = new Date(); const year = today.getFullYear(); const month = today.getMonth();
            const days = new Date(year, month+1, 0).getDate(); const start = new Date(year, month, 1).getDay();
            const selected = new Set(editDates[locId].split(',')); const specialMap = settings[locId]?.specialRules || {};
            return (
                <div className="bg-white p-4 rounded-xl border shadow-sm"><div className="text-center mb-2 font-bold">{year}å¹´ {month+1}æœˆ</div><div className="grid grid-cols-7 gap-2 text-center text-xs">{Array.from({length:start}).map((_,i)=><div key={'e'+i}/>)}{Array.from({length:days}).map((_,i)=>{const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;const hasRule = specialMap[dStr];return (<div key={dStr} onClick={()=>handleDateClick(locId, dStr)} className={`aspect-square flex items-center justify-center rounded-lg cursor-pointer border ${selected.has(dStr)?'bg-[#8d6e63] text-white': hasRule ? 'border-orange-400 bg-orange-50 text-orange-700 date-cell has-rule' : 'border-gray-100 hover:bg-gray-50'}`}>{i+1}</div>)})}</div></div>
            )
        };

        return (
            <div className="min-h-screen bg-gray-50 pb-20">
                <div className="bg-white p-4 sticky top-0 z-20 border-b flex justify-between items-center shadow-sm">
                    <h2 className="font-bold text-lg">å¾Œå°ç®¡ç†</h2>
                    <button onClick={onBack} className="text-sm bg-gray-100 px-3 py-1 rounded">ç™»å‡º</button>
                </div>
                
                <div className="p-4 space-y-6">
                    <div className="flex bg-white p-1 rounded-xl border overflow-x-auto">
                        {['book','msg','set','svc'].map(t => (
                            <button key={t} onClick={()=>setTab(t)} className={`flex-1 py-2 px-2 min-w-[60px] rounded-lg text-sm font-bold ${tab===t?'bg-[#8d6e63] text-white':'text-gray-500'}`}>
                                {t==='book'?'é ç´„':t==='msg'?'è¨Šæ¯':t==='set'?'ç‡Ÿæ¥­':t==='svc'?'æœå‹™':''}
                            </button>
                        ))}
                    </div>

                    {tab === 'book' && (
                        <div className="space-y-4">
                            {books.map(b => (
                                <div key={b.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-sm">
                                    <div className="flex justify-between mb-2">
                                        <div className="font-bold text-lg text-[#8d6e63]">{b.date} {b.time}</div>
                                        <div className={`px-2 py-1 rounded text-xs ${b.status==='confirmed'?'bg-green-100 text-green-700':b.status==='cancelled'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{b.status==='confirmed'?'å·²ç¢ºèª':b.status==='cancelled'?'å·²å–æ¶ˆ':'å¾…ç¢ºèª'}</div>
                                    </div>
                                    <div className="space-y-1 text-gray-600">
                                        <div>{b.locationName}ãƒ»{b.serviceName} {b.isTwoPeople && '(å…©äºº)'}</div>
                                        <div>{b.customerName} ({b.customerPhone})</div>
                                        <div className="text-[#8d6e63] font-bold">ç¸½é¡ï¼š${b.totalPrice}</div>
                                        {b.paymentStatus === 'reported' && <div className="text-blue-600 font-bold bg-blue-50 p-2 rounded">ğŸ’° é¡§å®¢å·²åŒ¯æ¬¾ï¼šå¾Œäº”ç¢¼ {b.paymentInfo?.last5}</div>}
                                        {b.paymentStatus === 'verified' && <div className="text-green-600 font-bold">ğŸ’° è¨‚é‡‘å·²ç¢ºèª</div>}
                                    </div>
                                    <div className="flex gap-2 mt-3 pt-3 border-t">
                                        <button onClick={()=>setMsgModal(b)} className="flex-1 bg-gray-100 py-2 rounded flex items-center justify-center gap-1"><Icon path={Icons.msg} size={16}/> å‚³è¨Š</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({status: 'confirmed'})} className="flex-1 bg-green-50 text-green-700 border border-green-200 py-2 rounded">ç¢ºèª</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({paymentStatus: 'verified'})} className="flex-1 bg-blue-50 text-blue-700 border border-blue-200 py-2 rounded">æ”¶è¨‚</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({status: 'cancelled'})} className="px-3 text-red-400 border border-red-200 rounded">âŒ</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'msg' && (
                        <div className="space-y-4">
                            <h3 className="font-bold text-[#4e342e]">å¸¸ç”¨å›è¦†è¨­å®š</h3>
                            {templates.map((tpl, i) => (
                                <div key={i} className="bg-white p-3 rounded-lg border">
                                    <input className="font-bold w-full mb-2 p-1 border-b" value={tpl.title} onChange={e=>{ const newT = [...templates]; newT[i].title = e.target.value; setTemplates(newT); }} />
                                    <textarea className="w-full text-sm p-2 bg-gray-50 rounded h-24" value={tpl.text} onChange={e=>{ const newT = [...templates]; newT[i].text = e.target.value; setTemplates(newT); }} />
                                </div>
                            ))}
                            <button onClick={saveTemplates} className="w-full bg-[#8d6e63] text-white py-3 rounded-xl shadow">å„²å­˜æ‰€æœ‰è¨Šæ¯è¨­å®š</button>
                        </div>
                    )}

                    {msgModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-xl p-4">
                                <h3 className="font-bold mb-4">é¸æ“‡å‚³é€è¨Šæ¯</h3>
                                <div className="space-y-2">{templates.map((t,i) => (<button key={i} onClick={()=>sendTemplateMsg(t)} className="w-full text-left p-3 border rounded hover:bg-gray-50"><div className="font-bold text-[#5d4037]">{t.title}</div><div className="text-xs text-gray-400 truncate">{t.text}</div></button>))}</div>
                                <button onClick={()=>setMsgModal(null)} className="mt-4 w-full py-2 text-gray-400">å–æ¶ˆ</button>
                            </div>
                        </div>
                    )}

                    {tab === 'set' && (
                        <div className="space-y-6">
                            <div className="flex items-center gap-2 mb-4 bg-yellow-50 p-2 rounded text-sm text-yellow-800">
                                <button onClick={()=>setEditMode(!editMode)} className={`w-10 h-6 rounded-full flex items-center p-1 transition-colors ${editMode?'bg-yellow-500 justify-end':'bg-gray-300'}`}>
                                    <div className="w-4 h-4 bg-white rounded-full"></div>
                                </button>
                                <span>{editMode ? 'âœï¸ æ¨¡å¼ï¼šè¨­å®šå–®æ—¥ç‰¹æ®Šæ™‚æ®µ (é»æ“Šæ—¥æœŸç·¨è¼¯)' : 'ğŸ‘† æ¨¡å¼ï¼šå¿«é€Ÿé–‹é—œæ—¥æœŸ (é»æ“Šåˆ‡æ›)'}</span>
                            </div>

                            {['kaohsiung','tainan'].map(locId => (
                                <div key={locId} className="border p-4 rounded-xl bg-white">
                                    <h3 className="font-bold mb-2 capitalize">{locId} è¨­å®š</h3>
                                    {renderCalendar(locId)}
                                    <div className="mt-2 text-xs text-gray-400 text-center">
                                        {editMode ? 'é»æ“Šæ—¥æœŸå¯è¨­å®šç•¶å¤©å°ˆå±¬ç‡Ÿæ¥­æ™‚é–“' : 'é»æ“Šæ—¥æœŸå¯å¿«é€Ÿ é–‹æ”¾ / é—œé–‰ é ç´„'}
                                    </div>
                                    {!editMode && (
                                        <div className="mt-4">
                                            <label className="text-xs font-bold block mb-1">é è¨­æ™‚æ®µ (å…¨åŸŸ)</label>
                                            <input className="w-full border p-2 rounded text-sm" value={editSlots[locId]} onChange={e=>setEditSlots({...editSlots, [locId]:e.target.value})} />
                                            <button onClick={()=>saveSettings(locId)} className="mt-2 w-full bg-[#8d6e63] text-white py-2 rounded text-sm">å„²å­˜åŸºæœ¬è¨­å®š</button>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {selectedDay && (
                                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                    <div className="bg-white w-full max-w-sm rounded-xl p-6">
                                        <h3 className="font-bold mb-4 text-lg border-b pb-2">{selectedDay.date} ç‰¹æ®Šè¨­å®š</h3>
                                        <p className="text-sm text-gray-500 mb-2">åœ¨æ­¤è¼¸å…¥è©²æ—¥çš„ç‰¹æ®Šç‡Ÿæ¥­æ™‚é–“ï¼Œç•™ç©ºå‰‡ä¾é è¨­è¦å‰‡æˆ–é—œé–‰ã€‚</p>
                                        
                                        <div className="flex gap-2 mb-2">
                                            <button onClick={()=>copyDefaultSlots(selectedDay.locId)} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200 flex items-center gap-1">
                                                <Icon path={Icons.zap} size={12}/> å¸¶å…¥é è¨­æ™‚æ®µ
                                            </button>
                                        </div>

                                        <input className="w-full border p-3 rounded mb-4" placeholder="ä¾‹å¦‚: 10:00, 14:00" value={daySlots} onChange={e=>setDaySlots(e.target.value)} />
                                        <div className="flex gap-2">
                                            <button onClick={()=>setSelectedDay(null)} className="flex-1 py-2 bg-gray-100 rounded">å–æ¶ˆ</button>
                                            <button onClick={saveDayRule} className="flex-1 py-2 bg-[#8d6e63] text-white rounded">å„²å­˜å–®æ—¥</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {tab === 'svc' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border"><h3 className="font-bold mb-3 text-[#4e342e]">æ–°å¢æœå‹™</h3><div className="space-y-2"><input className="w-full border p-2 rounded text-sm" placeholder="åç¨±" value={newSvc.name} onChange={e=>setNewSvc({...newSvc, name:e.target.value})} /><div className="flex gap-2"><input type="number" min="0" className="flex-1 border p-2 rounded text-sm" placeholder="åƒ¹æ ¼ (é™æ­£æ•¸)" value={newSvc.price} onChange={e=>setNewSvc({...newSvc, price:e.target.value})} /><input type="number" className="w-24 border p-2 rounded text-sm" placeholder="åˆ†é˜" value={newSvc.duration} onChange={e=>setNewSvc({...newSvc, duration:e.target.value})} /></div><button onClick={submitSvc} className="w-full bg-[#8d6e63] text-white py-2 rounded text-sm flex items-center justify-center gap-1"><Icon path={Icons.plus} size={16}/> æ–°å¢</button></div><div className="mt-4 border-t pt-4 space-y-2">{services.map(s=><div key={s.id} className="flex justify-between text-sm p-2 border rounded bg-gray-50"><span>{s.name} (${s.price}) {s.duration}åˆ†</span><button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-400"><Icon path={Icons.trash} size={16}/></button></div>)}</div></div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border"><h3 className="font-bold mb-3 text-[#4e342e]">æ–°å¢åŠ è³¼</h3><div className="space-y-2"><input className="w-full border p-2 rounded text-sm" placeholder="åç¨±" value={newAddon.name} onChange={e=>setNewAddon({...newAddon, name:e.target.value})} /><div className="flex gap-2"><input type="number" className="flex-1 border p-2 rounded text-sm" placeholder="åƒ¹æ ¼ (å¯è² æ•¸)" value={newAddon.price} onChange={e=>setNewAddon({...newAddon, price:e.target.value})} /><input type="number" className="w-24 border p-2 rounded text-sm" placeholder="åˆ†é˜" value={newAddon.duration} onChange={e=>setNewAddon({...newAddon, duration:e.target.value})} /></div><button onClick={submitAddon} className="w-full bg-[#8d6e63] text-white py-2 rounded text-sm flex items-center justify-center gap-1"><Icon path={Icons.plus} size={16}/> æ–°å¢</button></div><div className="mt-4 border-t pt-4 space-y-2">{addons.map(a=><div key={a.id} className="flex justify-between text-sm p-2 border rounded bg-gray-50"><span>{a.name} ({a.price > 0 ? '+' : ''}${a.price})</span><button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('addons').doc(a.id).delete()} className="text-red-400"><Icon path={Icons.trash} size={16}/></button></div>)}</div></div>
                        </div>
                    )}
                </div>
            </div>
        )
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
