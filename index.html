<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM Studio ç·šä¸Šé ç´„</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #fdfbf7; color: #5d4037; }
    
    .option-card { transition: all 0.2s; border: 2px solid #e5e7eb; }
    .option-card:hover { border-color: #d7ccc8; }
    .option-card.active { border-color: #8d6e63; background-color: #efebe9; color: #3e2723; }
    
    .guest-block { border-left: 4px solid #8d6e63; padding-left: 1rem; margin-bottom: 2rem; }
    
    .spinner {
      border: 3px solid #f3f3f3; border-top: 3px solid #8d6e63; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .date-cell.selected { background-color: #8d6e63; color: white; font-weight: bold; }
    .date-cell.has-rule { border-bottom: 2px solid #d97706; }
  </style>

  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #8d6e63;">
      <div class="spinner"></div>
      <p id="loading-text">ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>
  </div>

  <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; padding:20px; text-align:center;">
    <div style="max-width:500px; margin:50px auto; border:2px solid #ef4444; padding:20px; background:#fff; border-radius:8px;">
        <h2 style="color:#ef4444; font-size:24px; margin-bottom:10px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="error-msg" style="color:#333; margin-bottom:20px; word-break:break-all;"></p>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#8d6e63; color:white; border:none; border-radius:4px;">é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <script>
    window.onerror = function(msg, url, line) {
      document.getElementById('root').style.display = 'none';
      document.getElementById('error-box').style.display = 'block';
      document.getElementById('error-msg').innerHTML = `<strong>åŸå› ï¼š</strong>${msg}<br><br><small>(${url}:${line})</small>`;
      return false;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    const LIFF_ID = '2008567948-KGMPJPGe'; 
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';
    
    const BANK_INFO = { code: '822 (ä¸­åœ‹ä¿¡è¨—)', account: '1234-5678-9012', name: 'AM Studio', amountPerPerson: 1000 };

    // --- Categories Definition ---
    const MAIN_CATS = ["éœ§çœ‰", "éœ§å”‡", "(çƒå”‡)æ·¡è‰²éœ§å”‡"];
    const SUB_CATS = ["é¦–æ¬¡", "è£œè‰²"];
    const DETAILS = ["ç¬¬ä¸€æ¬¡è£œè‰²", "ç¬¬äºŒæ¬¡è£œè‰²"];

    // --- Init ---
    let db, auth;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.error(e); }

    // --- Icons ---
    const Icon = ({ path, size = 20, className="" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );
    const Icons = {
        map: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
        user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
        chevronRight: <path d="m9 18 6-6-6-6"/>,
        chevronLeft: <path d="m15 18-6-6 6-6"/>,
        check: <polyline points="20 6 9 17 4 12"/>,
        settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
        trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
        plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
        msg: <><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>,
        search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
        edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
        zap: <><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></>,
        tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>
    };

    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }
    ];
    const DEFAULT_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    
    const DEFAULT_TEMPLATES = [
        { title: 'é ç´„ç¢ºèª', text: 'æ‚¨å¥½ï¼Œæ‚¨çš„é ç´„å·²ç¢ºèªï¼\næ™‚é–“ï¼š{{date}} {{time}}\nåœ°é»ï¼š{{location}}\næœå‹™ï¼š{{service}}\næœŸå¾…æ‚¨çš„å…‰è‡¨ã€‚' },
        { title: 'è¨‚é‡‘å‚¬æ”¶', text: 'æ‚¨å¥½ï¼Œæé†’æ‚¨å°šæœªæ”¯ä»˜è¨‚é‡‘ã€‚\nè«‹åŒ¯æ¬¾è‡³ï¼š822 (ä¸­åœ‹ä¿¡è¨—) 1234-5678-9012\né‡‘é¡ï¼š$1000\nåŒ¯æ¬¾å¾Œè«‹è‡³æŸ¥è©¢é é¢å›å ±ï¼Œè¬è¬ï¼' },
        { title: 'å·²æ”¶è¨‚é‡‘', text: 'æ‚¨å¥½ï¼Œå·²æ”¶åˆ°æ‚¨çš„è¨‚é‡‘åŒ¯æ¬¾ï¼Œé ç´„æ­£å¼ä¿ç•™ã€‚æ„Ÿè¬æ‚¨ï¼' },
        { title: 'é ç´„å–æ¶ˆ', text: 'æ‚¨å¥½ï¼Œæ‚¨çš„é ç´„å·²å–æ¶ˆã€‚è‹¥æœ‰éœ€è¦è«‹å†æ¬¡é ç´„ï¼Œè¬è¬ã€‚' }
    ];

    // --- Components (Defined before App) ---
    
    const ServiceSelector = ({ services, onSelect }) => {
        const [stage, setStage] = useState('main'); 
        const [mainCat, setMainCat] = useState(null);
        const [subCat, setSubCat] = useState(null);

        const handleMain = (c) => { setMainCat(c); setStage('sub'); };
        const handleSub = (t) => { 
            setSubCat(t); 
            if(t === 'è£œè‰²') setStage('detail');
            else {
                const target = services.find(s => s.category === mainCat && s.type === t);
                if(target) onSelect(target); else alert('æŸ¥ç„¡æ­¤æœå‹™è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
            }
        };
        const handleDetail = (d) => {
            const target = services.find(s => s.category === mainCat && s.type === subCat && s.detail === d);
            if(target) onSelect(target); else alert('æŸ¥ç„¡æ­¤æœå‹™è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
        };

        const BackBtn = () => (
            <button onClick={()=>setStage(stage==='detail'?'sub':'main')} className="mb-2 text-sm text-[#8d6e63] flex items-center gap-1">
                <Icon path={Icons.chevronLeft} size={16}/> ä¸Šä¸€æ­¥
            </button>
        );

        if(stage === 'main') return (
            <div className="grid gap-2 animate-fade-in">
                {MAIN_CATS.map(c => <button key={c} onClick={()=>handleMain(c)} className="p-4 border rounded-xl text-left font-bold hover:bg-[#efebe9] hover:border-[#8d6e63] bg-white transition-all">{c}</button>)}
            </div>
        );
        if(stage === 'sub') return (
            <div className="animate-fade-in">
                <BackBtn/>
                <h3 className="font-bold mb-2">{mainCat} - é¸æ“‡é¡å‹</h3>
                <div className="grid gap-2">
                    {SUB_CATS.map(t => <button key={t} onClick={()=>handleSub(t)} className="p-4 border rounded-xl text-left hover:bg-[#efebe9] hover:border-[#8d6e63] bg-white transition-all">{t}</button>)}
                </div>
            </div>
        );
        if(stage === 'detail') return (
            <div className="animate-fade-in">
                <BackBtn/>
                <h3 className="font-bold mb-2">{mainCat} - {subCat}</h3>
                <div className="grid gap-2">
                    {DETAILS.map(d => <button key={d} onClick={()=>handleDetail(d)} className="p-4 border rounded-xl text-left hover:bg-[#efebe9] hover:border-[#8d6e63] bg-white transition-all">{d}</button>)}
                </div>
            </div>
        );
    };

    const StatusCheck = ({ user, onBack }) => {
        const [phone, setPhone] = useState('');
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);
        const [reportId, setReportId] = useState(null);
        const [last5, setLast5] = useState('');

        const search = async () => {
            if(!phone) return alert("è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼");
            setLoading(true);
            try {
                const snap = await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
                    .where('customerPhone', '==', phone).get();
                if (snap.empty) {
                    alert("æŸ¥ç„¡æ­¤é›»è©±çš„é ç´„è³‡æ–™"); setResults([]);
                } else {
                    const data = snap.docs.map(d=>({id:d.id, ...d.data()}));
                    data.sort((a,b) => new Date(b.date) - new Date(a.date));
                    setResults(data);
                }
            } catch(e) { alert("æŸ¥è©¢ç™¼ç”ŸéŒ¯èª¤: " + e.message); }
            setLoading(false);
        };

        const submitPayment = async () => {
            if(!last5) return alert('è«‹è¼¸å…¥å¾Œäº”ç¢¼');
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(reportId).update({
                paymentStatus: 'reported', paymentInfo: { last5, at: new Date().toISOString() }
            });
            alert('å›å ±æˆåŠŸï¼ç­‰å¾…åº—å®¶ç¢ºèªã€‚'); setReportId(null); search();
        };

        return (
            <div className="min-h-screen bg-[#f4f1ea] p-4">
                <div className="bg-white p-4 rounded-xl shadow-sm mb-4">
                    <h2 className="font-bold text-lg mb-4 text-[#4e342e]">é ç´„æŸ¥è©¢ / åŒ¯æ¬¾å›å ±</h2>
                    <div className="flex gap-2">
                        <input className="flex-1 p-2 border rounded-lg" placeholder="è«‹è¼¸å…¥é ç´„é›»è©±" value={phone} onChange={e=>setPhone(e.target.value)} />
                        <button onClick={search} className="bg-[#8d6e63] text-white px-4 rounded-lg">{loading?'...':'æŸ¥è©¢'}</button>
                    </div>
                </div>
                <div className="space-y-3">
                    {results.map(r => (
                        <div key={r.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <div className="flex justify-between mb-2">
                                <span className="font-bold text-[#8d6e63]">{r.date} {r.time}</span>
                                <span className={`text-xs px-2 py-1 rounded ${r.status==='confirmed'?'bg-green-100 text-green-700':r.status==='cancelled'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700'}`}>{r.status==='confirmed'?'âœ… æˆåŠŸ':r.status==='cancelled'?'âŒ å–æ¶ˆ':'â³ å¾…ç¢ºèª'}</span>
                            </div>
                            <div className="text-sm text-gray-600 mb-2">{r.serviceName} {r.guestIndex && `(ç¬¬${r.guestIndex}ä½)`}</div>
                            <div className="text-sm font-bold text-[#5d4037] mb-2">
                                è¨‚é‡‘ï¼š${BANK_INFO.amountPerPerson}
                            </div>
                            <div className="border-t pt-2 flex justify-between items-center mt-2">
                                <span className="text-xs text-gray-500">ç‹€æ…‹ï¼š{r.paymentStatus==='verified' ? <span className="text-green-600 font-bold">å·²å…¥å¸³</span> : r.paymentStatus==='reported' ? <span className="text-blue-600 font-bold">å¯©æ ¸ä¸­</span> : <span className="text-red-500">æœªæ”¯ä»˜</span>}</span>
                                {r.paymentStatus === 'unpaid' && r.status !== 'cancelled' && (<button onClick={()=>setReportId(r.id)} className="text-xs bg-[#8d6e63] text-white px-3 py-1 rounded">å›å ±</button>)}
                            </div>
                            {reportId === r.id && (
                                <div className="mt-3 bg-gray-50 p-3 rounded flex gap-2">
                                    <input className="flex-1 p-1 border rounded text-sm" placeholder="å¸³è™Ÿå¾Œäº”ç¢¼" value={last5} onChange={e=>setLast5(e.target.value)} />
                                    <button onClick={submitPayment} className="bg-blue-600 text-white px-3 text-xs rounded">é€å‡º</button>
                                    <button onClick={()=>setReportId(null)} className="text-gray-400 text-xs">å–æ¶ˆ</button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
                <button onClick={onBack} className="mt-6 w-full py-3 text-gray-400 text-sm">è¿”å›é¦–é </button>
            </div>
        )
    }

    const AdminLogin = ({ onBack, onLogin }) => {
        const [pin, setPin] = useState('');
        return <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea] p-6"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center"><h2 className="text-xl font-bold mb-6 text-[#4e342e]">å¾Œå°ç™»å…¥</h2><input type="password" placeholder="PIN" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center text-xl tracking-widest border focus:border-[#8d6e63] outline-none" value={pin} onChange={e=>setPin(e.target.value)} /><div className="grid grid-cols-2 gap-3"><button onClick={onBack} className="py-3 rounded-xl bg-gray-100 text-gray-500">å–æ¶ˆ</button><button onClick={()=>pin===ADMIN_PIN?onLogin():alert('å¯†ç¢¼éŒ¯èª¤')} className="py-3 rounded-xl bg-[#8d6e63] text-white font-bold">ç™»å…¥</button></div></div></div>;
    }

    const AdminPanel = ({ user, settings, onBack, services, addons, discounts }) => {
        const [tab, setTab] = useState('svc');
        const [newSvc, setNewSvc] = useState({ cat: MAIN_CATS[0], type: SUB_CATS[0], detail: '', price: '', duration: '90' });
        
        const [newDiscName, setNewDiscName] = useState('');
        const [newDiscAmount, setNewDiscAmount] = useState('200');

        const submitSvcV23 = async () => {
            if(!newSvc.price) return;
            let name = `${newSvc.cat} - ${newSvc.type}`;
            if(newSvc.type === 'è£œè‰²' && newSvc.detail) name += ` (${newSvc.detail})`;
            
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({
                name: name,
                category: newSvc.cat,
                type: newSvc.type,
                detail: newSvc.detail,
                price: Number(newSvc.price),
                duration: Number(newSvc.duration)
            });
            alert('æœå‹™å·²æ–°å¢');
        };

        const initV23Data = async () => {
            if(!confirm('é€™å°‡æœƒæ–°å¢ç¯„ä¾‹è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
            const batch = db.batch();
            
            const sCol = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services');
            const samples = [
                { category: 'éœ§çœ‰', type: 'é¦–æ¬¡', detail: '', price: 6000, duration: 120 },
                { category: 'éœ§çœ‰', type: 'è£œè‰²', detail: '6å€‹æœˆå…§è£œè‰²', price: 3000, duration: 90 },
                { category: 'éœ§å”‡', type: 'é¦–æ¬¡', detail: '', price: 8000, duration: 150 },
            ];
            samples.forEach(s => {
                const ref = sCol.doc();
                batch.set(ref, { ...s, name: `${s.category} - ${s.type} ${s.detail || ''}` });
            });

            const dCol = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('discounts');
            const dSamples = [{ name: 'é†«è­·äººå“¡', amount: 200 }, { name: 'å­¸ç”Ÿ', amount: 200 }, { name: 'è»å…¬æ•™', amount: 200 }, { name: 'èˆŠå®¢æ¨è–¦', amount: 200 }, { name: 'ç•¶æœˆå£½æ˜Ÿ', amount: 200 }];
            dSamples.forEach(d => { const ref = dCol.doc(); batch.set(ref, d); });

            await batch.commit();
            alert('ç¯„ä¾‹è³‡æ–™å·²å»ºç«‹');
        };
        
        const addDiscount = async () => {
            if(!newDiscName) return;
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('discounts').add({ name: newDiscName, amount: Number(newDiscAmount) });
            setNewDiscName('');
        };

        return (
            <div className="min-h-screen bg-gray-50 p-4">
                <div className="bg-white p-4 sticky top-0 border-b flex justify-between items-center shadow-sm mb-4">
                    <h2 className="font-bold">å¾Œå°ç®¡ç† (V25)</h2>
                    <button onClick={onBack} className="text-sm bg-gray-100 px-3 py-1 rounded">é›¢é–‹</button>
                </div>
                
                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button onClick={()=>setTab('svc')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='svc'?'bg-[#8d6e63] text-white':'bg-white'}`}>æœå‹™é …ç›®</button>
                    <button onClick={()=>setTab('disc')} className={`px-4 py-2 rounded whitespace-nowrap ${tab==='disc'?'bg-[#8d6e63] text-white':'bg-white'}`}>æŠ˜æ‰£è¨­å®š</button>
                </div>

                {tab === 'svc' && (
                    <div className="space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-[#4e342e]">æ–°å¢æœå‹™ (å±¤ç´šå¼)</h3>
                                <button onClick={initV23Data} className="text-xs text-blue-500 underline">âš¡ é‡ç½®ç‚º V25 é è¨­è³‡æ–™</button>
                            </div>
                            <div className="space-y-3">
                                <select className="w-full border p-2 rounded" value={newSvc.cat} onChange={e=>setNewSvc({...newSvc, cat:e.target.value})}>
                                    {MAIN_CATS.map(c=><option key={c} value={c}>{c}</option>)}
                                </select>
                                <select className="w-full border p-2 rounded" value={newSvc.type} onChange={e=>setNewSvc({...newSvc, type:e.target.value})}>
                                    {SUB_CATS.map(c=><option key={c} value={c}>{c}</option>)}
                                </select>
                                {newSvc.type === 'è£œè‰²' && (
                                    <select className="w-full border p-2 rounded" value={newSvc.detail} onChange={e=>setNewSvc({...newSvc, detail:e.target.value})}>
                                        <option value="">è«‹é¸æ“‡è£œè‰²æ™‚æ®µ</option>
                                        {DETAILS.map(c=><option key={c} value={c}>{c}</option>)}
                                    </select>
                                )}
                                <div className="flex gap-2">
                                    <input type="number" className="flex-1 border p-2 rounded" placeholder="åƒ¹æ ¼" value={newSvc.price} onChange={e=>setNewSvc({...newSvc, price:e.target.value})}/>
                                    <input type="number" className="w-24 border p-2 rounded" placeholder="åˆ†é˜" value={newSvc.duration} onChange={e=>setNewSvc({...newSvc, duration:e.target.value})}/>
                                </div>
                                <button onClick={submitSvcV23} className="w-full bg-[#8d6e63] text-white py-2 rounded">æ–°å¢</button>
                            </div>

                            <div className="mt-6 border-t pt-4">
                                <h4 className="font-bold text-sm text-gray-500 mb-2">ç¾æœ‰æœå‹™åˆ—è¡¨</h4>
                                <div className="space-y-2">
                                    {services.map(s=>(
                                        <div key={s.id} className="flex justify-between p-2 border rounded bg-gray-50 text-sm">
                                            <span>{s.category} > {s.type} {s.detail} (${s.price})</span>
                                            <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-400"><Icon path={Icons.trash} size={14}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {tab === 'disc' && (
                    <div className="space-y-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border">
                            <h3 className="font-bold text-[#4e342e] mb-4">å„ªæƒ èº«ä»½ç®¡ç†</h3>
                            <div className="flex gap-2 mb-4">
                                <input className="flex-1 border p-2 rounded" placeholder="èº«ä»½åç¨± (å¦‚: å­¸ç”Ÿ)" value={newDiscName} onChange={e=>setNewDiscName(e.target.value)}/>
                                <input className="w-24 border p-2 rounded" type="number" placeholder="æŠ˜æŠµé¡" value={newDiscAmount} onChange={e=>setNewDiscAmount(e.target.value)}/>
                                <button onClick={addDiscount} className="bg-[#8d6e63] text-white px-4 rounded">æ–°å¢</button>
                            </div>
                            <div className="space-y-2">
                                {discounts.map(d => (
                                    <div key={d.id} className="flex justify-between p-3 border rounded bg-gray-50">
                                        <span>{d.name} (æŠ˜æŠµ ${d.amount})</span>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('discounts').doc(d.id).delete()} className="text-red-400"><Icon path={Icons.trash}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // --- Main App (V25) ---
    function App() {
      const [user, setUser] = useState(null);
      const [page, setPage] = useState('home'); 
      const [step, setStep] = useState(1);
      const [loc, setLoc] = useState(null);
      
      // guests: { id, services, addons, time, customTime, name, phone, discount: null }
      const [guests, setGuests] = useState([{ id: 1, services: [], addons: [], time: null, customTime: '', name: '', phone: '', discount: null }]);
      
      const [date, setDate] = useState(new Date());
      const [info, setInfo] = useState({notes:''});
      const [isTwoPeople, setIsTwoPeople] = useState(false);
      const [lastOrder, setLastOrder] = useState(null);

      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [discounts, setDiscounts] = useState([]);
      const [settings, setSettings] = useState({});
      const [booked, setBooked] = useState([]);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('p') === 'check') setPage('check-status');
        auth.signInAnonymously().catch(e => console.warn(e));
        if (window.liff) window.liff.init({ liffId: LIFF_ID });
        return auth.onAuthStateChanged(setUser);
      }, []);

      useEffect(() => {
        if (!user) return;
        const pub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        pub.collection('services').onSnapshot(s => setServices(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('addons').onSnapshot(s => setAddons(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('discounts').onSnapshot(s => setDiscounts(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('settings').onSnapshot(s => { 
            const obj = {}; s.forEach(d => obj[d.id] = d.data()); setSettings(obj); 
        });
      }, [user]);

      useEffect(() => {
        if (!loc || !date) return;
        const dStr = date.toISOString().split('T')[0];
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', loc.id).where('date', '==', dStr)
          .onSnapshot(s => setBooked(s.docs.map(d => d.data().time)));
      }, [loc, date]);

      const isDateOpen = (d) => {
          if (!loc) return true;
          const conf = settings[loc.id];
          if (!conf?.allowedDates?.length) return true;
          return conf.allowedDates.includes(d.toISOString().split('T')[0]);
      };
      
      const getSlots = (d) => {
          if (!loc) return DEFAULT_SLOTS;
          const dStr = d.toISOString().split('T')[0];
          const conf = settings[loc.id];
          if (conf?.specialRules && conf.specialRules[dStr]) return conf.specialRules[dStr];
          return conf?.timeSlots?.length ? conf.timeSlots : DEFAULT_SLOTS;
      };

      // Actions
      const addGuest = () => setGuests([...guests, { id: Date.now(), services: [], addons: [], time: null, customTime: '', name: '', phone: '', discount: null }]);
      const removeGuest = (idx) => { const g = [...guests]; g.splice(idx, 1); setGuests(g); };
      const updateGuest = (idx, field, val) => { const g = [...guests]; g[idx][field] = val; setGuests(g); };
      
      const addServiceToGuest = (idx, s) => {
          const g = [...guests];
          if(!g[idx].services.find(item=>item.id===s.id)) {
              g[idx].services.push(s);
              setGuests(g);
          }
      };
      const removeServiceFromGuest = (idx, sId) => {
          const g = [...guests];
          g[idx].services = g[idx].services.filter(s => s.id !== sId);
          setGuests(g);
      };
      const toggleGuestAddon = (idx, ad) => {
          const g = [...guests];
          const has = g[idx].addons.find(a=>a.id===ad.id);
          g[idx].addons = has ? g[idx].addons.filter(a=>a.id!==ad.id) : [...g[idx].addons, ad];
          setGuests(g);
      };

      const calculateTotal = () => {
          let total = 0;
          guests.forEach(g => {
              g.services.forEach(s => total += s.price);
              g.addons.forEach(a => total += a.price);
              // V25 Logic: Identity Discount
              const isTouchUp = g.services.some(s => s.type === 'è£œè‰²');
              if (g.discount) {
                  // å¦‚æœæ˜¯è£œè‰²ï¼Œåªå…è¨±ç•¶æœˆå£½æ˜Ÿ
                  if (isTouchUp && !g.discount.name.includes('å£½æ˜Ÿ')) {
                      // ä¸æ‰£æ¬¾
                  } else {
                      total -= g.discount.amount;
                  }
              }
          });
          
          // V25 Logic: Two People Discount
          if (isTwoPeople) {
             // è¦å‰‡ï¼šå…©äººåŒè¡Œï¼Œæ¯äººæŠ˜200ï¼Œä½†è£œè‰²è€…ä¸æŠ˜
             guests.forEach(g => {
                 const isTouchUp = g.services.some(s => s.type === 'è£œè‰²');
                 if (!isTouchUp) {
                     total -= 200;
                 }
             });
          }
          return total;
      };

      const handleSubmit = async () => {
          if (!user) return alert('é€£ç·šä¸­...');
          
          const batch = db.batch();
          const dStr = date.toISOString().split('T')[0];
          const groupId = Date.now().toString(); 
          const totalP = calculateTotal();
          const newOrders = [];

          try {
              guests.forEach((g, idx) => {
                  const tVal = g.time === 'å¾®èª¿æ™‚æ®µç”³è«‹' ? `å¾®èª¿ ${g.customTime}` : g.time;
                  const svcNames = g.services.map(s=>s.name).join('+');
                  const discountName = g.discount ? g.discount.name : '';
                  
                  const orderRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc();
                  const orderData = {
                      locationId: loc.id, locationName: loc.name,
                      serviceId: g.services.map(s=>s.id), serviceName: svcNames,
                      addons: g.addons, 
                      date: dStr, time: tVal,
                      customerName: g.name, customerPhone: g.phone,
                      notes: info.notes,
                      discountIdentity: discountName, 
                      groupId, guestIndex: idx + 1,
                      totalPrice: totalP, 
                      status: 'pending', paymentStatus: 'unpaid', msgSent: false,
                      createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
                  };
                  batch.set(orderRef, orderData);
                  newOrders.push(orderData);
              });

              await batch.commit();
              setLastOrders(newOrders);
              
              const deposit = guests.length * BANK_INFO.amountPerPerson;
              const reportLink = `https://liff.line.me/${LIFF_ID}?p=check`;
              const msg = `ã€é ç´„ç”³è«‹é€šçŸ¥ã€‘\nğŸ“ ${loc.name}\nğŸ“… ${dStr}\nğŸ‘¤ äººæ•¸ï¼š${guests.length}ä½\nğŸ’° ç¸½é‡‘é¡ï¼š$${totalP}\nâš ï¸ è¨‚é‡‘ï¼š$${deposit} (æ¯äºº$${BANK_INFO.amountPerPerson})\n\nğŸ”— å›å ±åŒ¯æ¬¾ï¼š\n${reportLink}`;
              
              if (window.liff?.isInClient()) {
                  try { await window.liff.sendMessages([{ type: 'text', text: msg }]); } catch (err) {}
              } else {
                  alert("é ç´„å·²é€å‡ºï¼\nè«‹è¤‡è£½é€£çµå›å ±åŒ¯æ¬¾ï¼š\n" + reportLink);
              }
              setStep(6);
          } catch (e) { alert('Error: ' + e.message); }
      };

      const reset = () => {
          setStep(1); setLoc(null); setGuests([{ id: 1, services: [], addons: [], time: null, customTime: '', name: '', phone: '', discount: null }]);
          setInfo({notes:''}); setPage('home');
      };

      if (page === 'admin-login') return <AdminLogin onBack={()=>setPage('home')} onLogin={()=>setPage('admin')} />;
      if (page === 'admin') return <AdminPanel user={user} settings={settings} onBack={()=>setPage('home')} services={services} addons={addons} discounts={discounts} />;
      if (page === 'check-status') return <StatusCheck user={user} onBack={()=>setPage('home')} />;

      if (page === 'home') {
          return (
              <div className="min-h-screen flex flex-col items-center justify-center p-6 relative">
                  <button onClick={()=>setPage('admin-login')} className="absolute top-4 left-4 p-2 text-gray-300 hover:text-gray-500"><Icon path={Icons.settings}/></button>
                  <div className="max-w-md w-full text-center space-y-8">
                      <div><h1 className="text-4xl font-bold tracking-widest text-[#4e342e] mb-2">AM Studio</h1><p className="text-[#8d6e63] tracking-wider">ç·šä¸Šé ç´„ç³»çµ±</p></div>
                      <div className="grid gap-4">
                          {LOCATIONS.map(l => (
                              <button key={l.id} onClick={()=>{setLoc(l); setPage('booking'); setStep(2);}} className="group bg-white border-2 border-[#e5e7eb] hover:border-[#8d6e63] p-6 rounded-xl flex items-center justify-between transition-all shadow-sm hover:shadow-md">
                                  <div className="flex items-center gap-4"><div className="w-12 h-12 bg-[#efebe9] rounded-full flex items-center justify-center text-[#5d4037] group-hover:bg-[#8d6e63] group-hover:text-white transition-colors"><Icon path={Icons.map} size={24}/></div><div className="text-left"><h3 className="text-lg font-bold text-[#4e342e]">{l.name}</h3><p className="text-xs text-gray-400">ç«‹å³é ç´„</p></div></div>
                                  <div className="text-gray-300 group-hover:text-[#8d6e63]"><Icon path={Icons.chevronRight}/></div>
                              </button>
                          ))}
                          <button onClick={()=>setPage('check-status')} className="w-full bg-white border border-[#d7ccc8] text-[#8d6e63] p-4 rounded-xl flex items-center justify-center gap-2 hover:bg-[#efebe9]"><Icon path={Icons.search} size={18}/> æŸ¥è©¢é ç´„ / å›å ±åŒ¯æ¬¾</button>
                      </div>
                  </div>
              </div>
          );
      }

      const depositTotal = guests.length * BANK_INFO.amountPerPerson;

      // Booking Flow
      return (
          <div className="min-h-screen bg-white md:bg-[#f4f1ea] flex flex-col">
              <div className="bg-white p-4 sticky top-0 z-10 border-b flex items-center justify-between shadow-sm">
                  <button onClick={()=>{ if(step===2) reset(); else setStep(s=>s-1); }} className="p-2 text-[#8d6e63]"><Icon path={Icons.chevronLeft}/></button>
                  <span className="font-bold text-[#4e342e] text-sm">{step===2?'é¸æ“‡é …ç›®':step===3?'é¸æ“‡æ™‚é–“':step===4?'åŸºæœ¬è³‡æ–™':step===5?'è¨‚é‡‘èªªæ˜':'é ç´„å®Œæˆ'}</span>
                  <div className="w-8"></div>
              </div>

              <div className="flex-1 p-6 max-w-lg mx-auto w-full overflow-y-auto pb-20">
                  {step === 2 && (
                      <div className="space-y-8 fade-in">
                          {guests.map((g, i) => (
                              <div key={g.id} className="guest-block">
                                  <div className="flex justify-between items-center mb-3">
                                      <h3 className="text-lg font-bold text-[#5d4037]">ç¬¬ {i+1} ä½</h3>
                                      {i > 0 && <button onClick={()=>removeGuest(i)} className="text-xs text-red-400 border border-red-200 px-2 py-1 rounded"><Icon path={Icons.trash} size={14}/></button>}
                                  </div>
                                  
                                  {/* å·²é¸æœå‹™åˆ—è¡¨ */}
                                  {g.services.length > 0 ? (
                                      <div className="space-y-2 mb-4">
                                          {g.services.map(s => (
                                              <div key={s.id} className="flex justify-between items-center p-3 bg-[#efebe9] rounded-lg border border-[#d7ccc8]">
                                                  <div><div className="font-bold text-[#4e342e]">{s.name}</div><div className="text-xs opacity-70">${s.price}</div></div>
                                                  <button onClick={()=>removeServiceFromGuest(i, s.id)} className="text-[#8d6e63]"><Icon path={Icons.trash} size={16}/></button>
                                              </div>
                                          ))}
                                          <button onClick={()=>addServiceToGuest(i, {id:'dummy'})} className="text-xs text-[#8d6e63] underline mt-1">å†åŠ ä¸€é …æœå‹™?</button>
                                      </div>
                                  ) : (
                                      <div className="mb-4">
                                          <ServiceSelector services={services} onSelect={(s)=>addServiceToGuest(i, s)} />
                                      </div>
                                  )}
                                  
                                  {/* å„ªæƒ èº«ä»½ä¸‹æ‹‰é¸å–® (V25: è£œè‰²éæ¿¾é‚è¼¯) */}
                                  <div className="mb-4">
                                      <label className="text-xs font-bold text-gray-500 block mb-1 flex items-center gap-1"><Icon path={Icons.tag} size={14}/> å„ªæƒ èº«ä»½</label>
                                      <select 
                                        className="w-full p-2 rounded border bg-white text-sm"
                                        value={g.discount ? g.discount.id : ''}
                                        onChange={(e) => {
                                            const selected = discounts.find(d => d.id === e.target.value);
                                            updateGuest(i, 'discount', selected || null);
                                        }}
                                      >
                                          <option value="">ç„¡ (ä¿æŒåŸåƒ¹)</option>
                                          {discounts
                                            .filter(d => {
                                                // V25 Logic: è‹¥ç‚ºè£œè‰²ï¼Œåªé¡¯ç¤ºå£½æ˜Ÿ
                                                const isTouchUp = g.services.some(s => s.type === 'è£œè‰²');
                                                if (isTouchUp) return d.name.includes('å£½æ˜Ÿ');
                                                return true;
                                            })
                                            .map(d => (
                                              <option key={d.id} value={d.id}>{d.name} (æŠ˜æŠµ ${d.amount})</option>
                                          ))}
                                      </select>
                                      {g.services.some(s=>s.type==='è£œè‰²') && <p className="text-[10px] text-red-400 mt-1">â€» è£œè‰²é …ç›®åƒ…é©ç”¨å£½æ˜Ÿå„ªæƒ </p>}
                                  </div>

                                  {/* åŠ è³¼å€ */}
                                  {addons.length > 0 && (
                                      <div className="mt-4 pt-4 border-t border-dashed">
                                          <p className="text-xs text-gray-400 mb-2">åŠ è³¼é …ç›®</p>
                                          <div className="grid grid-cols-2 gap-2">{addons.map(ad => {
                                              const checked = g.addons.some(a=>a.id===ad.id);
                                              return (
                                                  <button key={ad.id} onClick={()=>toggleGuestAddon(i, ad)} className={`option-card p-2 rounded-lg text-xs text-center ${checked ? 'active' : 'bg-white'}`}>
                                                      <div className="font-bold">{ad.name}</div>
                                                      <div className="opacity-70">{ad.price>0?'+':''}{ad.price}</div>
                                                  </button>
                                              );
                                          })}</div>
                                      </div>
                                  )}
                              </div>
                          ))}
                          
                          <button onClick={addGuest} className="w-full py-3 border-2 border-dashed border-[#8d6e63] text-[#8d6e63] rounded-xl flex items-center justify-center gap-2 hover:bg-[#efebe9]">
                              <Icon path={Icons.plus}/> æ–°å¢ä¸€ä½åŒä¼´ (å…©äººåŒè¡Œ)
                          </button>

                          <div className="bg-[#8d6e63] text-white p-4 rounded-xl flex justify-between items-center shadow-lg sticky bottom-4">
                              <div className="text-sm">
                                  ç¸½è¨ˆäººæ•¸ï¼š{guests.length} ä½
                                  {isTwoPeople && <span className="block text-xs opacity-80">(å«å…©äººåŒè¡Œå„ªæƒ )</span>}
                              </div>
                              <div className="font-bold text-lg">${calculateTotal()}</div>
                          </div>
                      </div>
                  )}

                  {/* Steps 3-6 Same as before... */}
                  {step === 3 && (
                      <div className="space-y-6 fade-in">
                          <div className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                              <div className="flex justify-between items-center mb-4">
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()-1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronLeft}/></button>
                                  <span className="font-bold text-lg">{date.getFullYear()}å¹´ {date.getMonth()+1}æœˆ</span>
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()+1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronRight}/></button>
                              </div>
                              <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><span key={d} className="text-xs text-gray-400">{d}</span>)}</div>
                              <div className="grid grid-cols-7 gap-1">
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth(), 1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                      const d = i+1;
                                      const curr = new Date(date.getFullYear(), date.getMonth(), d);
                                      const open = isDateOpen(curr);
                                      const isPast = curr < new Date().setHours(0,0,0,0);
                                      const isSel = d === date.getDate();
                                      return <button key={d} disabled={isPast || !open} onClick={()=>{setDate(curr);}} className={`h-9 w-9 rounded-full text-sm flex items-center justify-center transition-all ${isSel?'bg-[#8d6e63] text-white shadow-md':(isPast||!open)?'text-gray-200':'hover:bg-[#efebe9]'}`}>{d}</button>
                                  })}
                              </div>
                          </div>
                          {isDateOpen(date) ? (
                              <div className="space-y-6">
                                  <div className="text-red-500 text-xs text-center bg-red-50 p-2 rounded">âš ï¸ å¤šäººåŒè¡Œå»ºè­°é¸æ“‡é€£çºŒæ™‚æ®µ</div>
                                  {guests.map((g, idx) => {
                                      const myTime = g.time;
                                      const taken = booked.concat(guests.filter((_, i)=>i!==idx).map(og=>og.time).filter(t=>t));
                                      return (
                                          <div key={g.id} className="bg-white p-4 rounded-xl border shadow-sm">
                                              <div className="font-bold text-[#5d4037] mb-2">ç¬¬ {idx+1} ä½æ™‚æ®µ</div>
                                              <div className="grid grid-cols-3 gap-2">
                                                  {getSlots(date).map(t => (
                                                      <button key={t} disabled={taken.includes(t)} onClick={()=>{ updateGuest(idx, 'time', t); updateGuest(idx, 'customTime', ''); }} className={`py-2 rounded border text-xs ${myTime===t?'bg-[#8d6e63] text-white border-[#8d6e63]':taken.includes(t)?'bg-gray-100 text-gray-300 cursor-not-allowed':'bg-white'}`}>{t}</button>
                                                  ))}
                                              </div>
                                              {myTime === 'å¾®èª¿æ™‚æ®µç”³è«‹' && (
                                                  <input type="time" className="mt-2 w-full border p-2 rounded text-sm" value={g.customTime} onChange={e=>updateGuest(idx, 'customTime', e.target.value)} />
                                              )}
                                          </div>
                                      )
                                  })}
                              </div>
                          ) : <div className="text-center py-8 bg-gray-50 rounded-xl text-gray-400">æ­¤æ—¥æœŸæœªé–‹æ”¾</div>}
                      </div>
                  )}
                  
                  {step === 4 && (
                      <div className="space-y-6 fade-in">
                          <div className="space-y-4">
                              {guests.map((g, i) => (
                                  <div key={g.id} className="bg-white p-4 rounded-lg border shadow-sm">
                                      <h3 className="text-sm font-bold text-[#5d4037] mb-3">ç¬¬ {i+1} ä½é¡§å®¢è³‡æ–™</h3>
                                      <div className="space-y-3">
                                          <input className="w-full p-2 bg-gray-50 rounded border focus:border-[#8d6e63] outline-none" placeholder="å§“å" value={g.name} onChange={e=>updateGuest(i, 'name', e.target.value)} />
                                          <input className="w-full p-2 bg-gray-50 rounded border focus:border-[#8d6e63] outline-none" type="tel" placeholder="é›»è©±" value={g.phone} onChange={e=>updateGuest(i, 'phone', e.target.value)} />
                                      </div>
                                  </div>
                              ))}
                              <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">å…¶ä»–å‚™è¨»</label><textarea className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63] h-24 resize-none" placeholder="éœ€å¸ç”²ã€çš®è†šæ•æ„Ÿ..." value={info.notes} onChange={e=>setInfo({...info,notes:e.target.value})} /></div>
                          </div>
                          <div className="flex justify-between text-sm border-t pt-2"><span className="text-gray-500">ç¸½é‡‘é¡</span><span className="font-bold text-[#8d6e63]">${calculateTotal()}</span></div>
                      </div>
                  )}

                  {step === 5 && (
                      <div className="space-y-6 fade-in">
                          <h2 className="text-xl font-bold text-[#4e342e]">è¨‚é‡‘èªªæ˜</h2>
                          <div className="bg-orange-50 border border-orange-200 p-5 rounded-xl text-sm leading-relaxed text-[#5d4037]">
                              <p className="mb-4 font-bold">ç¸½äººæ•¸ï¼š{guests.length} ä½</p>
                              <div className="bg-white p-4 rounded-lg border border-orange-100 mb-4">
                                  <p>éŠ€è¡Œï¼š<span className="font-bold">{BANK_INFO.code}</span></p>
                                  <p>å¸³è™Ÿï¼š<span className="font-bold text-lg">{BANK_INFO.account}</span></p>
                                  <p>æˆ¶åï¼š{BANK_INFO.name}</p>
                                  <p className="mt-2 text-red-600 font-bold">ç¸½è¨‚é‡‘ï¼š${depositTotal}</p>
                              </div>
                          </div>
                          <div className="flex items-center gap-2">
                              <input type="checkbox" id="agree" className="w-5 h-5 accent-[#8d6e63]"/>
                              <label htmlFor="agree" className="text-sm">æˆ‘å·²é–±è®€ä¸¦åŒæ„æ”¯ä»˜è¨‚é‡‘è¦å‰‡</label>
                          </div>
                      </div>
                  )}

                  {step === 6 && (
                      <div className="text-center pt-10 fade-in">
                          <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600"><Icon path={Icons.check} size={40}/></div>
                          <h2 className="text-2xl font-bold mb-2 text-[#4e342e]">é ç´„é€å‡ºæˆåŠŸï¼</h2>
                          <p className="text-gray-500 text-sm mb-8">è«‹è¨˜å¾—åŒ¯æ¬¾ä¸¦å›å ±ã€‚</p>
                          <button onClick={reset} className="w-full bg-[#8d6e63] text-white py-3 rounded-xl shadow-lg shadow-[#8d6e63]/30">è¿”å›é¦–é </button>
                      </div>
                  )}
              </div>

              {step < 6 && (
                  <div className="p-4 bg-white border-t safe-bottom">
                      <button onClick={()=>{
                          if(step===2 && guests.some(g=>g.services.length===0)) return alert('è«‹ç‚ºæ¯ä½å®¢äººé¸æ“‡æœå‹™');
                          if(step===3 && guests.some(g=>!g.time || (g.time==='å¾®èª¿æ™‚æ®µç”³è«‹' && !g.customTime))) return alert('è«‹ç‚ºæ¯ä½å®¢äººé¸æ“‡æ™‚é–“');
                          if(step===4 && guests.some(g=>!g.name || !g.phone)) return alert('è«‹å¡«å¯«æ‰€æœ‰è³‡æ–™');
                          if(step===5 && !document.getElementById('agree').checked) return alert('è«‹å‹¾é¸åŒæ„');
                          if(step===5) handleSubmit(); else setStep(s=>s+1);
                      }} className="w-full bg-[#8d6e63] text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-[#8d6e63]/30 active:scale-[0.98] transition-transform">
                          {step===5 ? 'é€å‡ºé ç´„' : 'ä¸‹ä¸€æ­¥'}
                      </button>
                  </div>
              )}
          </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
