<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èˆŠå®¢è£œè‰²æŸ¥è©¢ | AM Beauty Studio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { corePlugins: { preflight: false } }
    </script>

    <style>
        /* --- å“ç‰Œè‰²èª¿ (ç¶­æŒä¸€è‡´) --- */
        :root {
            --primary: #D6BFA8;   /* å¥¶èŒ¶æ£• */
            --primary-dark: #C4A488;
            --secondary: #E6C2C2; /* ç«ç‘°ç²‰ */
            --text: #5A483F;      /* æ·±å’–å­— */
            --text-light: #8D7B72;
            --bg-color: #F9F8F6;  
            --card-shadow: 0 10px 30px -10px rgba(214, 191, 168, 0.4);
        }

        /* å…¨åŸŸè¨­å®š */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            background-image: url('bg.jpg'); /* è«‹ç¢ºä¿èƒŒæ™¯åœ–æª”åæ­£ç¢º */
            background-size: cover;
            background-attachment: fixed;
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* --- é ‚éƒ¨ Header --- */
        .header-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
            padding: 40px 20px 60px 20px; 
            text-align: center; 
            border-radius: 0 0 40px 40px; 
            position: relative; 
            box-shadow: 0 10px 25px rgba(196, 164, 136, 0.4);
            margin-bottom: -40px; /* è®“æœå°‹æ¡†å¾€ä¸Šæµ®å‹• */
        }
        
        .header-logo { font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; margin: 0; }
        .header-sub { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; font-weight: 300; }

        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 10; }

        /* --- æŸ¥è©¢æ¡† (ä¸»è¦ç„¦é») --- */
        .search-card {
            background: #fff; border-radius: 24px; padding: 35px 25px;
            box-shadow: var(--card-shadow); text-align: center; 
            border: 1px solid rgba(255,255,255,0.8);
        }
        .search-icon-box {
            width: 70px; height: 70px; background: #FFF5F5;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 20px auto; color: var(--secondary);
            font-size: 2rem; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .search-title { font-size: 1.4rem; font-weight: 700; color: var(--text); margin: 0 0 5px 0; }
        .search-desc { font-size: 0.9rem; color: #999; margin-bottom: 25px; }

        .input-group { position: relative; margin-bottom: 20px; }
        .search-input {
            width: 100%; padding: 18px 20px 18px 50px; font-size: 1.1rem;
            border: 2px solid #eee; border-radius: 18px; background-color: #FAFAFA;
            outline: none; transition: 0.3s; color: var(--text);
        }
        .search-input:focus { background-color: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(214, 191, 168, 0.15); }
        .input-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #ccc; font-size: 1.2rem; }

        .btn-search {
            display: block; width: 100%; padding: 18px 0;
            background: linear-gradient(135deg, #E6C2C2 0%, #Dcb0b0 100%);
            color: #fff; border-radius: 18px; font-weight: 700; font-size: 1.1rem;
            cursor: pointer; border: none; letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(230, 194, 194, 0.4); transition: 0.3s;
        }
        .btn-search:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(230, 194, 194, 0.4); }
        .btn-search:disabled { opacity: 0.7; cursor: wait; }

        .notice-text { font-size: 0.85rem; color: #C17E7E; font-weight: bold; margin-top: 15px; background: #FFF0F0; padding: 10px; border-radius: 10px; display: inline-block; }

        /* --- æŸ¥è©¢çµæœå¡ç‰‡ --- */
        .result-container { margin-top: 30px; }
        .result-card {
            background: white; border-radius: 20px; padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.06); margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.02); animation: slideUp 0.5s ease;
        }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        .result-name { font-size: 1.3rem; font-weight: 700; color: var(--text); }
        
        .info-badges { display: flex; gap: 10px; margin-bottom: 20px; }
        .info-badge { flex: 1; background: #F9F8F6; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .info-label { display: block; font-size: 0.8rem; color: #999; margin-bottom: 4px; }
        .info-value { display: block; font-size: 1.1rem; font-weight: 700; color: var(--text); }
        .info-value.highlight { color: #C17E7E; }

        /* åƒ¹æ ¼é¡¯ç¤º */
        .price-box { 
            margin-top: 15px; padding: 15px; border-radius: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
        }

        /* å±•é–‹æ”¶åˆ */
        .collapsible-content { transition: all 0.4s; max-height: 0; overflow: hidden; opacity: 0; }
        .collapsible-content.expanded { max-height: 1000px; opacity: 1; }
        
        /* è¨Šæ¯æç¤º */
        .msg-box { margin-top: 20px; padding: 15px; border-radius: 12px; font-size: 0.95rem; font-weight: bold; display: none; text-align: center; }
        .msg-error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
        .msg-success { background: #ECFDF5; color: #059669; border: 1px solid #A7F3D0; }

        /* æ‡¸æµ®é ç´„æŒ‰éˆ• */
        .floating-cta { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            width: 85%; max-width: 350px; background: var(--text); color: white; 
            padding: 16px; border-radius: 50px; text-align: center; 
            text-decoration: none; font-weight: 700; font-size: 1.1rem; 
            box-shadow: 0 10px 25px rgba(90, 72, 63, 0.4); z-index: 950; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            transition: 0.2s;
        }
        .floating-cta:active { transform: translateX(-50%) scale(0.96); }

        /* å‹•ç•« */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header-section">
        <h1 class="header-logo">AM Beauty Studio</h1>
        <div class="header-sub">å°ˆå±¬è£œè‰²è³‡æ ¼æŸ¥è©¢ç³»çµ±</div>
    </div>

    <div class="container">
        <!-- æŸ¥è©¢å¡ç‰‡ -->
        <div class="search-card">
            <div class="search-icon-box">ğŸ”</div>
            <h2 class="search-title">æŸ¥è©¢è£œè‰²å„ªæƒ </h2>
            <p class="search-desc">è¼¸å…¥å§“åæˆ–é›»è©±ï¼Œç«‹å³æŸ¥çœ‹æ‚¨çš„å°ˆå±¬æ–¹æ¡ˆ</p>
            
            <div class="input-group">
                <div class="input-icon">ğŸ‘¤</div>
                <input type="text" id="queryInput" class="search-input" 
                       placeholder="ä¾‹å¦‚ï¼šæ—å°ç¾ æˆ– 0912..." 
                       onkeydown="if(event.key === 'Enter') searchRecord()">
            </div>

            <div class="notice-text">ğŸ’¡ å°æé†’ï¼šå»ºè­°å„ªå…ˆä½¿ç”¨ã€Œå§“åã€æŸ¥è©¢ï¼Œè³‡æ–™æ›´æº–ç¢ºå–”ï¼</div>
            
            <button onclick="searchRecord()" id="searchButton" class="btn-search">
                ç«‹å³æŸ¥è©¢
            </button>

            <!-- è¨Šæ¯é¡¯ç¤º -->
            <div id="messageArea" class="msg-box"></div>
        </div>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <div id="resultsArea" class="result-container"></div>
    </div>

    <!-- é ç´„æŒ‰éˆ• -->
    <a href="https://liff.line.me/1661306685-kQp9pya4" class="floating-cta">
        <span>ğŸ“… ç«‹å³é ç´„è«®è©¢</span>
    </a>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // GAS API (ç¶­æŒä¸è®Š)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx6grwl5DidK6DScAaZLM8udp-Pjn_FrB33bv6ES0JkwAiiIx-xxJHicxANVGH7caSpEg/exec"; 

        function searchRecord() {
            let q = document.getElementById('queryInput').value.trim();
            if(!q) return showMessage('error', 'è«‹è¼¸å…¥å§“åæˆ–é›»è©±');
            
            // æ‰‹æ©Ÿè™Ÿå»0é‚è¼¯
            if (/^0\d+/.test(q)) q = q.substring(1);

            const btn = document.getElementById('searchButton');
            const area = document.getElementById('resultsArea');
            
            // Loading UI
            btn.textContent = 'è³‡æ–™æŸ¥è©¢ä¸­...'; 
            btn.disabled = true; 
            area.innerHTML = '';
            document.getElementById('messageArea').style.display = 'none';

            fetch(`${GAS_API_URL}?q=${encodeURIComponent(q)}`)
                .then(response => response.json())
                .then(res => {
                    if (res.data && res.data.length > 0) {
                        
                        // 1. æ’åº (æ—¥æœŸæ–°åˆ°èˆŠ)
                        const sortedData = res.data.sort((a, b) => new Date(b.lastDate) - new Date(a.lastDate));
                        
                        // 2. éæ¿¾é‡è¤‡ (åªç•™è©²é …ç›®æœ€æ–°ä¸€ç­†)
                        const uniqueData = [];
                        const seenServices = new Set(); 

                        sortedData.forEach(item => {
                            const key = `${item.name}_${item.service}`;
                            if (!seenServices.has(key)) {
                                uniqueData.push(item);
                                seenServices.add(key);
                            }
                        });

                        if(uniqueData.length > 0) {
                            showMessage('success', `ğŸ‰ æŸ¥è©¢æˆåŠŸï¼æ‰¾åˆ° ${uniqueData.length} ç­†è³‡æ–™`);
                            area.innerHTML = uniqueData.map((r, i) => createCard(r, i)).join('');
                        } else {
                            showMessage('error', 'æŸ¥ç„¡ç›¸é—œè³‡æ–™');
                        }
                        
                    } else {
                        showMessage('error', 'æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥æ˜¯å¦æ­£ç¢º (æˆ–æ˜¯å˜—è©¦ç”¨å§“åæŸ¥è©¢)');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showMessage('error', 'ç³»çµ±é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                })
                .finally(() => {
                    btn.textContent = 'ç«‹å³æŸ¥è©¢'; 
                    btn.disabled = false;
                });
        }

        function showMessage(type, text) {
            const el = document.getElementById('messageArea');
            el.textContent = text;
            el.className = `msg-box ${type === 'error' ? 'msg-error' : 'msg-success'}`;
            el.style.display = 'block';
        }

        function createCard(r, i) { 
            const cid = `card-${i}`; 
            const ranges = (r.touchUpRanges||[]).map(t => 
                `<div class="flex justify-between py-3 border-b border-gray-100 text-sm last:border-0">
                    <span class="text-gray-600">${t.dateRange}</span>
                    <span class="font-bold text-gray-800">${t.price===0?'å…è²»':'$'+t.price}</span>
                </div>`
            ).join(''); 
            
            return `
            <div class="result-card">
                <div class="result-header">
                    <div>
                        <div class="result-name">${r.name}</div>
                        <span class="text-gray-400 text-sm">(${maskPhoneNumber(r.phone)})</span>
                    </div>
                </div>
                
                <div class="info-badges">
                    <div class="info-badge">
                        <span class="info-label">ä¸Šæ¬¡æ—¥æœŸ</span>
                        <span class="info-value">${r.lastDate||'-'}</span>
                    </div>
                    <div class="info-badge">
                        <span class="info-label">ä¸Šæ¬¡é …ç›®</span>
                        <span class="info-value highlight">${r.service}</span>
                    </div>
                </div>

                ${r.specialReminder ? 
                    `<div class="bg-yellow-50 text-yellow-800 p-3 rounded-xl text-sm mb-4 font-medium flex items-start gap-2">
                        <span>ğŸ’¡</span><span>${r.specialReminder}</span>
                     </div>` : ''
                } 
                
                ${getPriceCardHtml(r.currentPriceInfo, r.eyebrowDiscountDate && !checkIsExpired(r.eyebrowDiscountDate))} 
                
                <div style="margin-top:20px;">
                    <button onclick="toggleCollapse('${cid}', this)" 
                            style="width:100%; padding:12px; background:#F9F8F6; color:#888; border:none; border-radius:12px; font-size:0.9rem; font-weight:600; cursor:pointer; transition:0.2s;">
                        æŸ¥çœ‹å®Œæ•´åƒ¹ç›®è¡¨ â–¼
                    </button>
                    <div id="${cid}" class="collapsible-content bg-gray-50 px-4 mt-2 rounded-xl">
                        <div class="py-3">${ranges}</div>
                    </div>
                </div>
            </div>`; 
        }

        function getPriceCardHtml(info, useOrange) { 
            if (!info) return ''; 
            let p = info.price===0 ? 'å…è²»' : (info.price ? `NT$ ${info.price}` : 'æ´½è©¢'); 
            let bg = info.price===0 ? 'bg-green-600' : (useOrange ? 'bg-orange-500' : 'bg-pink-500'); 
            let theme = info.price===0 ? 'bg-green-50 border-green-200' : (useOrange ? 'bg-orange-50 border-orange-200' : 'bg-pink-50 border-pink-200'); 
            let dateText = (info.dateRange || '').replace(/ã€.*?ã€‘/g, '');
            
            return `
            <div class="price-box border ${theme}">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 mb-1">ç›®å‰è£œè‰²åƒ¹æ ¼</h3>
                    <p class="text-lg font-bold text-gray-800 tracking-wide">${dateText}</p>
                </div>
                <span class="px-4 py-2 text-white text-xl font-bold rounded-xl ${bg} shadow-md">${p}</span>
            </div>`; 
        }

        function checkIsExpired(d) { if(!d)return false; return new Date() > new Date(d); }
        function maskPhoneNumber(p) { if(!p)return''; let s=String(p).replace(/'/g,'').trim(); return s.length<8?s:s.substring(0,4)+'***'+s.substring(s.length-3); }
        function toggleCollapse(id, btn) { 
            const el = document.getElementById(id); 
            el.classList.toggle('expanded'); 
            btn.textContent = el.classList.contains('expanded') ? 'æ”¶èµ·å®Œæ•´åƒ¹ç›®è¡¨ â–²' : 'æŸ¥çœ‹å®Œæ•´åƒ¹ç›®è¡¨ â–¼'; 
            btn.style.background = el.classList.contains('expanded') ? '#eee' : '#F9F8F6';
        }
    </script>
</body>
</html>
