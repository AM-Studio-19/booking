<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·šä¸Šé ç´„ç³»çµ±</title>
  
  <!-- 1. å¼•å…¥ Tailwind CSS (æ¨£å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. å¼•å…¥ LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- 3. è¨­å®š Import Map (è®“ç€è¦½å™¨çŸ¥é“å»å“ªè£¡æŠ“ React å’Œ Firebase) -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
      }
    }
  </script>

  <!-- 4. å¼•å…¥ Babel (è®“ç€è¦½å™¨çœ‹å¾—æ‡‚ JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- å­—å‹è¨­å®š -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; }
    /* è‡ªå®šç¾©æ²è»¸ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #d7ccc8; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #8d6e63; }
  </style>
</head>
<body class="bg-[#f4f1ea]">
  <div id="root"></div>

  <!-- ä¸»ç¨‹å¼ç¢¼ -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect } from 'react';
    import ReactDOM from 'react-dom/client';
    import { initializeApp } from 'firebase/app';
    import { getFirestore, collection, addDoc, query, where, deleteDoc, doc, onSnapshot, orderBy, serverTimestamp, setDoc } from 'firebase/firestore';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

    // --- âš ï¸âš ï¸âš ï¸ è¨­å®šå€åŸŸï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„è³‡æ–™ âš ï¸âš ï¸âš ï¸ ---
    
    // 1. LIFF ID (æ‚¨çš„ ID)
    const LIFF_ID = '2008567948-rNVLPLYb';
    
    // 2. å¾Œå°å¯†ç¢¼
    const ADMIN_PIN = '1234'; 

    // 3. Firebase è¨­å®š (è«‹å¡«å…¥æ‚¨è‡ªå·±çš„è¨­å®šï¼Œå¦å‰‡ç„¡æ³•å„²å­˜è³‡æ–™)
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };

    // -------------------------------------------------------

    // åˆå§‹åŒ– Firebase
    // ç‚ºäº†é¿å…ä½¿ç”¨è€…å¿˜è¨˜å¡«å¯«å°è‡´å ±éŒ¯ï¼Œé€™é‚Šåšå€‹ç°¡å–®æª¢æŸ¥
    let app, auth, db, appId;
    try {
      if (firebaseConfig.apiKey === "è«‹å¡«å…¥æ‚¨çš„apiKey") {
        console.warn("âš ï¸ è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ­£ç¢ºçš„ Firebase Config");
      } else {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = "booking-system-web"; // ç”¨æ–¼å€éš”è³‡æ–™çš„ ID
      }
    } catch (e) {
      console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
    }

    // --- åœ–ç¤ºå…ƒä»¶ (ä½¿ç”¨ SVG ç¹ªè£½ï¼Œä¸ä¾è³´å¤–éƒ¨å¥—ä»¶) ---
    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );
    const Icons = {
      MapPin: (p) => <Icon {...p} path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />,
      ChevronRight: (p) => <Icon {...p} path={<path d="m9 18 6-6-6-6"/>} />,
      ChevronLeft: (p) => <Icon {...p} path={<path d="m15 18-6-6 6-6"/>} />,
      Settings: (p) => <Icon {...p} path={<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>} /> ,
      Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
      User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
      Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />,
      FileText: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} />,
      CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
      Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
      Plus: (p) => <Icon {...p} path={<><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>} />,
      Info: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>} />
    };

    // --- å¸¸æ•¸è³‡æ–™ ---
    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }
    ];
    const DEFAULT_TIME_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DISCOUNT_NOTE = "â€» å„ªæƒ èº«åˆ†åŒ…å«ï¼šå­¸ç”Ÿã€é†«è­·ã€è»å…¬æ•™ã€ç•¶æœˆå£½æ˜Ÿã€èˆŠå®¢ä»‹ç´¹ (è«‹æ–¼ç¾å ´å‡ºç¤ºè­‰æ˜)";

    // --- ä¸»ç¨‹å¼å…ƒä»¶ ---
    function AppointmentApp() {
      // ç‹€æ…‹
      const [user, setUser] = useState(null);
      const [view, setView] = useState('home'); 
      const [bookingStep, setBookingStep] = useState(1);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [selectedService, setSelectedService] = useState(null);
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedTime, setSelectedTime] = useState(null);
      const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', notes: '' });
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [bookedSlots, setBookedSlots] = useState([]); 
      const [locationSettings, setLocationSettings] = useState({});
      const [adminPinInput, setAdminPinInput] = useState('');

      // åˆå§‹åŒ–
      useEffect(() => {
        if (!auth) return;
        signInAnonymously(auth).catch(console.error);
        if (window.liff) {
          window.liff.init({ liffId: LIFF_ID }).catch(err => console.log('LIFF init error (may be outside LINE)', err));
        }
        return onAuthStateChanged(auth, setUser);
      }, []);

      // ç›£è½è³‡æ–™åº«
      useEffect(() => {
        if (!user || !db) return;
        
        // æœå‹™
        const unsubS = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'services'), orderBy('name')), snap => {
          setServices(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        
        // å­é …ç›®
        const unsubA = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'addons')), snap => {
          setAddons(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });

        // è¨­å®š
        const unsubSet = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), snap => {
          const settings = {};
          snap.docs.forEach(d => { settings[d.id] = d.data(); });
          setLocationSettings(settings);
        });

        return () => { unsubS(); unsubA(); unsubSet(); };
      }, [user]);

      // ç›£è½è©²æ—¥é ç´„ç‹€æ³
      useEffect(() => {
        if (!user || !selectedLocation || !selectedDate || !db) return;
        const dateStr = selectedDate.toISOString().split('T')[0];
        const q = query(
          collection(db, 'artifacts', appId, 'public', 'data', 'bookings'),
          where('locationId', '==', selectedLocation.id),
          where('date', '==', dateStr)
        );
        const unsub = onSnapshot(q, (snapshot) => {
          setBookedSlots(snapshot.docs.map(d => d.data().time));
        });
        return () => unsub();
      }, [user, selectedLocation, selectedDate]);

      // å·¥å…·å‡½å¼
      const isDateAvailable = (date) => {
        if (!selectedLocation) return true;
        const settings = locationSettings[selectedLocation.id];
        if (!settings || !settings.allowedDates || settings.allowedDates.length === 0) return true;
        return settings.allowedDates.includes(date.toISOString().split('T')[0]);
      };

      const getCurrentTimeSlots = () => {
        if (!selectedLocation) return DEFAULT_TIME_SLOTS;
        const settings = locationSettings[selectedLocation.id];
        if (settings && settings.timeSlots && settings.timeSlots.length > 0) return settings.timeSlots;
        return DEFAULT_TIME_SLOTS;
      };

      const handleSubmitBooking = async () => {
        if (!user || !db) return alert("ç³»çµ±é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– Firebase è¨­å®š");
        
        const bookingData = {
          locationId: selectedLocation.id,
          locationName: selectedLocation.name,
          serviceId: selectedService.id,
          serviceName: selectedService.name,
          addons: selectedAddons,
          date: selectedDate.toISOString().split('T')[0],
          time: selectedTime,
          customerName: customerInfo.name,
          customerPhone: customerInfo.phone,
          notes: customerInfo.notes,
          createdAt: serverTimestamp(),
          userId: user.uid
        };

        try {
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), bookingData);
          
          const msg = `ã€é ç´„é€šçŸ¥ã€‘\n` +
            `ğŸ  ${bookingData.locationName}\n` +
            `ğŸ“… ${bookingData.date} ${bookingData.time}\n` +
            `ğŸ’† ${bookingData.serviceName}\n` +
            `ğŸ‘¤ ${bookingData.customerName}`;
          
          if (window.liff && window.liff.isInClient()) {
            await window.liff.sendMessages([{ type: 'text', text: msg }]);
          }
          setBookingStep(5);
        } catch (e) {
          alert('é ç´„å¤±æ•—: ' + e.message);
        }
      };

      const resetBooking = () => {
        setBookingStep(1);
        setSelectedLocation(null);
        setSelectedService(null);
        setSelectedAddons([]);
        setSelectedTime(null);
        setCustomerInfo({ name: '', phone: '', notes: '' });
        setView('home');
      };

      // --- æ¸²æŸ“ç•«é¢ ---
      if (!db && firebaseConfig.apiKey === "è«‹å¡«å…¥æ‚¨çš„apiKey") {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center">
                <h1 className="text-2xl font-bold text-red-600 mb-4">âš ï¸ å°šæœªè¨­å®šè³‡æ–™åº«</h1>
                <p>è«‹ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨é–‹å•Ÿæ­¤æª”æ¡ˆ (index.html)</p>
                <p>æœå°‹ <code>firebaseConfig</code> ä¸¦å¡«å…¥æ‚¨çš„ Firebase è¨­å®šã€‚</p>
            </div>
        );
      }

      // Admin Login
      if (view === 'admin-login') {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea]">
            <div className="bg-white p-8 rounded shadow-lg max-w-sm w-full text-center border border-[#d7ccc8]">
              <h2 className="text-xl font-bold mb-4 text-[#5d4037]">å¾Œå°ç™»å…¥</h2>
              <input type="password" placeholder="PIN" className="w-full border p-2 mb-4 rounded outline-none" value={adminPinInput} onChange={e => setAdminPinInput(e.target.value)} />
              <div className="flex gap-2">
                <button onClick={() => setView('home')} className="flex-1 bg-gray-200 py-2 rounded text-[#5d4037]">å–æ¶ˆ</button>
                <button onClick={() => adminPinInput === ADMIN_PIN ? setView('admin-dashboard') : alert('å¯†ç¢¼éŒ¯èª¤')} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">ç™»å…¥</button>
              </div>
            </div>
          </div>
        );
      }

      // Admin Dashboard
      if (view === 'admin-dashboard') {
        return <AdminDashboard onBack={() => setView('home')} user={user} services={services} settings={locationSettings} appId={appId} db={db} />;
      }

      // Home
      if (view === 'home') {
        return (
          <div className="min-h-screen p-6 flex flex-col items-center justify-center" style={{backgroundImage: `linear-gradient(90deg, transparent 50%, rgba(255,255,255,.3) 50%), linear-gradient(transparent 50%, rgba(244,241,234,0.1) 50%)`, backgroundSize: '20px 20px'}}>
            <button onClick={() => setView('admin-login')} className="absolute top-4 left-4 p-2 text-[#8d6e63] opacity-30 hover:opacity-100"><Icons.Settings /></button>
            <div className="max-w-md w-full relative">
              <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 -rotate-2 w-32 h-8 bg-[#d7ccc8] opacity-80 shadow-sm z-10"></div>
              <div className="bg-[#fdfbf7] p-8 pt-10 rounded-sm shadow-xl border border-[#e8e4dc]">
                <h1 className="text-3xl font-bold text-center mb-2 tracking-widest text-[#4e342e]">ç·šä¸Šé ç´„</h1>
                <p className="text-center text-[#8d6e63] mb-8 text-sm">è«‹é¸æ“‡æœå‹™æ“šé»</p>
                <div className="space-y-4">
                  {LOCATIONS.map(loc => (
                    <button key={loc.id} onClick={() => { setSelectedLocation(loc); setView('booking'); setBookingStep(2); }} className="w-full bg-white border-2 border-[#d7ccc8] hover:border-[#8d6e63] p-6 rounded-lg transition-all flex items-center justify-between group">
                      <div className="flex items-center gap-4">
                        <div className="bg-[#efebe9] p-3 rounded-full text-[#5d4037]"><Icons.MapPin /></div>
                        <h3 className="text-xl font-bold text-[#4e342e]">{loc.name}</h3>
                      </div>
                      <span className="text-[#d7ccc8] group-hover:text-[#8d6e63]"><Icons.ChevronRight /></span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Booking Process
      return (
        <div className="min-h-screen py-6 px-4 font-serif text-[#5d4037]">
            <div className="max-w-lg mx-auto bg-[#fdfbf7] min-h-[85vh] rounded-sm shadow-xl border border-[#e8e4dc] flex flex-col">
               <div className="p-6 border-b border-[#e8e4dc] flex items-center justify-between bg-white/50">
                  <button onClick={() => bookingStep === 2 ? resetBooking() : setBookingStep(s => s - 1)} className="text-[#8d6e63]"><Icons.ChevronLeft /></button>
                  <span className="font-bold tracking-widest text-[#4e342e]">{bookingStep === 2 ? 'é¸æ“‡æœå‹™' : bookingStep === 3 ? 'é¸æ“‡æ™‚é–“' : 'ç¢ºèªè³‡æ–™'}</span>
                  <div className="w-6"></div> 
               </div>

               <div className="flex-1 p-6 overflow-y-auto">
                 {bookingStep === 2 && (
                   <div className="space-y-6">
                     <div className="bg-[#efebe9]/50 p-4 rounded text-xs text-[#6d4c41] flex gap-2 items-start leading-relaxed">
                       <span className="shrink-0 mt-0.5"><Icons.Info size={16}/></span> {DISCOUNT_NOTE}
                     </div>
                     <div className="grid gap-3">
                        {services.map(svc => (
                           <label key={svc.id} className={`relative flex items-center justify-between p-4 border rounded-lg cursor-pointer transition-all ${selectedService?.id === svc.id ? 'border-[#8d6e63] bg-[#efebe9]' : 'border-gray-200 hover:border-[#d7ccc8]'}`}>
                             <div className="flex items-center gap-3">
                               <input type="radio" name="service" className="accent-[#8d6e63] w-5 h-5" checked={selectedService?.id === svc.id} onChange={() => setSelectedService(svc)} />
                               <div>
                                 <div className="font-bold text-lg">{svc.name}</div>
                                 <div className="text-sm text-[#8d6e63] flex gap-2 items-center">
                                   <span>â± {svc.duration} åˆ†</span>
                                   <span className="font-bold text-[#5d4037]">${svc.price}</span>
                                 </div>
                               </div>
                             </div>
                             {svc.name.includes("å„ªæƒ ") && <div className="absolute top-2 right-2 text-[10px] bg-[#8d6e63] text-white px-2 py-0.5 rounded-full">å„ªæƒ </div>}
                           </label>
                         ))}
                     </div>
                   </div>
                 )}

                 {bookingStep === 3 && (
                   <div className="space-y-6">
                     <div className="bg-white p-4 rounded-lg border border-[#e8e4dc] shadow-sm">
                       <div className="flex justify-between items-center mb-4">
                         <button onClick={() => setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth() - 1)))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronLeft/></button>
                         <span className="font-bold text-lg">{selectedDate.getFullYear()}å¹´ {selectedDate.getMonth() + 1}æœˆ</span>
                         <button onClick={() => setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth() + 1)))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronRight/></button>
                       </div>
                       <div className="grid grid-cols-7 gap-1 text-center text-sm mb-2 text-[#a1887f]">
                         {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d}>{d}</div>)}
                       </div>
                       <div className="grid grid-cols-7 gap-1 text-center">
                         {Array.from({ length: new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay() }).map((_, i) => <div key={`empty-${i}`}></div>)}
                         {Array.from({ length: new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate() }).map((_, i) => {
                           const d = i + 1;
                           const current = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d);
                           const isSelected = d === selectedDate.getDate();
                           const isPast = current < new Date().setHours(0,0,0,0);
                           const available = isDateAvailable(current);
                           return (
                             <button key={d} disabled={isPast || !available} onClick={() => { setSelectedDate(current); setSelectedTime(null); }}
                               className={`p-2 rounded-full w-8 h-8 flex items-center justify-center mx-auto text-sm transition-colors relative
                                 ${isSelected ? 'bg-[#8d6e63] text-white' : ''}
                                 ${!isSelected && available && !isPast ? 'hover:bg-[#efebe9] text-[#5d4037]' : ''}
                                 ${(isPast || !available) ? 'text-gray-200 cursor-not-allowed' : ''}
                               `}>
                               {d}
                               {!isPast && available && !isSelected && <div className="absolute bottom-1 w-1 h-1 bg-[#8d6e63] rounded-full"></div>}
                             </button>
                           );
                         })}
                       </div>
                     </div>
                     
                     {isDateAvailable(selectedDate) ? (
                       <div>
                         <h3 className="text-lg font-bold mb-3 flex items-center gap-2"><Icons.Clock size={18}/> é¸æ“‡æ™‚æ®µ</h3>
                         <div className="grid grid-cols-2 gap-3">
                           {getCurrentTimeSlots().map(time => {
                             const isBooked = bookedSlots.includes(time);
                             return (
                               <button key={time} disabled={isBooked} onClick={() => setSelectedTime(time)}
                                 className={`py-3 px-2 text-sm rounded border transition-all text-center ${selectedTime === time ? 'bg-[#8d6e63] text-white border-[#8d6e63]' : isBooked ? 'bg-gray-100 text-gray-300 border-gray-100 cursor-not-allowed' : 'bg-white border-[#d7ccc8] hover:border-[#8d6e63] text-[#5d4037]'}`}>
                                 {time} {isBooked && '(å·²æ»¿)'}
                               </button>
                             )
                           })}
                         </div>
                       </div>
                     ) : <div className="text-center text-red-400 text-sm">è©²æ—¥æœŸå°šæœªé–‹æ”¾é ç´„ã€‚</div>}
                   </div>
                 )}

                 {bookingStep === 4 && (
                   <div className="space-y-6">
                     <div className="bg-[#efebe9] p-4 rounded-lg text-sm space-y-2 border border-[#d7ccc8]">
                        <div className="flex justify-between"><span className="text-[#a1887f]">åœ°é»</span> <span className="font-bold">{selectedLocation?.name}</span></div>
                        <div className="flex justify-between"><span className="text-[#a1887f]">æ™‚é–“</span> <span className="font-bold">{selectedDate.toLocaleDateString()} {selectedTime}</span></div>
                        <div className="flex justify-between"><span className="text-[#a1887f]">é …ç›®</span> <span className="font-bold">{selectedService?.name}</span></div>
                     </div>
                     <div className="space-y-4">
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">å§“å</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.User size={18}/></span>
                                <input type="text" className="w-full bg-transparent outline-none" value={customerInfo.name} onChange={e => setCustomerInfo({...customerInfo, name: e.target.value})} placeholder="è«‹è¼¸å…¥å§“å" />
                           </div>
                       </div>
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">é›»è©±</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.Phone size={18}/></span>
                                <input type="tel" className="w-full bg-transparent outline-none" value={customerInfo.phone} onChange={e => setCustomerInfo({...customerInfo, phone: e.target.value})} placeholder="09xx-xxx-xxx" />
                           </div>
                       </div>
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">å‚™è¨»</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.FileText size={18}/></span>
                                <textarea className="w-full bg-transparent outline-none resize-none" rows={2} value={customerInfo.notes} onChange={e => setCustomerInfo({...customerInfo, notes: e.target.value})} placeholder="è‹¥é¸æ“‡å¾®èª¿æ™‚æ®µï¼Œè«‹åœ¨æ­¤å¡«å¯«å¸Œæœ›çš„æ™‚é–“" />
                           </div>
                       </div>
                     </div>
                   </div>
                 )}

                 {bookingStep === 5 && (
                   <div className="text-center py-10">
                     <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><span className="text-green-600"><Icons.CheckCircle size={48}/></span></div>
                     <h2 className="text-2xl font-bold text-[#4e342e] mb-2">é ç´„æˆåŠŸï¼</h2>
                     <button onClick={resetBooking} className="bg-[#8d6e63] text-white px-8 py-3 rounded shadow mt-6">è¿”å›é¦–é </button>
                   </div>
                 )}
               </div>

               {bookingStep < 5 && (
                 <div className="p-6 border-t border-[#e8e4dc] bg-white/50">
                   <button onClick={() => {
                       if (bookingStep === 2 && !selectedService) return alert('è«‹é¸æ“‡æœå‹™');
                       if (bookingStep === 3 && !selectedTime) return alert('è«‹é¸æ“‡æ™‚æ®µ');
                       if (bookingStep === 4 && (!customerInfo.name || !customerInfo.phone)) return alert('è«‹å¡«å¯«è³‡æ–™');
                       if (bookingStep === 4) handleSubmitBooking();
                       else setBookingStep(s => s + 1);
                     }}
                     className="w-full bg-[#8d6e63] text-white py-3 rounded-md font-bold tracking-widest shadow-md hover:bg-[#795548] transition-all">
                     {bookingStep === 4 ? 'ç¢ºèªé ç´„' : 'ä¸‹ä¸€æ­¥'}
                   </button>
                 </div>
               )}
            </div>
        </div>
      );
    }

    // --- Admin Dashboard (ç°¡åŒ–ç‰ˆ) ---
    function AdminDashboard({ onBack, user, services, settings, appId, db }) {
      const [activeTab, setActiveTab] = useState('settings'); 
      const [bookings, setBookings] = useState([]);
      const [tainanDates, setTainanDates] = useState(settings['tainan']?.allowedDates?.join(',') || '');
      const [kaohsiungDates, setKaohsiungDates] = useState(settings['kaohsiung']?.allowedDates?.join(',') || '');
      const [kaohsiungSlots, setKaohsiungSlots] = useState(settings['kaohsiung']?.timeSlots?.join(',') || DEFAULT_TIME_SLOTS.join(','));
      const [tainanSlots, setTainanSlots] = useState(settings['tainan']?.timeSlots?.join(',') || DEFAULT_TIME_SLOTS.join(','));

      useEffect(() => {
        if (!user || !db) return;
        return onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), orderBy('date', 'desc')), snap => {
          setBookings(snap.docs.map(d => ({id: d.id, ...d.data()})));
        });
      }, [user]);

      const saveSettings = async (locId, datesStr, slotsStr) => {
        const dates = datesStr.split(',').map(d => d.trim()).filter(d => d);
        const slots = slotsStr.split(',').map(s => s.trim()).filter(s => s);
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', locId), { allowedDates: dates, timeSlots: slots });
        alert('å„²å­˜æˆåŠŸ');
      };

      const initDefaults = async () => {
        if (!confirm('å°‡é‡ç½®æœå‹™åˆ—è¡¨ï¼Œç¢ºå®šï¼Ÿ')) return;
        for (let s of services) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', s.id)); }
        const defaults = [
            { name: 'éœ§çœ‰ (ä¸€èˆ¬é ç´„)', price: 4800, duration: 90 },
            { name: 'éœ§çœ‰ (å„ªæƒ èº«åˆ†)', price: 4600, duration: 90 },
            { name: 'éœ§å”‡ (ä¸€èˆ¬é ç´„)', price: 5200, duration: 120 },
            { name: 'éœ§å”‡ (å„ªæƒ èº«åˆ†)', price: 5000, duration: 120 },
        ];
        for (let d of defaults) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), d); }
        alert('é‡ç½®å®Œæˆ');
      };

      return (
        <div className="min-h-screen bg-gray-50 p-6 font-sans">
          <div className="max-w-4xl mx-auto bg-white shadow rounded-lg overflow-hidden">
            <div className="flex justify-between items-center p-6 border-b">
              <h2 className="text-xl font-bold text-gray-800">å¾Œå°ç®¡ç†</h2>
              <button onClick={onBack} className="bg-gray-500 text-white px-4 py-2 rounded text-sm">é€€å‡º</button>
            </div>
            <div className="flex border-b bg-gray-50">
              {['settings', 'services', 'bookings'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 font-bold text-sm ${activeTab === tab ? 'bg-white text-[#8d6e63] border-t-2 border-[#8d6e63]' : 'text-gray-500'}`}>
                    {tab === 'settings' ? 'ç‡Ÿæ¥­è¨­å®š' : tab === 'services' ? 'æœå‹™é …ç›®' : 'é ç´„ç´€éŒ„'}
                </button>
              ))}
            </div>
            <div className="p-6">
                {activeTab === 'settings' && (
                    <div className="space-y-4">
                        <div className="border p-4 rounded bg-orange-50">
                            <h3 className="font-bold text-[#e65100] mb-2">é«˜é›„è¨­å®š</h3>
                            <textarea className="w-full border p-2 mb-2 h-20 text-sm" value={kaohsiungDates} onChange={e => setKaohsiungDates(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)" />
                            <button onClick={() => setKaohsiungDates("2025-12-12,2025-12-13,2025-12-14,2025-12-15,2025-12-26,2025-12-27,2025-12-28,2025-12-29")} className="text-xs text-blue-600 underline mb-2 block">åŒ¯å…¥12æœˆæª”æœŸ</button>
                            <input className="w-full border p-2 mb-2 text-sm" value={kaohsiungSlots} onChange={e => setKaohsiungSlots(e.target.value)} />
                            <button onClick={() => saveSettings('kaohsiung', kaohsiungDates, kaohsiungSlots)} className="bg-[#e65100] text-white px-3 py-1 rounded">å„²å­˜</button>
                        </div>
                        <div className="border p-4 rounded bg-blue-50">
                            <h3 className="font-bold text-[#0d47a1] mb-2">å°å—è¨­å®š</h3>
                            <textarea className="w-full border p-2 mb-2 h-20 text-sm" value={tainanDates} onChange={e => setTainanDates(e.target.value)} placeholder="æ—¥æœŸ (ç•™ç©ºç‚ºå…¨é–‹)" />
                            <input className="w-full border p-2 mb-2 text-sm" value={tainanSlots} onChange={e => setTainanSlots(e.target.value)} />
                            <button onClick={() => saveSettings('tainan', tainanDates, tainanSlots)} className="bg-[#0d47a1] text-white px-3 py-1 rounded">å„²å­˜</button>
                        </div>
                    </div>
                )}
                {activeTab === 'services' && (
                    <div>
                        <button onClick={initDefaults} className="bg-yellow-600 text-white px-3 py-1 rounded text-sm mb-4">é‡ç½®é è¨­æœå‹™</button>
                        <div className="space-y-2">
                            {services.map(s => (
                                <div key={s.id} className="flex justify-between border p-2 rounded">
                                    <span>{s.name} (${s.price})</span>
                                    <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', s.id))} className="text-red-500"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                         <button onClick={async () => {
                            const n = prompt('åç¨±'); const p = prompt('åƒ¹æ ¼'); const d = prompt('æ™‚é•·');
                            if(n&&p) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), {name:n, price:Number(p), duration:Number(d||90)});
                        }} className="mt-4 flex items-center gap-2 text-[#8d6e63] border border-[#8d6e63] px-4 py-2 rounded text-sm"><Icons.Plus size={16}/> æ–°å¢</button>
                    </div>
                )}
                {activeTab === 'bookings' && (
                    <div>
                        {bookings.map(b => (
                         <div key={b.id} className="border-b p-3 flex justify-between items-start text-sm">
                           <div>
                             <div className="font-bold text-[#8d6e63]">{b.date} {b.time} <span className="bg-gray-200 px-1 rounded ml-1 text-xs">{b.locationName}</span></div>
                             <div>{b.serviceName}</div>
                             <div className="text-gray-600">{b.customerName} ({b.customerPhone})</div>
                             {b.notes && <div className="text-xs bg-yellow-50 p-1 mt-1">å‚™è¨»: {b.notes}</div>}
                           </div>
                           <button onClick={() => confirm('åˆªé™¤ï¼Ÿ') && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', b.id))} className="text-red-400"><Icons.Trash2 size={16}/></button>
                         </div>
                       ))}
                    </div>
                )}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppointmentApp />);
  </script>
</body>
</html>
