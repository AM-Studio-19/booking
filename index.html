<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AM Studio ç·šä¸Šé ç´„</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #fdfbf7; color: #5d4037; }
    /* å¡ç‰‡é¸å–®æ¨£å¼ */
    .option-card {
      transition: all 0.2s;
      border: 2px solid #e5e7eb;
    }
    .option-card:hover { border-color: #d7ccc8; }
    .option-card.active {
      border-color: #8d6e63;
      background-color: #efebe9;
      color: #3e2723;
    }
    
    .spinner {
      border: 3px solid #f3f3f3; border-top: 3px solid #8d6e63; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* å¾Œå°æ—¥æ›† */
    .date-cell.selected { background-color: #8d6e63; color: white; font-weight: bold; }
  </style>

  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    const LIFF_ID = '2008567948-KGMPJPGe'; // å·²æ›´æ–°ç‚ºæ­£ç¢º ID
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';

    // --- Init ---
    let db, auth;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.error(e); }

    // --- Icons ---
    const Icon = ({ path, size = 20, className="" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );
    const Icons = {
        map: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
        user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        chevronRight: <path d="m9 18 6-6-6-6"/>,
        chevronLeft: <path d="m15 18-6-6 6-6"/>,
        check: <polyline points="20 6 9 17 4 12"/>,
        settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
        trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
        plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>
    };

    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤', short:'å°å—' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤', short:'é«˜é›„' }
    ];
    const DEFAULT_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];

    // --- Main App ---
    function App() {
      const [user, setUser] = useState(null);
      const [page, setPage] = useState('home'); // home, booking, admin-login, admin
      
      // Booking State
      const [step, setStep] = useState(1);
      const [loc, setLoc] = useState(null);
      const [svc, setSvc] = useState(null);
      const [adds, setAdds] = useState([]);
      const [date, setDate] = useState(new Date());
      const [time, setTime] = useState(null);
      const [customTime, setCustomTime] = useState('');
      const [info, setInfo] = useState({name:'', phone:'', notes:''});
      const [lastOrder, setLastOrder] = useState(null);

      // Data
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [settings, setSettings] = useState({});
      const [booked, setBooked] = useState([]);
      const [liffError, setLiffError] = useState('');

      useEffect(() => {
        auth.signInAnonymously().catch(e => console.warn(e));
        if (window.liff) {
            window.liff.init({ liffId: LIFF_ID })
                .then(() => { if (!window.liff.isLoggedIn()) window.liff.login(); })
                .catch(e => setLiffError(e.message));
        }
        return auth.onAuthStateChanged(setUser);
      }, []);

      useEffect(() => {
        if (!user) return;
        const pub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        pub.collection('services').orderBy('name').onSnapshot(s => setServices(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('addons').onSnapshot(s => setAddons(s.docs.map(d => ({id:d.id, ...d.data()}))));
        pub.collection('settings').onSnapshot(s => { 
            const obj = {}; s.forEach(d => obj[d.id] = d.data()); setSettings(obj); 
        });
      }, [user]);

      // Fetch booked slots
      useEffect(() => {
        if (!loc || !date) return;
        const dStr = date.toISOString().split('T')[0];
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', loc.id).where('date', '==', dStr)
          .onSnapshot(s => setBooked(s.docs.map(d => d.data().time)));
      }, [loc, date]);

      // --- Logic ---
      const isDateOpen = (d) => {
          if (!loc) return true;
          const conf = settings[loc.id];
          if (!conf?.allowedDates?.length) return true; // é è¨­å…¨é–‹
          return conf.allowedDates.includes(d.toISOString().split('T')[0]);
      };
      
      const getSlots = () => {
          if (!loc) return DEFAULT_SLOTS;
          return settings[loc.id]?.timeSlots?.length ? settings[loc.id].timeSlots : DEFAULT_SLOTS;
      };

      const handleSubmit = async () => {
          if (!user) return alert('é€£ç·šä¸­...');
          const tVal = time === 'å¾®èª¿æ™‚æ®µç”³è«‹' ? `å¾®èª¿ ${customTime}` : time;
          const addStr = adds.map(a => a.name).join(', ');
          
          const order = {
              locationId: loc.id, locationName: loc.name,
              serviceId: svc.id, serviceName: svc.name,
              addons: adds, date: date.toISOString().split('T')[0],
              time: tVal, customerName: info.name, customerPhone: info.phone,
              notes: info.notes, status: 'pending', msgSent: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
          };

          try {
              const ref = await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add(order);
              setLastOrder(order);
              
              // LIFF Send
              const msg = `ã€é ç´„é€šçŸ¥ã€‘\nğŸ“ ${order.locationName}\nğŸ“… ${order.date} ${order.time}\nğŸ’… ${order.serviceName}\nâ• ${addStr || 'ç„¡'}\nğŸ‘¤ ${order.customerName}\nğŸ“± ${order.customerPhone}`;
              if (window.liff?.isInClient()) {
                  try {
                      await window.liff.sendMessages([{ type: 'text', text: msg }]);
                      await ref.update({ msgSent: true, status: 'confirmed' });
                  } catch (err) { console.warn('LIFF Send Fail', err); }
              }
              setStep(5);
          } catch (e) { alert('Error: ' + e.message); }
      };

      const reset = () => {
          setStep(1); setLoc(null); setSvc(null); setAdds([]); setTime(null); setCustomTime(''); setInfo({name:'', phone:'', notes:''});
          setPage('home');
      };

      // --- Pages ---
      if (page === 'admin-login') return <AdminLogin onBack={()=>setPage('home')} onLogin={()=>setPage('admin')} />;
      if (page === 'admin') return <AdminPanel user={user} settings={settings} onBack={()=>setPage('home')} services={services} addons={addons} />;

      // --- Home ---
      if (page === 'home') {
          return (
              <div className="min-h-screen flex flex-col items-center justify-center p-6 relative">
                  <button onClick={()=>setPage('admin-login')} className="absolute top-4 left-4 p-2 text-gray-300 hover:text-gray-500"><Icon path={Icons.settings}/></button>
                  <div className="max-w-md w-full text-center space-y-8">
                      <div>
                          <h1 className="text-4xl font-bold tracking-widest text-[#4e342e] mb-2">AM Studio</h1>
                          <p className="text-[#8d6e63] tracking-wider">ç·šä¸Šé ç´„ç³»çµ±</p>
                      </div>
                      <div className="grid gap-4">
                          {LOCATIONS.map(l => (
                              <button key={l.id} onClick={()=>{setLoc(l); setPage('booking'); setStep(2);}} 
                                  className="group bg-white border-2 border-[#e5e7eb] hover:border-[#8d6e63] p-6 rounded-xl flex items-center justify-between transition-all shadow-sm hover:shadow-md">
                                  <div className="flex items-center gap-4">
                                      <div className="w-12 h-12 bg-[#efebe9] rounded-full flex items-center justify-center text-[#5d4037] group-hover:bg-[#8d6e63] group-hover:text-white transition-colors">
                                          <Icon path={Icons.map} size={24}/>
                                      </div>
                                      <div className="text-left">
                                          <h3 className="text-lg font-bold text-[#4e342e]">{l.name}</h3>
                                          <p className="text-xs text-gray-400">é»æ“Šé–‹å§‹é ç´„</p>
                                      </div>
                                  </div>
                                  <div className="text-gray-300 group-hover:text-[#8d6e63]"><Icon path={Icons.chevronRight}/></div>
                              </button>
                          ))}
                      </div>
                      {liffError && <p className="text-xs text-red-300">LIFF Err: {liffError}</p>}
                  </div>
              </div>
          );
      }

      // --- Booking Wizard ---
      return (
          <div className="min-h-screen bg-white md:bg-[#f4f1ea] flex flex-col">
              {/* Header */}
              <div className="bg-white p-4 sticky top-0 z-10 border-b flex items-center justify-between shadow-sm">
                  <button onClick={()=>{ if(step===2) reset(); else setStep(s=>s-1); }} className="p-2 text-[#8d6e63]"><Icon path={Icons.chevronLeft}/></button>
                  <span className="font-bold text-[#4e342e] tracking-widest text-sm">
                      {step===2?'é¸æ“‡é …ç›®':step===3?'é¸æ“‡æ™‚é–“':step===4?'å¡«å¯«è³‡æ–™':'é ç´„å®Œæˆ'}
                  </span>
                  <div className="w-8"></div>
              </div>

              <div className="flex-1 p-6 max-w-lg mx-auto w-full overflow-y-auto">
                  {/* Step 2: æœå‹™é …ç›® (å¡ç‰‡å¼) */}
                  {step === 2 && (
                      <div className="space-y-6 fade-in">
                          <h2 className="text-xl font-bold text-[#4e342e]">è«‹å•ä»Šå¤©æƒ³åšä»€éº¼é …ç›®ï¼Ÿ</h2>
                          <div className="grid gap-3">
                              {services.map(s => (
                                  <button key={s.id} 
                                      onClick={()=>setSvc(s)}
                                      className={`option-card p-4 rounded-xl flex items-center justify-between text-left ${svc?.id===s.id ? 'active' : 'bg-white'}`}>
                                      <div>
                                          <div className="font-bold text-lg">{s.name}</div>
                                          <div className="text-sm opacity-70">${s.price}ãƒ»{s.duration}åˆ†</div>
                                      </div>
                                      {svc?.id===s.id && <Icon path={Icons.check} className="text-[#8d6e63]"/>}
                                  </button>
                              ))}
                          </div>
                          
                          {addons.length > 0 && (
                              <div className="pt-4 border-t border-dashed">
                                  <h3 className="font-bold text-[#4e342e] mb-3 text-sm">åŠ è³¼é …ç›® (å¯è¤‡é¸)</h3>
                                  <div className="grid grid-cols-2 gap-3">
                                      {addons.map(ad => {
                                          const checked = adds.some(a=>a.id===ad.id);
                                          return (
                                              <button key={ad.id} 
                                                  onClick={()=>{ if(checked) setAdds(adds.filter(a=>a.id!==ad.id)); else setAdds([...adds,ad]); }}
                                                  className={`option-card p-3 rounded-lg text-sm text-center ${checked ? 'active' : 'bg-white'}`}>
                                                  <div className="font-bold">{ad.name}</div>
                                                  <div className="text-xs opacity-70">+${ad.price}</div>
                                              </button>
                                          );
                                      })}
                                  </div>
                              </div>
                          )}
                      </div>
                  )}

                  {/* Step 3: æ—¥æœŸæ™‚é–“ */}
                  {step === 3 && (
                      <div className="space-y-6 fade-in">
                          <div className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                              <div className="flex justify-between items-center mb-4">
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()-1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronLeft}/></button>
                                  <span className="font-bold text-lg">{date.getFullYear()}å¹´ {date.getMonth()+1}æœˆ</span>
                                  <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()+1, 1))} className="p-2 bg-gray-50 rounded-full hover:bg-gray-100"><Icon path={Icons.chevronRight}/></button>
                              </div>
                              <div className="grid grid-cols-7 gap-1 text-center mb-2">
                                  {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><span key={d} className="text-xs text-gray-400">{d}</span>)}
                              </div>
                              <div className="grid grid-cols-7 gap-1">
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth(), 1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                                  {Array.from({length: new Date(date.getFullYear(), date.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                      const d = i+1;
                                      const curr = new Date(date.getFullYear(), date.getMonth(), d);
                                      const open = isDateOpen(curr);
                                      const isPast = curr < new Date().setHours(0,0,0,0);
                                      const isSel = d === date.getDate();
                                      return (
                                          <button key={d} disabled={isPast || !open} 
                                              onClick={()=>{setDate(curr); setTime(null);}}
                                              className={`h-9 w-9 rounded-full text-sm flex items-center justify-center transition-all ${isSel?'bg-[#8d6e63] text-white shadow-md':(isPast||!open)?'text-gray-200':'hover:bg-[#efebe9]'}`}>
                                              {d}
                                          </button>
                                      )
                                  })}
                              </div>
                          </div>

                          {isDateOpen(date) ? (
                              <div>
                                  <h3 className="font-bold text-[#4e342e] mb-3 flex items-center gap-2"><Icon path={Icons.clock}/> é¸æ“‡æ™‚æ®µ</h3>
                                  <div className="grid grid-cols-2 gap-3">
                                      {getSlots().map(t => (
                                          <button key={t} disabled={booked.includes(t)}
                                              onClick={()=>{setTime(t); setCustomTime('');}}
                                              className={`option-card py-3 rounded-lg text-sm font-medium ${time===t?'active':'bg-white'} ${booked.includes(t)?'opacity-40 cursor-not-allowed bg-gray-50':''}`}>
                                              {t} {booked.includes(t) && '(å·²æ»¿)'}
                                          </button>
                                      ))}
                                  </div>
                                  {time === 'å¾®èª¿æ™‚æ®µç”³è«‹' && (
                                      <div className="mt-4 bg-[#efebe9] p-4 rounded-xl fade-in">
                                          <label className="text-xs font-bold text-[#8d6e63] block mb-2">è«‹è¼¸å…¥æ‚¨æƒ³é ç´„çš„æ™‚é–“ï¼š</label>
                                          <input type="time" className="w-full p-3 rounded-lg border-none text-center text-xl font-bold text-[#5d4037] bg-white shadow-inner" 
                                              value={customTime} onChange={e=>setCustomTime(e.target.value)} />
                                      </div>
                                  )}
                              </div>
                          ) : (
                              <div className="text-center py-8 bg-gray-50 rounded-xl text-gray-400">
                                  æ­¤æ—¥æœŸæœªé–‹æ”¾ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ
                              </div>
                          )}
                      </div>
                  )}

                  {/* Step 4: è³‡æ–™ */}
                  {step === 4 && (
                      <div className="space-y-6 fade-in">
                          <div className="bg-[#fff8f6] border border-[#f5ebe9] p-5 rounded-xl space-y-3 shadow-sm">
                              <div className="flex justify-between text-sm"><span className="text-gray-500">åœ°é»</span><span className="font-bold">{loc.name}</span></div>
                              <div className="flex justify-between text-sm"><span className="text-gray-500">æ™‚é–“</span><span className="font-bold">{date.toLocaleDateString()} {time==='å¾®èª¿æ™‚æ®µç”³è«‹'?customTime:time}</span></div>
                              <div className="flex justify-between text-sm"><span className="text-gray-500">é …ç›®</span><span className="font-bold">{svc.name}</span></div>
                              {adds.length>0 && <div className="flex justify-between text-sm"><span className="text-gray-500">åŠ è³¼</span><span className="font-bold">{adds.map(a=>a.name).join(',')}</span></div>}
                          </div>
                          
                          <div className="space-y-4">
                              <div>
                                  <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">å§“å</label>
                                  <input className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63]" 
                                      placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" value={info.name} onChange={e=>setInfo({...info,name:e.target.value})} />
                              </div>
                              <div>
                                  <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">é›»è©±</label>
                                  <input className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63]" 
                                      type="tel" placeholder="09xx-xxx-xxx" value={info.phone} onChange={e=>setInfo({...info,phone:e.target.value})} />
                              </div>
                              <div>
                                  <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">å‚™è¨» (é¸å¡«)</label>
                                  <textarea className="w-full p-3 bg-gray-50 rounded-lg border-none focus:ring-2 focus:ring-[#8d6e63] h-24 resize-none" 
                                      placeholder="ä¾‹å¦‚ï¼šéœ€å¸ç”²ã€çš®è†šæ•æ„Ÿ..." value={info.notes} onChange={e=>setInfo({...info,notes:e.target.value})} />
                              </div>
                          </div>
                      </div>
                  )}

                  {/* Step 5: Success */}
                  {step === 5 && (
                      <div className="text-center pt-10 fade-in">
                          <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600">
                              <Icon path={Icons.check} size={40}/>
                          </div>
                          <h2 className="text-2xl font-bold mb-2 text-[#4e342e]">é ç´„é€å‡ºæˆåŠŸï¼</h2>
                          <p className="text-gray-500 text-sm mb-8">æ„Ÿè¬æ‚¨çš„é ç´„ï¼Œæˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è³‡è¨Šã€‚</p>
                          
                          {lastOrder && (
                              <a href={`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('é ç´„:'+lastOrder.serviceName)}&dates=${lastOrder.date.replace(/-/g,'')}T${lastOrder.time.replace(':','')}00/${lastOrder.date.replace(/-/g,'')}T${parseInt(lastOrder.time.substring(0,2))+2}${lastOrder.time.substring(3)}00&details=${encodeURIComponent(lastOrder.customerName)}&location=${encodeURIComponent(lastOrder.locationName)}`} 
                                 target="_blank" 
                                 className="inline-flex items-center gap-2 bg-white border border-gray-200 text-gray-700 px-6 py-3 rounded-xl shadow-sm hover:bg-gray-50 mb-4 w-full justify-center">
                                  <Icon path={Icons.calendar}/> åŠ å…¥ Google æ—¥æ›†
                              </a>
                          )}
                          <button onClick={reset} className="w-full bg-[#8d6e63] text-white py-3 rounded-xl shadow-lg shadow-[#8d6e63]/30">è¿”å›é¦–é </button>
                      </div>
                  )}
              </div>

              {/* Action Button */}
              {step < 5 && (
                  <div className="p-4 bg-white border-t safe-bottom">
                      <button onClick={()=>{
                          if(step===2 && !svc) return alert('è«‹é¸æ“‡æœå‹™é …ç›®');
                          if(step===3) {
                              if(!time) return alert('è«‹é¸æ“‡æ™‚é–“');
                              if(time==='å¾®èª¿æ™‚æ®µç”³è«‹' && !customTime) return alert('è«‹è¼¸å…¥æ™‚é–“');
                          }
                          if(step===4 && (!info.name || !info.phone)) return alert('è«‹å¡«å¯«å§“åé›»è©±');
                          
                          if(step===4) handleSubmit();
                          else setStep(s=>s+1);
                      }} className="w-full bg-[#8d6e63] text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-[#8d6e63]/30 active:scale-[0.98] transition-transform">
                          {step===4 ? 'ç¢ºèªé ç´„' : 'ä¸‹ä¸€æ­¥'}
                      </button>
                  </div>
              )}
          </div>
      );
    }

    // --- Admin Login ---
    const AdminLogin = ({ onBack, onLogin }) => {
        const [pin, setPin] = useState('');
        return (
            <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea] p-6">
                <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                    <h2 className="text-xl font-bold mb-6 text-[#4e342e]">å¾Œå°ç™»å…¥</h2>
                    <input type="password" placeholder="è¼¸å…¥ PIN ç¢¼" className="w-full p-4 bg-gray-50 rounded-xl mb-4 text-center text-xl tracking-widest border focus:border-[#8d6e63] outline-none" 
                        value={pin} onChange={e=>setPin(e.target.value)} />
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={onBack} className="py-3 rounded-xl bg-gray-100 text-gray-500">å–æ¶ˆ</button>
                        <button onClick={()=>pin===ADMIN_PIN?onLogin():alert('å¯†ç¢¼éŒ¯èª¤')} className="py-3 rounded-xl bg-[#8d6e63] text-white font-bold">ç™»å…¥</button>
                    </div>
                </div>
            </div>
        )
    }

    // --- Admin Panel ---
    const AdminPanel = ({ user, settings, onBack, services, addons }) => {
        const [tab, setTab] = useState('book');
        const [books, setBooks] = useState([]);
        const [viewDate, setViewDate] = useState(new Date()); // Calendar view date
        const [editDates, setEditDates] = useState({kaohsiung:'', tainan:''});
        const [editSlots, setEditSlots] = useState({kaohsiung:'', tainan:''});

        useEffect(() => {
            if(settings.kaohsiung) {
                setEditDates(p => ({...p, kaohsiung: settings.kaohsiung.allowedDates?.join(',') || ''}));
                setEditSlots(p => ({...p, kaohsiung: settings.kaohsiung.timeSlots?.join(',') || ''}));
            }
            if(settings.tainan) {
                setEditDates(p => ({...p, tainan: settings.tainan.allowedDates?.join(',') || ''}));
                setEditSlots(p => ({...p, tainan: settings.tainan.timeSlots?.join(',') || ''}));
            }
        }, [settings]);

        useEffect(() => {
            db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
              .orderBy('date', 'desc').limit(50).onSnapshot(s => setBooks(s.docs.map(d=>({id:d.id, ...d.data()}))));
        }, []);

        const toggleDate = (locId, dStr) => {
            const current = editDates[locId].split(',').filter(x=>x);
            const set = new Set(current);
            if(set.has(dStr)) set.delete(dStr); else set.add(dStr);
            setEditDates({...editDates, [locId]: Array.from(set).sort().join(',')});
        };

        const saveSettings = async (locId) => {
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(locId).set({
                allowedDates: editDates[locId].split(',').filter(x=>x),
                timeSlots: editSlots[locId].split(',').filter(x=>x)
            });
            alert('å„²å­˜æˆåŠŸ');
        };

        const renderCalendar = (locId) => {
            const y = viewDate.getFullYear();
            const m = viewDate.getMonth();
            const days = new Date(y, m+1, 0).getDate();
            const start = new Date(y, m, 1).getDay();
            const selected = new Set(editDates[locId].split(','));

            return (
                <div className="bg-white p-4 rounded-xl border shadow-sm">
                    <div className="flex justify-between mb-4">
                        <button onClick={()=>setViewDate(new Date(y, m-1))} className="px-3 py-1 bg-gray-100 rounded">&lt;</button>
                        <span className="font-bold">{y}å¹´ {m+1}æœˆ</span>
                        <button onClick={()=>setViewDate(new Date(y, m+1))} className="px-3 py-1 bg-gray-100 rounded">&gt;</button>
                    </div>
                    <div className="grid grid-cols-7 gap-2 text-center">
                        {Array.from({length:start}).map((_,i)=><div key={'e'+i}/>)}
                        {Array.from({length:days}).map((_,i)=>{
                            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
                            return (
                                <div key={dStr} onClick={()=>toggleDate(locId, dStr)} 
                                    className={`aspect-square flex items-center justify-center rounded-lg text-sm cursor-pointer border ${selected.has(dStr)?'bg-[#8d6e63] text-white border-[#8d6e63]':'border-gray-100 hover:bg-gray-50'}`}>
                                    {i+1}
                                </div>
                            )
                        })}
                    </div>
                </div>
            )
        };

        return (
            <div className="min-h-screen bg-gray-50 pb-20">
                <div className="bg-white p-4 sticky top-0 z-20 border-b flex justify-between items-center shadow-sm">
                    <h2 className="font-bold text-lg">å¾Œå°ç®¡ç†</h2>
                    <button onClick={onBack} className="text-sm bg-gray-100 px-3 py-1 rounded">ç™»å‡º</button>
                </div>
                
                <div className="p-4 space-y-6">
                    {/* Tabs */}
                    <div className="flex bg-white p-1 rounded-xl border">
                        {['book','set','svc'].map(t => (
                            <button key={t} onClick={()=>setTab(t)} className={`flex-1 py-2 rounded-lg text-sm font-bold ${tab===t?'bg-[#8d6e63] text-white':'text-gray-500'}`}>
                                {t==='book'?'é ç´„ç®¡ç†':t==='set'?'ç‡Ÿæ¥­è¨­å®š':'æœå‹™é …ç›®'}
                            </button>
                        ))}
                    </div>

                    {tab === 'book' && (
                        <div className="space-y-4">
                            {books.map(b => (
                                <div key={b.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="font-bold text-lg text-[#8d6e63]">{b.date} {b.time}</div>
                                            <div className="text-xs bg-gray-100 px-2 py-1 rounded inline-block text-gray-500">{b.locationName}</div>
                                        </div>
                                        <div className={`px-2 py-1 rounded text-xs ${b.status==='confirmed'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>
                                            {b.status==='confirmed'?'å·²ç¢ºèª':'å¾…ç¢ºèª'}
                                        </div>
                                    </div>
                                    <div className="py-2 border-t border-b border-dashed my-2 space-y-1">
                                        <div className="font-bold">{b.serviceName}</div>
                                        {b.addons && b.addons.length > 0 && <div className="text-sm text-gray-500">+ {b.addons.map(a=>a.name).join(', ')}</div>}
                                        <div className="text-sm mt-1">{b.customerName} ({b.customerPhone})</div>
                                        <div className="text-xs text-gray-400">{b.notes}</div>
                                    </div>
                                    <div className="flex gap-2 mt-3">
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).update({status: b.status==='confirmed'?'pending':'confirmed'})} className="flex-1 bg-gray-100 py-2 rounded-lg text-xs">åˆ‡æ›ç‹€æ…‹</button>
                                        <button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).delete()} className="px-4 bg-red-50 text-red-500 rounded-lg"><Icon path={Icons.trash}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'set' && (
                        <div className="space-y-8">
                            <div>
                                <h3 className="font-bold text-lg mb-2 text-orange-700">é«˜é›„å·¥ä½œå®¤</h3>
                                {renderCalendar('kaohsiung')}
                                <div className="mt-4 bg-white p-4 rounded-xl border">
                                    <label className="text-xs font-bold text-gray-400 mb-1 block">æ™‚æ®µè¨­å®š (é€—è™Ÿåˆ†éš”)</label>
                                    <input className="w-full p-2 bg-gray-50 rounded border" value={editSlots.kaohsiung} onChange={e=>setEditSlots({...editSlots, kaohsiung:e.target.value})} />
                                    <button onClick={()=>saveSettings('kaohsiung')} className="w-full mt-3 bg-orange-600 text-white py-2 rounded-lg">å„²å­˜é«˜é›„è¨­å®š</button>
                                </div>
                            </div>
                            <div className="border-t pt-6">
                                <h3 className="font-bold text-lg mb-2 text-blue-700">å°å—å·¥ä½œå®¤</h3>
                                {renderCalendar('tainan')}
                                <div className="mt-4 bg-white p-4 rounded-xl border">
                                    <label className="text-xs font-bold text-gray-400 mb-1 block">æ™‚æ®µè¨­å®š (é€—è™Ÿåˆ†éš”)</label>
                                    <input className="w-full p-2 bg-gray-50 rounded border" value={editSlots.tainan} onChange={e=>setEditSlots({...editSlots, tainan:e.target.value})} />
                                    <button onClick={()=>saveSettings('tainan')} className="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg">å„²å­˜å°å—è¨­å®š</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {tab === 'svc' && (
                        <div className="bg-white p-4 rounded-xl border shadow-sm">
                            <p className="text-center text-gray-400 py-8">ç‚ºç¢ºä¿è³‡æ–™å®‰å…¨ï¼Œ<br/>æœå‹™é …ç›®å¢åˆªå»ºè­°ç›´æ¥æ“ä½œè³‡æ–™åº«<br/>æˆ–è¯ç¹«å·¥ç¨‹å¸«ã€‚</p>
                        </div>
                    )}
                </div>
            </div>
        )
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
