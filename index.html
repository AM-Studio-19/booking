<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·šä¸Šé ç´„ç³»çµ±</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #f4f1ea; }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #8d6e63; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #debug-console {
        position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: #fff;
        padding: 10px; font-size: 12px; max-height: 150px; overflow-y: auto; z-index: 9999; display: none;
    }
  </style>

  <!-- æ ¸å¿ƒç¨‹å¼åº« -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body>
  
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #8d6e63;">
      <div class="spinner"></div>
      <p>ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>
  </div>

  <!-- éŒ¯èª¤é¡¯ç¤ºå™¨ (Debug Console) -->
  <div id="error-display" style="display:none; position:fixed; top:0; left:0; right:0; padding:20px; background:#fee2e2; color:#991b1b; border-bottom:2px solid #ef4444; z-index:9999;">
    <h3 style="font-weight:bold; margin-bottom:5px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h3>
    <pre id="error-text" style="white-space:pre-wrap; font-size:12px;"></pre>
    <button onclick="location.reload()" style="margin-top:10px; padding:5px 10px; background:#fff; border:1px solid #991b1b;">é‡æ–°æ•´ç†</button>
  </div>

  <script>
    // å…¨åŸŸéŒ¯èª¤æ””æˆª
    window.onerror = function(msg, url, line) {
        document.getElementById('root').style.display = 'none';
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-text').innerText = `Error: ${msg}\nLine: ${line}\nURL: ${url}`;
        return false;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // ------------------------------------------------------------------
    // âš ï¸âš ï¸âš ï¸ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase è¨­å®š (é€™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥) âš ï¸âš ï¸âš ï¸
    // ------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
       appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    // ------------------------------------------------------------------

    const LIFF_ID = '2008567948-rNVLPLYb';
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';

    // åˆå§‹åŒ– Firebase
    let db, auth;
    let isConfigValid = firebaseConfig.apiKey !== "è«‹å¡«å…¥æ‚¨çš„apiKey";

    if (isConfigValid) {
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error(e);
            document.getElementById('error-text').innerText = "Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message;
            document.getElementById('error-display').style.display = 'block';
        }
    }

    // --- å…ƒä»¶å€ ---
    const Icon = ({ path, size = 24 }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        {path}
      </svg>
    );
    // ç°¡åŒ–åœ–ç¤ºå®šç¾©ä»¥é¿å…èªæ³•éŒ¯èª¤
    const Icons = {
      MapPin: <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>,
      ChevronRight: <path d="m9 18 6-6-6-6"/>,
      ChevronLeft: <path d="m15 18-6-6 6-6"/>,
      Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>,
      Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
      User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
      Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
      FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>,
      CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
      Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
      Plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
      Info: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>
    };

    const LOCATIONS = [{ id: 'tainan', name: 'å°å—å·¥ä½œå®¤' }, { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }];
    const DEFAULT_TIME_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DISCOUNT_NOTE = "â€» å„ªæƒ èº«åˆ†åŒ…å«ï¼šå­¸ç”Ÿã€é†«è­·ã€è»å…¬æ•™ã€ç•¶æœˆå£½æ˜Ÿã€èˆŠå®¢ä»‹ç´¹ (è«‹æ–¼ç¾å ´å‡ºç¤ºè­‰æ˜)";

    function AppointmentApp() {
      // å¦‚æœè¨­å®šç„¡æ•ˆï¼Œé¡¯ç¤ºè­¦å‘Š
      if (!isConfigValid) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-white">
                <div className="text-4xl mb-4">âš ï¸</div>
                <h1 className="text-xl font-bold text-red-600 mb-2">å°šæœªè¨­å®šè³‡æ–™åº«</h1>
                <p className="text-gray-600 mb-2">è«‹ä½¿ç”¨é›»è…¦æ–‡å­—ç·¨è¼¯å™¨é–‹å•Ÿ <code>index.html</code></p>
                <p className="text-gray-600">æœå°‹ <code>const firebaseConfig</code> ä¸¦å¡«å…¥æ‚¨çš„è¨­å®šã€‚</p>
            </div>
        );
      }

      const [user, setUser] = useState(null);
      const [view, setView] = useState('home'); 
      const [bookingStep, setBookingStep] = useState(1);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [selectedService, setSelectedService] = useState(null);
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedTime, setSelectedTime] = useState(null);
      const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', notes: '' });
      
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [bookedSlots, setBookedSlots] = useState([]); 
      const [locationSettings, setLocationSettings] = useState({});
      const [adminPinInput, setAdminPinInput] = useState('');

      useEffect(() => {
        // å®‰å…¨ç™»å…¥ï¼Œè‹¥å¤±æ•—é¡¯ç¤ºéŒ¯èª¤ä½†ä¸ crash
        auth.signInAnonymously().catch(err => {
            console.error("Auth Error", err);
            // é€™è£¡ä¸é˜»æ“‹ï¼Œå› ç‚ºå¾Œå°å¯èƒ½åªéœ€è¦è®€å–
        });
        if (window.liff) window.liff.init({ liffId: LIFF_ID }).catch(e => console.log('Liff init fail', e));
        return auth.onAuthStateChanged(setUser);
      }, []);

      // ç›£è½è³‡æ–™ï¼Œå¢åŠ éŒ¯èª¤è™•ç†ä»¥å…ç™½ç•«é¢
      useEffect(() => {
        if (!user) return;
        const safeSnap = (ref, setter) => ref.onSnapshot(
            snap => setter(snap.docs.map(d => ({id:d.id, ...d.data()}))),
            err => console.error("Data Fetch Error:", err)
        );

        const dbRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        
        safeSnap(dbRef.collection('services').orderBy('name'), setServices);
        safeSnap(dbRef.collection('addons'), setAddons);
        
        dbRef.collection('settings').onSnapshot(snap => {
            const s = {}; snap.forEach(d => s[d.id] = d.data());
            setLocationSettings(s);
        }, err => console.error("Settings Error", err));

      }, [user]);

      // é ç´„è³‡æ–™ç›£è½
      useEffect(() => {
        if (!user || !selectedLocation || !selectedDate) return;
        const dateStr = selectedDate.toISOString().split('T')[0];
        const q = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', selectedLocation.id).where('date', '==', dateStr);
        
        q.onSnapshot(snap => setBookedSlots(snap.docs.map(d => d.data().time)), err => console.error(err));
      }, [user, selectedLocation, selectedDate]);

      // Methods
      const isDateAvailable = (date) => {
        if (!selectedLocation) return true;
        const settings = locationSettings[selectedLocation.id];
        if (!settings?.allowedDates?.length) return true;
        return settings.allowedDates.includes(date.toISOString().split('T')[0]);
      };

      const getCurrentTimeSlots = () => {
        if (!selectedLocation) return DEFAULT_TIME_SLOTS;
        const settings = locationSettings[selectedLocation.id];
        return (settings?.timeSlots?.length) ? settings.timeSlots : DEFAULT_TIME_SLOTS;
      };

      const handleSubmit = async () => {
        if (!user) return alert("å°šæœªé€£ç·šï¼Œè«‹ç¨å¾Œ");
        const data = {
          locationId: selectedLocation.id, locationName: selectedLocation.name,
          serviceId: selectedService.id, serviceName: selectedService.name,
          addons: selectedAddons, date: selectedDate.toISOString().split('T')[0],
          time: selectedTime, customerName: customerInfo.name, customerPhone: customerInfo.phone,
          notes: customerInfo.notes, createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
        };
        try {
          await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add(data);
          const msg = `ã€é ç´„é€šçŸ¥ã€‘\nğŸ  ${data.locationName}\nğŸ“… ${data.date} ${data.time}\nğŸ’† ${data.serviceName}\nğŸ‘¤ ${data.customerName}`;
          if (window.liff?.isInClient()) await window.liff.sendMessages([{ type: 'text', text: msg }]);
          setBookingStep(5);
        } catch (e) { alert('é ç´„å¤±æ•—: ' + e.message); }
      };

      const reset = () => {
        setBookingStep(1); setSelectedLocation(null); setSelectedService(null);
        setSelectedAddons([]); setSelectedTime(null); setCustomerInfo({name:'',phone:'',notes:''}); setView('home');
      };

      // --- Views ---
      if (view === 'admin-login') {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="bg-white p-8 rounded shadow-lg w-80 text-center border">
              <h2 className="text-xl font-bold mb-4">å¾Œå°ç™»å…¥</h2>
              <input type="password" placeholder="PIN" className="w-full border p-2 mb-4" value={adminPinInput} onChange={e=>setAdminPinInput(e.target.value)} />
              <div className="flex gap-2">
                <button onClick={()=>setView('home')} className="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button>
                <button onClick={()=>adminPinInput===ADMIN_PIN?setView('admin-dashboard'):alert('Error')} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">ç™»å…¥</button>
              </div>
            </div>
          </div>
        );
      }

      if (view === 'admin-dashboard') {
        return <AdminDashboard onBack={()=>setView('home')} user={user} services={services} settings={locationSettings} />;
      }

      if (view === 'home') {
        return (
          <div className="min-h-screen p-6 flex flex-col items-center justify-center bg-[#f4f1ea]">
             <button onClick={()=>setView('admin-login')} className="absolute top-4 left-4 p-2 opacity-30"><Icon path={Icons.Settings}/></button>
             <div className="bg-[#fdfbf7] p-8 rounded-sm shadow-xl border border-[#e8e4dc] max-w-md w-full text-center">
                <h1 className="text-3xl font-bold mb-2 text-[#4e342e] tracking-widest">ç·šä¸Šé ç´„</h1>
                <p className="text-[#8d6e63] mb-8 text-sm">è«‹é¸æ“‡æœå‹™æ“šé»</p>
                <div className="space-y-4">
                  {LOCATIONS.map(loc => (
                    <button key={loc.id} onClick={()=>{setSelectedLocation(loc); setView('booking'); setBookingStep(2)}} 
                      className="w-full bg-white border-2 border-[#d7ccc8] hover:border-[#8d6e63] p-6 rounded-lg flex items-center justify-between group transition-all">
                      <div className="flex items-center gap-4">
                        <span className="bg-[#efebe9] p-3 rounded-full text-[#5d4037]"><Icon path={Icons.MapPin}/></span>
                        <h3 className="text-xl font-bold text-[#4e342e]">{loc.name}</h3>
                      </div>
                      <span className="text-[#d7ccc8] group-hover:text-[#8d6e63]"><Icon path={Icons.ChevronRight}/></span>
                    </button>
                  ))}
                </div>
             </div>
          </div>
        );
      }

      // Booking UI
      return (
        <div className="min-h-screen py-6 px-4 bg-[#f4f1ea]">
          <div className="max-w-lg mx-auto bg-[#fdfbf7] min-h-[85vh] rounded-sm shadow-xl border border-[#e8e4dc] flex flex-col">
            <div className="p-6 border-b border-[#e8e4dc] flex items-center justify-between bg-white/50">
               <button onClick={()=>bookingStep===2?reset():setBookingStep(s=>s-1)} className="text-[#8d6e63]"><Icon path={Icons.ChevronLeft}/></button>
               <span className="font-bold text-[#4e342e]">{bookingStep===2?'é¸æ“‡æœå‹™':bookingStep===3?'é¸æ“‡æ™‚é–“':'è³‡æ–™ç¢ºèª'}</span>
               <div className="w-6"></div>
            </div>
            <div className="flex-1 p-6 overflow-y-auto">
              {bookingStep===2 && (
                <div className="space-y-6">
                  <div className="bg-[#efebe9]/50 p-4 rounded text-xs text-[#6d4c41] flex gap-2"><span className="mt-0.5"><Icon path={Icons.Info} size={16}/></span>{DISCOUNT_NOTE}</div>
                  <div className="grid gap-3">
                    {services.map(s=>(
                      <label key={s.id} className={`flex items-center justify-between p-4 border rounded-lg cursor-pointer ${selectedService?.id===s.id?'border-[#8d6e63] bg-[#efebe9]':'border-gray-200'}`}>
                        <div className="flex items-center gap-3">
                          <input type="radio" name="svc" className="accent-[#8d6e63] w-5 h-5" checked={selectedService?.id===s.id} onChange={()=>setSelectedService(s)}/>
                          <div><div className="font-bold">{s.name}</div><div className="text-sm text-[#8d6e63]">${s.price} / {s.duration}åˆ†</div></div>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>
              )}
              {bookingStep===3 && (
                 <div className="space-y-6">
                   <div className="bg-white p-4 rounded border shadow-sm">
                     <div className="flex justify-between items-center mb-4">
                       <button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()-1)))} className="p-1 hover:bg-gray-100"><Icon path={Icons.ChevronLeft}/></button>
                       <span className="font-bold">{selectedDate.getFullYear()}/{selectedDate.getMonth()+1}</span>
                       <button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()+1)))} className="p-1 hover:bg-gray-100"><Icon path={Icons.ChevronRight}/></button>
                     </div>
                     <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d} className="text-xs text-gray-400">{d}</div>)}</div>
                     <div className="grid grid-cols-7 gap-1">
                        {Array.from({length:new Date(selectedDate.getFullYear(),selectedDate.getMonth(),1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                        {Array.from({length:new Date(selectedDate.getFullYear(),selectedDate.getMonth()+1,0).getDate()}).map((_,i)=>{
                            const d=i+1, cur=new Date(selectedDate.getFullYear(),selectedDate.getMonth(),d), avail=isDateAvailable(cur), past=cur<new Date().setHours(0,0,0,0);
                            const isSel=d===selectedDate.getDate();
                            return <button key={d} disabled={past||!avail} onClick={()=>{setSelectedDate(cur);setSelectedTime(null)}} 
                              className={`h-8 w-8 rounded-full text-sm mx-auto flex items-center justify-center relative ${isSel?'bg-[#8d6e63] text-white':past||!avail?'text-gray-200':'hover:bg-[#efebe9]'}`}>
                              {d}{!past&&avail&&!isSel&&<div className="absolute bottom-1 w-1 h-1 bg-[#8d6e63] rounded-full"/>}
                            </button>
                        })}
                     </div>
                   </div>
                   {isDateAvailable(selectedDate)?(
                     <div className="grid grid-cols-2 gap-3">
                       {getCurrentTimeSlots().map(t=>(
                         <button key={t} disabled={bookedSlots.includes(t)} onClick={()=>setSelectedTime(t)} className={`py-3 rounded border text-sm ${selectedTime===t?'bg-[#8d6e63] text-white':bookedSlots.includes(t)?'bg-gray-100 text-gray-300':'bg-white hover:border-[#8d6e63]'}`}>{t}</button>
                       ))}
                     </div>
                   ):<div className="text-center text-red-400 text-sm">æœªé–‹æ”¾é ç´„</div>}
                 </div>
              )}
              {bookingStep===4 && (
                <div className="space-y-4">
                  <div className="bg-[#efebe9] p-4 rounded text-sm space-y-2 border border-[#d7ccc8]">
                    <div className="flex justify-between"><span className="text-[#a1887f]">åœ°é»</span><b>{selectedLocation?.name}</b></div>
                    <div className="flex justify-between"><span className="text-[#a1887f]">æ™‚é–“</span><b>{selectedDate.toLocaleDateString()} {selectedTime}</b></div>
                    <div className="flex justify-between"><span className="text-[#a1887f]">é …ç›®</span><b>{selectedService?.name}</b></div>
                  </div>
                  <input type="text" placeholder="å§“å" className="w-full border-b-2 bg-transparent py-2 outline-none" value={customerInfo.name} onChange={e=>setCustomerInfo({...customerInfo,name:e.target.value})}/>
                  <input type="tel" placeholder="é›»è©±" className="w-full border-b-2 bg-transparent py-2 outline-none" value={customerInfo.phone} onChange={e=>setCustomerInfo({...customerInfo,phone:e.target.value})}/>
                  <textarea placeholder="å‚™è¨»" className="w-full border-b-2 bg-transparent py-2 outline-none resize-none" rows={2} value={customerInfo.notes} onChange={e=>setCustomerInfo({...customerInfo,notes:e.target.value})}/>
                </div>
              )}
              {bookingStep===5 && (
                <div className="text-center py-10">
                  <div className="text-green-600 mb-4"><Icon path={Icons.CheckCircle} size={48}/></div>
                  <h2 className="text-2xl font-bold mb-6">é ç´„æˆåŠŸï¼</h2>
                  <button onClick={reset} className="bg-[#8d6e63] text-white px-8 py-3 rounded">å›é¦–é </button>
                </div>
              )}
            </div>
            {bookingStep<5 && (
              <div className="p-6 border-t bg-white/50">
                <button onClick={()=>{
                   if(bookingStep===2&&!selectedService)return alert('è«‹é¸æ“‡æœå‹™');
                   if(bookingStep===3&&!selectedTime)return alert('è«‹é¸æ“‡æ™‚é–“');
                   if(bookingStep===4&&(!customerInfo.name||!customerInfo.phone))return alert('è«‹å¡«å¯«è³‡æ–™');
                   bookingStep===4?handleSubmit():setBookingStep(s=>s+1);
                }} className="w-full bg-[#8d6e63] text-white py-3 rounded shadow hover:bg-[#795548]">{bookingStep===4?'ç¢ºèªé ç´„':'ä¸‹ä¸€æ­¥'}</button>
              </div>
            )}
          </div>
        </div>
      );
    }

    function AdminDashboard({ onBack, user, services, settings }) {
      const [tab, setTab] = useState('set');
      const [books, setBooks] = useState([]);
      const [kaD, setKaD] = useState(settings['kaohsiung']?.allowedDates?.join(',')||'');
      const [kaT, setKaT] = useState(settings['kaohsiung']?.timeSlots?.join(',')||DEFAULT_TIME_SLOTS.join(','));
      const [taD, setTaD] = useState(settings['tainan']?.allowedDates?.join(',')||'');
      const [taT, setTaT] = useState(settings['tainan']?.timeSlots?.join(',')||DEFAULT_TIME_SLOTS.join(','));

      useEffect(()=>{
        if(!user)return;
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').orderBy('date','desc').onSnapshot(s=>setBooks(s.docs.map(d=>({id:d.id,...d.data()}))));
      },[user]);

      const save = async (id, d, t) => {
        await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(id).set({
          allowedDates: d.split(',').map(x=>x.trim()).filter(x=>x), timeSlots: t.split(',').map(x=>x.trim()).filter(x=>x)
        }); alert('Saved');
      };

      const init = async () => {
         if(!confirm('Reset Services?'))return;
         const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services');
         [{name:'éœ§çœ‰(ä¸€èˆ¬)',price:4800,duration:90},{name:'éœ§çœ‰(å„ªæƒ )',price:4600,duration:90},{name:'éœ§å”‡(ä¸€èˆ¬)',price:5200,duration:120},{name:'éœ§å”‡(å„ªæƒ )',price:5000,duration:120}].forEach(d=>ref.add(d));
         alert('Done');
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4">
           <div className="bg-white rounded shadow max-w-4xl mx-auto overflow-hidden">
             <div className="flex justify-between p-4 border-b"><b>å¾Œå°ç®¡ç†</b><button onClick={onBack} className="bg-gray-500 text-white px-3 py-1 rounded text-sm">é›¢é–‹</button></div>
             <div className="flex border-b text-sm"><button onClick={()=>setTab('set')} className={`flex-1 py-3 ${tab==='set'?'text-[#8d6e63] font-bold':''}`}>è¨­å®š</button><button onClick={()=>setTab('svc')} className={`flex-1 py-3 ${tab==='svc'?'text-[#8d6e63] font-bold':''}`}>æœå‹™</button><button onClick={()=>setTab('book')} className={`flex-1 py-3 ${tab==='book'?'text-[#8d6e63] font-bold':''}`}>é ç´„</button></div>
             <div className="p-4">
               {tab==='set' && (
                 <div className="space-y-4 text-sm">
                   <div className="border p-3 rounded bg-orange-50">
                     <b className="text-orange-800 block mb-2">é«˜é›„</b>
                     <textarea className="w-full border p-2 h-16 mb-2" value={kaD} onChange={e=>setKaD(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)"/>
                     <button onClick={()=>setKaD("2025-12-12,2025-12-13,2025-12-14,2025-12-15,2025-12-26,2025-12-27,2025-12-28,2025-12-29")} className="text-blue-600 underline text-xs mb-2 block">åŒ¯å…¥12æœˆ</button>
                     <input className="w-full border p-2 mb-2" value={kaT} onChange={e=>setKaT(e.target.value)}/>
                     <button onClick={()=>save('kaohsiung',kaD,kaT)} className="bg-orange-600 text-white px-3 py-1 rounded">å„²å­˜</button>
                   </div>
                   <div className="border p-3 rounded bg-blue-50">
                     <b className="text-blue-800 block mb-2">å°å—</b>
                     <textarea className="w-full border p-2 h-16 mb-2" value={taD} onChange={e=>setTaD(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)"/>
                     <input className="w-full border p-2 mb-2" value={taT} onChange={e=>setTaT(e.target.value)}/>
                     <button onClick={()=>save('tainan',taD,taT)} className="bg-blue-800 text-white px-3 py-1 rounded">å„²å­˜</button>
                   </div>
                 </div>
               )}
               {tab==='svc' && (
                 <div>
                   <button onClick={init} className="bg-yellow-600 text-white px-3 py-1 rounded text-sm mb-4">é‡ç½®é è¨­æœå‹™</button>
                   <div className="space-y-2">{services.map(s=><div key={s.id} className="flex justify-between border p-2 rounded text-sm"><span>{s.name} (${s.price})</span><button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-500"><Icon path={Icons.Trash2} size={16}/></button></div>)}</div>
                   <button onClick={async()=>{const n=prompt('å');const p=prompt('åƒ¹');if(n&&p)await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({name:n,price:Number(p),duration:90})}} className="mt-4 border border-[#8d6e63] text-[#8d6e63] px-4 py-2 rounded flex items-center gap-2 text-sm"><Icon path={Icons.Plus} size={16}/>æ–°å¢</button>
                 </div>
               )}
               {tab==='book' && (
                 <div className="space-y-2">{books.map(b=><div key={b.id} className="border-b p-2 text-sm flex justify-between"><div><div className="font-bold text-[#8d6e63]">{b.date} {b.time}</div><div>{b.serviceName} - {b.customerName}</div></div><button onClick={()=>confirm('Del?')&&db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).delete()} className="text-red-400"><Icon path={Icons.Trash2} size={16}/></button></div>)}</div>
               )}
             </div>
           </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppointmentApp />);
  </script>
</body>
</html>    };

    // --- åˆå§‹åŒ– Firebase (Compat å†™æ³•) ---
    let db, auth;
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
      auth = firebase.auth();
    } catch (e) {
      console.error("Firebase Init Error:", e);
    }

    // --- åœ–ç¤ºå…ƒä»¶ ---
    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );
    const Icons = {
      MapPin: (p) => <Icon {...p} path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />,
      ChevronRight: (p) => <Icon {...p} path={<path d="m9 18 6-6-6-6"/>} />,
      ChevronLeft: (p) => <Icon {...p} path={<path d="m15 18-6-6 6-6"/>} />,
      Settings: (p) => <Icon {...p} path={<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>} /> ,
      Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
      User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
      Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />,
      FileText: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} />,
      CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
      Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
      Plus: (p) => <Icon {...p} path={<><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>} />,
      Info: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>} />
    };

    // --- å¸¸æ•¸è³‡æ–™ ---
    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }
    ];
    const DEFAULT_TIME_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DISCOUNT_NOTE = "â€» å„ªæƒ èº«åˆ†åŒ…å«ï¼šå­¸ç”Ÿã€é†«è­·ã€è»å…¬æ•™ã€ç•¶æœˆå£½æ˜Ÿã€èˆŠå®¢ä»‹ç´¹ (è«‹æ–¼ç¾å ´å‡ºç¤ºè­‰æ˜)";

    // --- ä¸»ç¨‹å¼ ---
    function AppointmentApp() {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('home'); 
      const [bookingStep, setBookingStep] = useState(1);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [selectedService, setSelectedService] = useState(null);
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedTime, setSelectedTime] = useState(null);
      const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', notes: '' });
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [bookedSlots, setBookedSlots] = useState([]); 
      const [locationSettings, setLocationSettings] = useState({});
      const [adminPinInput, setAdminPinInput] = useState('');

      // åˆå§‹åŒ–
      useEffect(() => {
        if (!auth) return;
        auth.signInAnonymously().catch(console.error);
        if (window.liff) {
          window.liff.init({ liffId: LIFF_ID }).catch(err => console.log('LIFF error', err));
        }
        return auth.onAuthStateChanged(setUser);
      }, []);

      // ç›£è½è³‡æ–™åº«
      useEffect(() => {
        if (!user || !db) return;
        
        const settingsRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings');
        const servicesRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services');
        const addonsRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('addons');

        const unsubSet = settingsRef.onSnapshot(snap => {
           const s = {}; snap.forEach(d => s[d.id] = d.data()); setLocationSettings(s);
        });
        const unsubS = servicesRef.orderBy('name').onSnapshot(snap => {
           setServices(snap.docs.map(d => ({id:d.id, ...d.data()})));
        });
        const unsubA = addonsRef.onSnapshot(snap => {
           setAddons(snap.docs.map(d => ({id:d.id, ...d.data()})));
        });

        return () => { unsubSet(); unsubS(); unsubA(); };
      }, [user]);

      // ç›£è½è©²æ—¥é ç´„
      useEffect(() => {
        if (!user || !selectedLocation || !selectedDate || !db) return;
        const dateStr = selectedDate.toISOString().split('T')[0];
        
        const q = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', selectedLocation.id)
          .where('date', '==', dateStr);

        const unsub = q.onSnapshot(snap => {
          setBookedSlots(snap.docs.map(d => d.data().time));
        });
        return () => unsub();
      }, [user, selectedLocation, selectedDate]);

      // å·¥å…·å‡½å¼
      const isDateAvailable = (date) => {
        if (!selectedLocation) return true;
        const settings = locationSettings[selectedLocation.id];
        if (!settings || !settings.allowedDates || settings.allowedDates.length === 0) return true;
        return settings.allowedDates.includes(date.toISOString().split('T')[0]);
      };

      const getCurrentTimeSlots = () => {
        if (!selectedLocation) return DEFAULT_TIME_SLOTS;
        const settings = locationSettings[selectedLocation.id];
        if (settings && settings.timeSlots && settings.timeSlots.length > 0) return settings.timeSlots;
        return DEFAULT_TIME_SLOTS;
      };

      const handleSubmitBooking = async () => {
        if (!user || !db) return alert("é€£ç·šéŒ¯èª¤");
        
        const bookingData = {
          locationId: selectedLocation.id,
          locationName: selectedLocation.name,
          serviceId: selectedService.id,
          serviceName: selectedService.name,
          addons: selectedAddons,
          date: selectedDate.toISOString().split('T')[0],
          time: selectedTime,
          customerName: customerInfo.name,
          customerPhone: customerInfo.phone,
          notes: customerInfo.notes,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          userId: user.uid
        };

        try {
          await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add(bookingData);
          
          const msg = `ã€é ç´„é€šçŸ¥ã€‘\n` +
            `ğŸ  ${bookingData.locationName}\n` +
            `ğŸ“… ${bookingData.date} ${bookingData.time}\n` +
            `ğŸ’† ${bookingData.serviceName}\n` +
            `ğŸ‘¤ ${bookingData.customerName}`;
          
          if (window.liff && window.liff.isInClient()) {
            await window.liff.sendMessages([{ type: 'text', text: msg }]);
          }
          setBookingStep(5);
        } catch (e) {
          console.error(e);
          alert('é ç´„å¤±æ•—: ' + e.message);
        }
      };

      const resetBooking = () => {
        setBookingStep(1);
        setSelectedLocation(null);
        setSelectedService(null);
        setSelectedAddons([]);
        setSelectedTime(null);
        setCustomerInfo({ name: '', phone: '', notes: '' });
        setView('home');
      };

      // Admin Login
      if (view === 'admin-login') {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea]">
            <div className="bg-white p-8 rounded shadow-lg max-w-sm w-full text-center border border-[#d7ccc8]">
              <h2 className="text-xl font-bold mb-4 text-[#5d4037]">å¾Œå°ç™»å…¥</h2>
              <input type="password" placeholder="PIN" className="w-full border p-2 mb-4 rounded outline-none" value={adminPinInput} onChange={e => setAdminPinInput(e.target.value)} />
              <div className="flex gap-2">
                <button onClick={() => setView('home')} className="flex-1 bg-gray-200 py-2 rounded text-[#5d4037]">å–æ¶ˆ</button>
                <button onClick={() => adminPinInput === ADMIN_PIN ? setView('admin-dashboard') : alert('å¯†ç¢¼éŒ¯èª¤')} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">ç™»å…¥</button>
              </div>
            </div>
          </div>
        );
      }

      // Admin Dashboard
      if (view === 'admin-dashboard') {
        return <AdminDashboard onBack={() => setView('home')} user={user} services={services} settings={locationSettings} />;
      }

      // Home
      if (view === 'home') {
        return (
          <div className="min-h-screen p-6 flex flex-col items-center justify-center" style={{backgroundImage: `linear-gradient(90deg, transparent 50%, rgba(255,255,255,.3) 50%), linear-gradient(transparent 50%, rgba(244,241,234,0.1) 50%)`, backgroundSize: '20px 20px'}}>
            <button onClick={() => setView('admin-login')} className="absolute top-4 left-4 p-2 text-[#8d6e63] opacity-30 hover:opacity-100"><Icons.Settings /></button>
            <div className="max-w-md w-full relative">
              <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 -rotate-2 w-32 h-8 bg-[#d7ccc8] opacity-80 shadow-sm z-10"></div>
              <div className="bg-[#fdfbf7] p-8 pt-10 rounded-sm shadow-xl border border-[#e8e4dc]">
                <h1 className="text-3xl font-bold text-center mb-2 tracking-widest text-[#4e342e]">ç·šä¸Šé ç´„</h1>
                <p className="text-center text-[#8d6e63] mb-8 text-sm">è«‹é¸æ“‡æœå‹™æ“šé»</p>
                <div className="space-y-4">
                  {LOCATIONS.map(loc => (
                    <button key={loc.id} onClick={() => { setSelectedLocation(loc); setView('booking'); setBookingStep(2); }} className="w-full bg-white border-2 border-[#d7ccc8] hover:border-[#8d6e63] p-6 rounded-lg transition-all flex items-center justify-between group">
                      <div className="flex items-center gap-4">
                        <div className="bg-[#efebe9] p-3 rounded-full text-[#5d4037]"><Icons.MapPin /></div>
                        <h3 className="text-xl font-bold text-[#4e342e]">{loc.name}</h3>
                      </div>
                      <span className="text-[#d7ccc8] group-hover:text-[#8d6e63]"><Icons.ChevronRight /></span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Booking Process
      return (
        <div className="min-h-screen py-6 px-4 font-serif text-[#5d4037]">
            <div className="max-w-lg mx-auto bg-[#fdfbf7] min-h-[85vh] rounded-sm shadow-xl border border-[#e8e4dc] flex flex-col">
               <div className="p-6 border-b border-[#e8e4dc] flex items-center justify-between bg-white/50">
                  <button onClick={() => bookingStep === 2 ? resetBooking() : setBookingStep(s => s - 1)} className="text-[#8d6e63]"><Icons.ChevronLeft /></button>
                  <span className="font-bold tracking-widest text-[#4e342e]">{bookingStep === 2 ? 'é¸æ“‡æœå‹™' : bookingStep === 3 ? 'é¸æ“‡æ™‚é–“' : 'ç¢ºèªè³‡æ–™'}</span>
                  <div className="w-6"></div> 
               </div>

               <div className="flex-1 p-6 overflow-y-auto">
                 {bookingStep === 2 && (
                   <div className="space-y-6">
                     <div className="bg-[#efebe9]/50 p-4 rounded text-xs text-[#6d4c41] flex gap-2 items-start leading-relaxed">
                       <span className="shrink-0 mt-0.5"><Icons.Info size={16}/></span> {DISCOUNT_NOTE}
                     </div>
                     <div className="grid gap-3">
                        {services.length === 0 && <div className="text-center text-gray-400 py-4">è¼‰å…¥ä¸­...</div>}
                        {services.map(svc => (
                           <label key={svc.id} className={`relative flex items-center justify-between p-4 border rounded-lg cursor-pointer transition-all ${selectedService?.id === svc.id ? 'border-[#8d6e63] bg-[#efebe9]' : 'border-gray-200 hover:border-[#d7ccc8]'}`}>
                             <div className="flex items-center gap-3">
                               <input type="radio" name="service" className="accent-[#8d6e63] w-5 h-5" checked={selectedService?.id === svc.id} onChange={() => setSelectedService(svc)} />
                               <div>
                                 <div className="font-bold text-lg">{svc.name}</div>
                                 <div className="text-sm text-[#8d6e63] flex gap-2 items-center">
                                   <span>â± {svc.duration} åˆ†</span>
                                   <span className="font-bold text-[#5d4037]">${svc.price}</span>
                                 </div>
                               </div>
                             </div>
                             {svc.name.includes("å„ªæƒ ") && <div className="absolute top-2 right-2 text-[10px] bg-[#8d6e63] text-white px-2 py-0.5 rounded-full">å„ªæƒ </div>}
                           </label>
                         ))}
                     </div>
                   </div>
                 )}

                 {bookingStep === 3 && (
                   <div className="space-y-6">
                     <div className="bg-white p-4 rounded-lg border border-[#e8e4dc] shadow-sm">
                       <div className="flex justify-between items-center mb-4">
                         <button onClick={() => setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth() - 1)))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronLeft/></button>
                         <span className="font-bold text-lg">{selectedDate.getFullYear()}å¹´ {selectedDate.getMonth() + 1}æœˆ</span>
                         <button onClick={() => setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth() + 1)))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronRight/></button>
                       </div>
                       <div className="grid grid-cols-7 gap-1 text-center text-sm mb-2 text-[#a1887f]">
                         {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d}>{d}</div>)}
                       </div>
                       <div className="grid grid-cols-7 gap-1 text-center">
                         {Array.from({ length: new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay() }).map((_, i) => <div key={`empty-${i}`}></div>)}
                         {Array.from({ length: new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate() }).map((_, i) => {
                           const d = i + 1;
                           const current = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d);
                           const isSelected = d === selectedDate.getDate();
                           const isPast = current < new Date().setHours(0,0,0,0);
                           const available = isDateAvailable(current);
                           return (
                             <button key={d} disabled={isPast || !available} onClick={() => { setSelectedDate(current); setSelectedTime(null); }}
                               className={`p-2 rounded-full w-8 h-8 flex items-center justify-center mx-auto text-sm transition-colors relative
                                 ${isSelected ? 'bg-[#8d6e63] text-white' : ''}
                                 ${!isSelected && available && !isPast ? 'hover:bg-[#efebe9] text-[#5d4037]' : ''}
                                 ${(isPast || !available) ? 'text-gray-200 cursor-not-allowed' : ''}
                               `}>
                               {d}
                               {!isPast && available && !isSelected && <div className="absolute bottom-1 w-1 h-1 bg-[#8d6e63] rounded-full"></div>}
                             </button>
                           );
                         })}
                       </div>
                     </div>
                     
                     {isDateAvailable(selectedDate) ? (
                       <div>
                         <h3 className="text-lg font-bold mb-3 flex items-center gap-2"><Icons.Clock size={18}/> é¸æ“‡æ™‚æ®µ</h3>
                         <div className="grid grid-cols-2 gap-3">
                           {getCurrentTimeSlots().map(time => {
                             const isBooked = bookedSlots.includes(time);
                             return (
                               <button key={time} disabled={isBooked} onClick={() => setSelectedTime(time)}
                                 className={`py-3 px-2 text-sm rounded border transition-all text-center ${selectedTime === time ? 'bg-[#8d6e63] text-white border-[#8d6e63]' : isBooked ? 'bg-gray-100 text-gray-300 border-gray-100 cursor-not-allowed' : 'bg-white border-[#d7ccc8] hover:border-[#8d6e63] text-[#5d4037]'}`}>
                                 {time} {isBooked && '(å·²æ»¿)'}
                               </button>
                             )
                           })}
                         </div>
                       </div>
                     ) : <div className="text-center text-red-400 text-sm">è©²æ—¥æœŸå°šæœªé–‹æ”¾é ç´„ã€‚</div>}
                   </div>
                 )}

                 {bookingStep === 4 && (
                   <div className="space-y-6">
                     <div className="bg-[#efebe9] p-4 rounded-lg text-sm space-y-2 border border-[#d7ccc8]">
                        <div className="flex justify-between"><span className="text-[#a1887f]">åœ°é»</span> <span className="font-bold">{selectedLocation?.name}</span></div>
                        <div className="flex justify-between"><span className="text-[#a1887f]">æ™‚é–“</span> <span className="font-bold">{selectedDate.toLocaleDateString()} {selectedTime}</span></div>
                        <div className="flex justify-between"><span className="text-[#a1887f]">é …ç›®</span> <span className="font-bold">{selectedService?.name}</span></div>
                     </div>
                     <div className="space-y-4">
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">å§“å</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.User size={18}/></span>
                                <input type="text" className="w-full bg-transparent outline-none" value={customerInfo.name} onChange={e => setCustomerInfo({...customerInfo, name: e.target.value})} placeholder="è«‹è¼¸å…¥å§“å" />
                           </div>
                       </div>
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">é›»è©±</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.Phone size={18}/></span>
                                <input type="tel" className="w-full bg-transparent outline-none" value={customerInfo.phone} onChange={e => setCustomerInfo({...customerInfo, phone: e.target.value})} placeholder="09xx-xxx-xxx" />
                           </div>
                       </div>
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">å‚™è¨»</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.FileText size={18}/></span>
                                <textarea className="w-full bg-transparent outline-none resize-none" rows={2} value={customerInfo.notes} onChange={e => setCustomerInfo({...customerInfo, notes: e.target.value})} placeholder="è‹¥é¸æ“‡å¾®èª¿æ™‚æ®µï¼Œè«‹åœ¨æ­¤å¡«å¯«å¸Œæœ›çš„æ™‚é–“" />
                           </div>
                       </div>
                     </div>
                   </div>
                 )}

                 {bookingStep === 5 && (
                   <div className="text-center py-10">
                     <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><span className="text-green-600"><Icons.CheckCircle size={48}/></span></div>
                     <h2 className="text-2xl font-bold text-[#4e342e] mb-2">é ç´„æˆåŠŸï¼</h2>
                     <button onClick={resetBooking} className="bg-[#8d6e63] text-white px-8 py-3 rounded shadow mt-6">è¿”å›é¦–é </button>
                   </div>
                 )}
               </div>

               {bookingStep < 5 && (
                 <div className="p-6 border-t border-[#e8e4dc] bg-white/50">
                   <button onClick={() => {
                       if (bookingStep === 2 && !selectedService) return alert('è«‹é¸æ“‡æœå‹™');
                       if (bookingStep === 3 && !selectedTime) return alert('è«‹é¸æ“‡æ™‚æ®µ');
                       if (bookingStep === 4 && (!customerInfo.name || !customerInfo.phone)) return alert('è«‹å¡«å¯«è³‡æ–™');
                       if (bookingStep === 4) handleSubmitBooking();
                       else setBookingStep(s => s + 1);
                     }}
                     className="w-full bg-[#8d6e63] text-white py-3 rounded-md font-bold tracking-widest shadow-md hover:bg-[#795548] transition-all">
                     {bookingStep === 4 ? 'ç¢ºèªé ç´„' : 'ä¸‹ä¸€æ­¥'}
                   </button>
                 </div>
               )}
            </div>
        </div>
      );
    }

    // --- Admin Dashboard (Compat å¯«æ³•) ---
    function AdminDashboard({ onBack, user, services, settings }) {
      const [activeTab, setActiveTab] = useState('settings'); 
      const [bookings, setBookings] = useState([]);
      const [tainanDates, setTainanDates] = useState(settings['tainan']?.allowedDates?.join(',') || '');
      const [kaohsiungDates, setKaohsiungDates] = useState(settings['kaohsiung']?.allowedDates?.join(',') || '');
      const [kaohsiungSlots, setKaohsiungSlots] = useState(settings['kaohsiung']?.timeSlots?.join(',') || DEFAULT_TIME_SLOTS.join(','));
      const [tainanSlots, setTainanSlots] = useState(settings['tainan']?.timeSlots?.join(',') || DEFAULT_TIME_SLOTS.join(','));

      useEffect(() => {
        if (!user || !db) return;
        const unsub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .orderBy('date', 'desc')
          .onSnapshot(snap => setBookings(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        return () => unsub();
      }, [user]);

      const saveSettings = async (locId, datesStr, slotsStr) => {
        const dates = datesStr.split(',').map(d => d.trim()).filter(d => d);
        const slots = slotsStr.split(',').map(s => s.trim()).filter(s => s);
        await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(locId).set({
           allowedDates: dates, timeSlots: slots
        });
        alert('å„²å­˜æˆåŠŸ');
      };

      const initDefaults = async () => {
        if (!confirm('å°‡é‡ç½®æœå‹™åˆ—è¡¨ï¼Œç¢ºå®šï¼Ÿ')) return;
        const batch = db.batch();
        // åˆªé™¤èˆŠçš„ (é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥å»ºç«‹æ–°çš„ï¼Œå»ºè­°æ‰‹å‹•åˆªé™¤èˆŠçš„æˆ–ä¸€å€‹å€‹åˆª)
        // ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œé€™è£¡ä¸è‡ªå‹•åˆªé™¤ï¼Œåªæ–°å¢
        const colRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services');
        const defaults = [
            { name: 'éœ§çœ‰ (ä¸€èˆ¬é ç´„)', price: 4800, duration: 90 },
            { name: 'éœ§çœ‰ (å„ªæƒ èº«åˆ†)', price: 4600, duration: 90 },
            { name: 'éœ§å”‡ (ä¸€èˆ¬é ç´„)', price: 5200, duration: 120 },
            { name: 'éœ§å”‡ (å„ªæƒ èº«åˆ†)', price: 5000, duration: 120 },
        ];
        defaults.forEach(d => { colRef.add(d); });
        alert('æœå‹™å·²æ–°å¢');
      };

      return (
        <div className="min-h-screen bg-gray-50 p-6 font-sans">
          <div className="max-w-4xl mx-auto bg-white shadow rounded-lg overflow-hidden">
            <div className="flex justify-between items-center p-6 border-b">
              <h2 className="text-xl font-bold text-gray-800">å¾Œå°ç®¡ç†</h2>
              <button onClick={onBack} className="bg-gray-500 text-white px-4 py-2 rounded text-sm">é€€å‡º</button>
            </div>
            <div className="flex border-b bg-gray-50">
              {['settings', 'services', 'bookings'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 font-bold text-sm ${activeTab === tab ? 'bg-white text-[#8d6e63] border-t-2 border-[#8d6e63]' : 'text-gray-500'}`}>
                    {tab === 'settings' ? 'ç‡Ÿæ¥­è¨­å®š' : tab === 'services' ? 'æœå‹™é …ç›®' : 'é ç´„ç´€éŒ„'}
                </button>
              ))}
            </div>
            <div className="p-6">
                {activeTab === 'settings' && (
                    <div className="space-y-4">
                        <div className="border p-4 rounded bg-orange-50">
                            <h3 className="font-bold text-[#e65100] mb-2">é«˜é›„è¨­å®š</h3>
                            <textarea className="w-full border p-2 mb-2 h-20 text-sm" value={kaohsiungDates} onChange={e => setKaohsiungDates(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)" />
                            <button onClick={() => setKaohsiungDates("2025-12-12,2025-12-13,2025-12-14,2025-12-15,2025-12-26,2025-12-27,2025-12-28,2025-12-29")} className="text-xs text-blue-600 underline mb-2 block">åŒ¯å…¥12æœˆæª”æœŸ</button>
                            <input className="w-full border p-2 mb-2 text-sm" value={kaohsiungSlots} onChange={e => setKaohsiungSlots(e.target.value)} />
                            <button onClick={() => saveSettings('kaohsiung', kaohsiungDates, kaohsiungSlots)} className="bg-[#e65100] text-white px-3 py-1 rounded">å„²å­˜</button>
                        </div>
                        <div className="border p-4 rounded bg-blue-50">
                            <h3 className="font-bold text-[#0d47a1] mb-2">å°å—è¨­å®š</h3>
                            <textarea className="w-full border p-2 mb-2 h-20 text-sm" value={tainanDates} onChange={e => setTainanDates(e.target.value)} placeholder="æ—¥æœŸ (ç•™ç©ºç‚ºå…¨é–‹)" />
                            <input className="w-full border p-2 mb-2 text-sm" value={tainanSlots} onChange={e => setTainanSlots(e.target.value)} />
                            <button onClick={() => saveSettings('tainan', tainanDates, tainanSlots)} className="bg-[#0d47a1] text-white px-3 py-1 rounded">å„²å­˜</button>
                        </div>
                    </div>
                )}
                {activeTab === 'services' && (
                    <div>
                        <button onClick={initDefaults} className="bg-yellow-600 text-white px-3 py-1 rounded text-sm mb-4">é‡ç½®é è¨­æœå‹™</button>
                        <div className="space-y-2">
                            {services.map(s => (
                                <div key={s.id} className="flex justify-between border p-2 rounded">
                                    <span>{s.name} (${s.price})</span>
                                    <button onClick={() => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-500"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                         <button onClick={async () => {
                            const n = prompt('åç¨±'); const p = prompt('åƒ¹æ ¼'); const d = prompt('æ™‚é•·');
                            if(n&&p) await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({name:n, price:Number(p), duration:Number(d||90)});
                        }} className="mt-4 flex items-center gap-2 text-[#8d6e63] border border-[#8d6e63] px-4 py-2 rounded text-sm"><Icons.Plus size={16}/> æ–°å¢</button>
                    </div>
                )}
                {activeTab === 'bookings' && (
                    <div>
                        {bookings.map(b => (
                         <div key={b.id} className="border-b p-3 flex justify-between items-start text-sm">
                           <div>
                             <div className="font-bold text-[#8d6e63]">{b.date} {b.time} <span className="bg-gray-200 px-1 rounded ml-1 text-xs">{b.locationName}</span></div>
                             <div>{b.serviceName}</div>
                             <div className="text-gray-600">{b.customerName} ({b.customerPhone})</div>
                             {b.notes && <div className="text-xs bg-yellow-50 p-1 mt-1">å‚™è¨»: {b.notes}</div>}
                           </div>
                           <button onClick={() => confirm('åˆªé™¤ï¼Ÿ') && db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).delete()} className="text-red-400"><Icons.Trash2 size={16}/></button>
                         </div>
                       ))}
                    </div>
                )}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppointmentApp />);
  </script>
</body>
</html>      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };

    // -------------------------------------------------------

    // åˆå§‹åŒ– Firebase
    // ç‚ºäº†é¿å…ä½¿ç”¨è€…å¿˜è¨˜å¡«å¯«å°è‡´å ±éŒ¯ï¼Œé€™é‚Šåšå€‹ç°¡å–®æª¢æŸ¥
    let app, auth, db, appId;
    try {
      if (firebaseConfig.apiKey === "è«‹å¡«å…¥æ‚¨çš„apiKey") {
        console.warn("âš ï¸ è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ­£ç¢ºçš„ Firebase Config");
      } else {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = "booking-system-web"; // ç”¨æ–¼å€éš”è³‡æ–™çš„ ID
      }
    } catch (e) {
      console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
    }

    // --- åœ–ç¤ºå…ƒä»¶ (ä½¿ç”¨ SVG ç¹ªè£½ï¼Œä¸ä¾è³´å¤–éƒ¨å¥—ä»¶) ---
    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );
    const Icons = {
      MapPin: (p) => <Icon {...p} path={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>} />,
      ChevronRight: (p) => <Icon {...p} path={<path d="m9 18 6-6-6-6"/>} />,
      ChevronLeft: (p) => <Icon {...p} path={<path d="m15 18-6-6 6-6"/>} />,
      Settings: (p) => <Icon {...p} path={<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>} /> ,
      Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
      User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
      Phone: (p) => <Icon {...p} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />,
      FileText: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} />,
      CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
      Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
      Plus: (p) => <Icon {...p} path={<><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>} />,
      Info: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>} />
    };

    // --- å¸¸æ•¸è³‡æ–™ ---
    const LOCATIONS = [
      { id: 'tainan', name: 'å°å—å·¥ä½œå®¤' },
      { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }
    ];
    const DEFAULT_TIME_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DISCOUNT_NOTE = "â€» å„ªæƒ èº«åˆ†åŒ…å«ï¼šå­¸ç”Ÿã€é†«è­·ã€è»å…¬æ•™ã€ç•¶æœˆå£½æ˜Ÿã€èˆŠå®¢ä»‹ç´¹ (è«‹æ–¼ç¾å ´å‡ºç¤ºè­‰æ˜)";

    // --- ä¸»ç¨‹å¼å…ƒä»¶ ---
    function AppointmentApp() {
      // ç‹€æ…‹
      const [user, setUser] = useState(null);
      const [view, setView] = useState('home'); 
      const [bookingStep, setBookingStep] = useState(1);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [selectedService, setSelectedService] = useState(null);
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedTime, setSelectedTime] = useState(null);
      const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', notes: '' });
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [bookedSlots, setBookedSlots] = useState([]); 
      const [locationSettings, setLocationSettings] = useState({});
      const [adminPinInput, setAdminPinInput] = useState('');

      // åˆå§‹åŒ–
      useEffect(() => {
        if (!auth) return;
        signInAnonymously(auth).catch(console.error);
        if (window.liff) {
          window.liff.init({ liffId: LIFF_ID }).catch(err => console.log('LIFF init error (may be outside LINE)', err));
        }
        return onAuthStateChanged(auth, setUser);
      }, []);

      // ç›£è½è³‡æ–™åº«
      useEffect(() => {
        if (!user || !db) return;
        
        // æœå‹™
        const unsubS = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'services'), orderBy('name')), snap => {
          setServices(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        
        // å­é …ç›®
        const unsubA = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'addons')), snap => {
          setAddons(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        });

        // è¨­å®š
        const unsubSet = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'settings'), snap => {
          const settings = {};
          snap.docs.forEach(d => { settings[d.id] = d.data(); });
          setLocationSettings(settings);
        });

        return () => { unsubS(); unsubA(); unsubSet(); };
      }, [user]);

      // ç›£è½è©²æ—¥é ç´„ç‹€æ³
      useEffect(() => {
        if (!user || !selectedLocation || !selectedDate || !db) return;
        const dateStr = selectedDate.toISOString().split('T')[0];
        const q = query(
          collection(db, 'artifacts', appId, 'public', 'data', 'bookings'),
          where('locationId', '==', selectedLocation.id),
          where('date', '==', dateStr)
        );
        const unsub = onSnapshot(q, (snapshot) => {
          setBookedSlots(snapshot.docs.map(d => d.data().time));
        });
        return () => unsub();
      }, [user, selectedLocation, selectedDate]);

      // å·¥å…·å‡½å¼
      const isDateAvailable = (date) => {
        if (!selectedLocation) return true;
        const settings = locationSettings[selectedLocation.id];
        if (!settings || !settings.allowedDates || settings.allowedDates.length === 0) return true;
        return settings.allowedDates.includes(date.toISOString().split('T')[0]);
      };

      const getCurrentTimeSlots = () => {
        if (!selectedLocation) return DEFAULT_TIME_SLOTS;
        const settings = locationSettings[selectedLocation.id];
        if (settings && settings.timeSlots && settings.timeSlots.length > 0) return settings.timeSlots;
        return DEFAULT_TIME_SLOTS;
      };

      const handleSubmitBooking = async () => {
        if (!user || !db) return alert("ç³»çµ±é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– Firebase è¨­å®š");
        
        const bookingData = {
          locationId: selectedLocation.id,
          locationName: selectedLocation.name,
          serviceId: selectedService.id,
          serviceName: selectedService.name,
          addons: selectedAddons,
          date: selectedDate.toISOString().split('T')[0],
          time: selectedTime,
          customerName: customerInfo.name,
          customerPhone: customerInfo.phone,
          notes: customerInfo.notes,
          createdAt: serverTimestamp(),
          userId: user.uid
        };

        try {
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), bookingData);
          
          const msg = `ã€é ç´„é€šçŸ¥ã€‘\n` +
            `ğŸ  ${bookingData.locationName}\n` +
            `ğŸ“… ${bookingData.date} ${bookingData.time}\n` +
            `ğŸ’† ${bookingData.serviceName}\n` +
            `ğŸ‘¤ ${bookingData.customerName}`;
          
          if (window.liff && window.liff.isInClient()) {
            await window.liff.sendMessages([{ type: 'text', text: msg }]);
          }
          setBookingStep(5);
        } catch (e) {
          alert('é ç´„å¤±æ•—: ' + e.message);
        }
      };

      const resetBooking = () => {
        setBookingStep(1);
        setSelectedLocation(null);
        setSelectedService(null);
        setSelectedAddons([]);
        setSelectedTime(null);
        setCustomerInfo({ name: '', phone: '', notes: '' });
        setView('home');
      };

      // --- æ¸²æŸ“ç•«é¢ ---
      if (!db && firebaseConfig.apiKey === "è«‹å¡«å…¥æ‚¨çš„apiKey") {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center">
                <h1 className="text-2xl font-bold text-red-600 mb-4">âš ï¸ å°šæœªè¨­å®šè³‡æ–™åº«</h1>
                <p>è«‹ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨é–‹å•Ÿæ­¤æª”æ¡ˆ (index.html)</p>
                <p>æœå°‹ <code>firebaseConfig</code> ä¸¦å¡«å…¥æ‚¨çš„ Firebase è¨­å®šã€‚</p>
            </div>
        );
      }

      // Admin Login
      if (view === 'admin-login') {
        return (
          <div className="min-h-screen flex items-center justify-center bg-[#f4f1ea]">
            <div className="bg-white p-8 rounded shadow-lg max-w-sm w-full text-center border border-[#d7ccc8]">
              <h2 className="text-xl font-bold mb-4 text-[#5d4037]">å¾Œå°ç™»å…¥</h2>
              <input type="password" placeholder="PIN" className="w-full border p-2 mb-4 rounded outline-none" value={adminPinInput} onChange={e => setAdminPinInput(e.target.value)} />
              <div className="flex gap-2">
                <button onClick={() => setView('home')} className="flex-1 bg-gray-200 py-2 rounded text-[#5d4037]">å–æ¶ˆ</button>
                <button onClick={() => adminPinInput === ADMIN_PIN ? setView('admin-dashboard') : alert('å¯†ç¢¼éŒ¯èª¤')} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">ç™»å…¥</button>
              </div>
            </div>
          </div>
        );
      }

      // Admin Dashboard
      if (view === 'admin-dashboard') {
        return <AdminDashboard onBack={() => setView('home')} user={user} services={services} settings={locationSettings} appId={appId} db={db} />;
      }

      // Home
      if (view === 'home') {
        return (
          <div className="min-h-screen p-6 flex flex-col items-center justify-center" style={{backgroundImage: `linear-gradient(90deg, transparent 50%, rgba(255,255,255,.3) 50%), linear-gradient(transparent 50%, rgba(244,241,234,0.1) 50%)`, backgroundSize: '20px 20px'}}>
            <button onClick={() => setView('admin-login')} className="absolute top-4 left-4 p-2 text-[#8d6e63] opacity-30 hover:opacity-100"><Icons.Settings /></button>
            <div className="max-w-md w-full relative">
              <div className="absolute -top-4 left-1/2 transform -translate-x-1/2 -rotate-2 w-32 h-8 bg-[#d7ccc8] opacity-80 shadow-sm z-10"></div>
              <div className="bg-[#fdfbf7] p-8 pt-10 rounded-sm shadow-xl border border-[#e8e4dc]">
                <h1 className="text-3xl font-bold text-center mb-2 tracking-widest text-[#4e342e]">ç·šä¸Šé ç´„</h1>
                <p className="text-center text-[#8d6e63] mb-8 text-sm">è«‹é¸æ“‡æœå‹™æ“šé»</p>
                <div className="space-y-4">
                  {LOCATIONS.map(loc => (
                    <button key={loc.id} onClick={() => { setSelectedLocation(loc); setView('booking'); setBookingStep(2); }} className="w-full bg-white border-2 border-[#d7ccc8] hover:border-[#8d6e63] p-6 rounded-lg transition-all flex items-center justify-between group">
                      <div className="flex items-center gap-4">
                        <div className="bg-[#efebe9] p-3 rounded-full text-[#5d4037]"><Icons.MapPin /></div>
                        <h3 className="text-xl font-bold text-[#4e342e]">{loc.name}</h3>
                      </div>
                      <span className="text-[#d7ccc8] group-hover:text-[#8d6e63]"><Icons.ChevronRight /></span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Booking Process
      return (
        <div className="min-h-screen py-6 px-4 font-serif text-[#5d4037]">
            <div className="max-w-lg mx-auto bg-[#fdfbf7] min-h-[85vh] rounded-sm shadow-xl border border-[#e8e4dc] flex flex-col">
               <div className="p-6 border-b border-[#e8e4dc] flex items-center justify-between bg-white/50">
                  <button onClick={() => bookingStep === 2 ? resetBooking() : setBookingStep(s => s - 1)} className="text-[#8d6e63]"><Icons.ChevronLeft /></button>
                  <span className="font-bold tracking-widest text-[#4e342e]">{bookingStep === 2 ? 'é¸æ“‡æœå‹™' : bookingStep === 3 ? 'é¸æ“‡æ™‚é–“' : 'ç¢ºèªè³‡æ–™'}</span>
                  <div className="w-6"></div> 
               </div>

               <div className="flex-1 p-6 overflow-y-auto">
                 {bookingStep === 2 && (
                   <div className="space-y-6">
                     <div className="bg-[#efebe9]/50 p-4 rounded text-xs text-[#6d4c41] flex gap-2 items-start leading-relaxed">
                       <span className="shrink-0 mt-0.5"><Icons.Info size={16}/></span> {DISCOUNT_NOTE}
                     </div>
                     <div className="grid gap-3">
                        {services.map(svc => (
                           <label key={svc.id} className={`relative flex items-center justify-between p-4 border rounded-lg cursor-pointer transition-all ${selectedService?.id === svc.id ? 'border-[#8d6e63] bg-[#efebe9]' : 'border-gray-200 hover:border-[#d7ccc8]'}`}>
                             <div className="flex items-center gap-3">
                               <input type="radio" name="service" className="accent-[#8d6e63] w-5 h-5" checked={selectedService?.id === svc.id} onChange={() => setSelectedService(svc)} />
                               <div>
                                 <div className="font-bold text-lg">{svc.name}</div>
                                 <div className="text-sm text-[#8d6e63] flex gap-2 items-center">
                                   <span>â± {svc.duration} åˆ†</span>
                                   <span className="font-bold text-[#5d4037]">${svc.price}</span>
                                 </div>
                               </div>
                             </div>
                             {svc.name.includes("å„ªæƒ ") && <div className="absolute top-2 right-2 text-[10px] bg-[#8d6e63] text-white px-2 py-0.5 rounded-full">å„ªæƒ </div>}
                           </label>
                         ))}
                     </div>
                   </div>
                 )}

                 {bookingStep === 3 && (
                   <div className="space-y-6">
                     <div className="bg-white p-4 rounded-lg border border-[#e8e4dc] shadow-sm">
                       <div className="flex justify-between items-center mb-4">
                         <button onClick={() => setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth() - 1)))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronLeft/></button>
                         <span className="font-bold text-lg">{selectedDate.getFullYear()}å¹´ {selectedDate.getMonth() + 1}æœˆ</span>
                         <button onClick={() => setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth() + 1)))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronRight/></button>
                       </div>
                       <div className="grid grid-cols-7 gap-1 text-center text-sm mb-2 text-[#a1887f]">
                         {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d}>{d}</div>)}
                       </div>
                       <div className="grid grid-cols-7 gap-1 text-center">
                         {Array.from({ length: new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay() }).map((_, i) => <div key={`empty-${i}`}></div>)}
                         {Array.from({ length: new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate() }).map((_, i) => {
                           const d = i + 1;
                           const current = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d);
                           const isSelected = d === selectedDate.getDate();
                           const isPast = current < new Date().setHours(0,0,0,0);
                           const available = isDateAvailable(current);
                           return (
                             <button key={d} disabled={isPast || !available} onClick={() => { setSelectedDate(current); setSelectedTime(null); }}
                               className={`p-2 rounded-full w-8 h-8 flex items-center justify-center mx-auto text-sm transition-colors relative
                                 ${isSelected ? 'bg-[#8d6e63] text-white' : ''}
                                 ${!isSelected && available && !isPast ? 'hover:bg-[#efebe9] text-[#5d4037]' : ''}
                                 ${(isPast || !available) ? 'text-gray-200 cursor-not-allowed' : ''}
                               `}>
                               {d}
                               {!isPast && available && !isSelected && <div className="absolute bottom-1 w-1 h-1 bg-[#8d6e63] rounded-full"></div>}
                             </button>
                           );
                         })}
                       </div>
                     </div>
                     
                     {isDateAvailable(selectedDate) ? (
                       <div>
                         <h3 className="text-lg font-bold mb-3 flex items-center gap-2"><Icons.Clock size={18}/> é¸æ“‡æ™‚æ®µ</h3>
                         <div className="grid grid-cols-2 gap-3">
                           {getCurrentTimeSlots().map(time => {
                             const isBooked = bookedSlots.includes(time);
                             return (
                               <button key={time} disabled={isBooked} onClick={() => setSelectedTime(time)}
                                 className={`py-3 px-2 text-sm rounded border transition-all text-center ${selectedTime === time ? 'bg-[#8d6e63] text-white border-[#8d6e63]' : isBooked ? 'bg-gray-100 text-gray-300 border-gray-100 cursor-not-allowed' : 'bg-white border-[#d7ccc8] hover:border-[#8d6e63] text-[#5d4037]'}`}>
                                 {time} {isBooked && '(å·²æ»¿)'}
                               </button>
                             )
                           })}
                         </div>
                       </div>
                     ) : <div className="text-center text-red-400 text-sm">è©²æ—¥æœŸå°šæœªé–‹æ”¾é ç´„ã€‚</div>}
                   </div>
                 )}

                 {bookingStep === 4 && (
                   <div className="space-y-6">
                     <div className="bg-[#efebe9] p-4 rounded-lg text-sm space-y-2 border border-[#d7ccc8]">
                        <div className="flex justify-between"><span className="text-[#a1887f]">åœ°é»</span> <span className="font-bold">{selectedLocation?.name}</span></div>
                        <div className="flex justify-between"><span className="text-[#a1887f]">æ™‚é–“</span> <span className="font-bold">{selectedDate.toLocaleDateString()} {selectedTime}</span></div>
                        <div className="flex justify-between"><span className="text-[#a1887f]">é …ç›®</span> <span className="font-bold">{selectedService?.name}</span></div>
                     </div>
                     <div className="space-y-4">
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">å§“å</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.User size={18}/></span>
                                <input type="text" className="w-full bg-transparent outline-none" value={customerInfo.name} onChange={e => setCustomerInfo({...customerInfo, name: e.target.value})} placeholder="è«‹è¼¸å…¥å§“å" />
                           </div>
                       </div>
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">é›»è©±</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.Phone size={18}/></span>
                                <input type="tel" className="w-full bg-transparent outline-none" value={customerInfo.phone} onChange={e => setCustomerInfo({...customerInfo, phone: e.target.value})} placeholder="09xx-xxx-xxx" />
                           </div>
                       </div>
                       <div>
                           <label className="block text-sm font-bold text-[#6d4c41] mb-1">å‚™è¨»</label>
                           <div className="flex items-center border-b-2 border-[#d7ccc8] py-2">
                                <span className="mr-2 text-[#a1887f]"><Icons.FileText size={18}/></span>
                                <textarea className="w-full bg-transparent outline-none resize-none" rows={2} value={customerInfo.notes} onChange={e => setCustomerInfo({...customerInfo, notes: e.target.value})} placeholder="è‹¥é¸æ“‡å¾®èª¿æ™‚æ®µï¼Œè«‹åœ¨æ­¤å¡«å¯«å¸Œæœ›çš„æ™‚é–“" />
                           </div>
                       </div>
                     </div>
                   </div>
                 )}

                 {bookingStep === 5 && (
                   <div className="text-center py-10">
                     <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><span className="text-green-600"><Icons.CheckCircle size={48}/></span></div>
                     <h2 className="text-2xl font-bold text-[#4e342e] mb-2">é ç´„æˆåŠŸï¼</h2>
                     <button onClick={resetBooking} className="bg-[#8d6e63] text-white px-8 py-3 rounded shadow mt-6">è¿”å›é¦–é </button>
                   </div>
                 )}
               </div>

               {bookingStep < 5 && (
                 <div className="p-6 border-t border-[#e8e4dc] bg-white/50">
                   <button onClick={() => {
                       if (bookingStep === 2 && !selectedService) return alert('è«‹é¸æ“‡æœå‹™');
                       if (bookingStep === 3 && !selectedTime) return alert('è«‹é¸æ“‡æ™‚æ®µ');
                       if (bookingStep === 4 && (!customerInfo.name || !customerInfo.phone)) return alert('è«‹å¡«å¯«è³‡æ–™');
                       if (bookingStep === 4) handleSubmitBooking();
                       else setBookingStep(s => s + 1);
                     }}
                     className="w-full bg-[#8d6e63] text-white py-3 rounded-md font-bold tracking-widest shadow-md hover:bg-[#795548] transition-all">
                     {bookingStep === 4 ? 'ç¢ºèªé ç´„' : 'ä¸‹ä¸€æ­¥'}
                   </button>
                 </div>
               )}
            </div>
        </div>
      );
    }

    // --- Admin Dashboard (ç°¡åŒ–ç‰ˆ) ---
    function AdminDashboard({ onBack, user, services, settings, appId, db }) {
      const [activeTab, setActiveTab] = useState('settings'); 
      const [bookings, setBookings] = useState([]);
      const [tainanDates, setTainanDates] = useState(settings['tainan']?.allowedDates?.join(',') || '');
      const [kaohsiungDates, setKaohsiungDates] = useState(settings['kaohsiung']?.allowedDates?.join(',') || '');
      const [kaohsiungSlots, setKaohsiungSlots] = useState(settings['kaohsiung']?.timeSlots?.join(',') || DEFAULT_TIME_SLOTS.join(','));
      const [tainanSlots, setTainanSlots] = useState(settings['tainan']?.timeSlots?.join(',') || DEFAULT_TIME_SLOTS.join(','));

      useEffect(() => {
        if (!user || !db) return;
        return onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), orderBy('date', 'desc')), snap => {
          setBookings(snap.docs.map(d => ({id: d.id, ...d.data()})));
        });
      }, [user]);

      const saveSettings = async (locId, datesStr, slotsStr) => {
        const dates = datesStr.split(',').map(d => d.trim()).filter(d => d);
        const slots = slotsStr.split(',').map(s => s.trim()).filter(s => s);
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', locId), { allowedDates: dates, timeSlots: slots });
        alert('å„²å­˜æˆåŠŸ');
      };

      const initDefaults = async () => {
        if (!confirm('å°‡é‡ç½®æœå‹™åˆ—è¡¨ï¼Œç¢ºå®šï¼Ÿ')) return;
        for (let s of services) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', s.id)); }
        const defaults = [
            { name: 'éœ§çœ‰ (ä¸€èˆ¬é ç´„)', price: 4800, duration: 90 },
            { name: 'éœ§çœ‰ (å„ªæƒ èº«åˆ†)', price: 4600, duration: 90 },
            { name: 'éœ§å”‡ (ä¸€èˆ¬é ç´„)', price: 5200, duration: 120 },
            { name: 'éœ§å”‡ (å„ªæƒ èº«åˆ†)', price: 5000, duration: 120 },
        ];
        for (let d of defaults) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), d); }
        alert('é‡ç½®å®Œæˆ');
      };

      return (
        <div className="min-h-screen bg-gray-50 p-6 font-sans">
          <div className="max-w-4xl mx-auto bg-white shadow rounded-lg overflow-hidden">
            <div className="flex justify-between items-center p-6 border-b">
              <h2 className="text-xl font-bold text-gray-800">å¾Œå°ç®¡ç†</h2>
              <button onClick={onBack} className="bg-gray-500 text-white px-4 py-2 rounded text-sm">é€€å‡º</button>
            </div>
            <div className="flex border-b bg-gray-50">
              {['settings', 'services', 'bookings'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 font-bold text-sm ${activeTab === tab ? 'bg-white text-[#8d6e63] border-t-2 border-[#8d6e63]' : 'text-gray-500'}`}>
                    {tab === 'settings' ? 'ç‡Ÿæ¥­è¨­å®š' : tab === 'services' ? 'æœå‹™é …ç›®' : 'é ç´„ç´€éŒ„'}
                </button>
              ))}
            </div>
            <div className="p-6">
                {activeTab === 'settings' && (
                    <div className="space-y-4">
                        <div className="border p-4 rounded bg-orange-50">
                            <h3 className="font-bold text-[#e65100] mb-2">é«˜é›„è¨­å®š</h3>
                            <textarea className="w-full border p-2 mb-2 h-20 text-sm" value={kaohsiungDates} onChange={e => setKaohsiungDates(e.target.value)} placeholder="æ—¥æœŸ (é€—è™Ÿåˆ†éš”)" />
                            <button onClick={() => setKaohsiungDates("2025-12-12,2025-12-13,2025-12-14,2025-12-15,2025-12-26,2025-12-27,2025-12-28,2025-12-29")} className="text-xs text-blue-600 underline mb-2 block">åŒ¯å…¥12æœˆæª”æœŸ</button>
                            <input className="w-full border p-2 mb-2 text-sm" value={kaohsiungSlots} onChange={e => setKaohsiungSlots(e.target.value)} />
                            <button onClick={() => saveSettings('kaohsiung', kaohsiungDates, kaohsiungSlots)} className="bg-[#e65100] text-white px-3 py-1 rounded">å„²å­˜</button>
                        </div>
                        <div className="border p-4 rounded bg-blue-50">
                            <h3 className="font-bold text-[#0d47a1] mb-2">å°å—è¨­å®š</h3>
                            <textarea className="w-full border p-2 mb-2 h-20 text-sm" value={tainanDates} onChange={e => setTainanDates(e.target.value)} placeholder="æ—¥æœŸ (ç•™ç©ºç‚ºå…¨é–‹)" />
                            <input className="w-full border p-2 mb-2 text-sm" value={tainanSlots} onChange={e => setTainanSlots(e.target.value)} />
                            <button onClick={() => saveSettings('tainan', tainanDates, tainanSlots)} className="bg-[#0d47a1] text-white px-3 py-1 rounded">å„²å­˜</button>
                        </div>
                    </div>
                )}
                {activeTab === 'services' && (
                    <div>
                        <button onClick={initDefaults} className="bg-yellow-600 text-white px-3 py-1 rounded text-sm mb-4">é‡ç½®é è¨­æœå‹™</button>
                        <div className="space-y-2">
                            {services.map(s => (
                                <div key={s.id} className="flex justify-between border p-2 rounded">
                                    <span>{s.name} (${s.price})</span>
                                    <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', s.id))} className="text-red-500"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                         <button onClick={async () => {
                            const n = prompt('åç¨±'); const p = prompt('åƒ¹æ ¼'); const d = prompt('æ™‚é•·');
                            if(n&&p) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'services'), {name:n, price:Number(p), duration:Number(d||90)});
                        }} className="mt-4 flex items-center gap-2 text-[#8d6e63] border border-[#8d6e63] px-4 py-2 rounded text-sm"><Icons.Plus size={16}/> æ–°å¢</button>
                    </div>
                )}
                {activeTab === 'bookings' && (
                    <div>
                        {bookings.map(b => (
                         <div key={b.id} className="border-b p-3 flex justify-between items-start text-sm">
                           <div>
                             <div className="font-bold text-[#8d6e63]">{b.date} {b.time} <span className="bg-gray-200 px-1 rounded ml-1 text-xs">{b.locationName}</span></div>
                             <div>{b.serviceName}</div>
                             <div className="text-gray-600">{b.customerName} ({b.customerPhone})</div>
                             {b.notes && <div className="text-xs bg-yellow-50 p-1 mt-1">å‚™è¨»: {b.notes}</div>}
                           </div>
                           <button onClick={() => confirm('åˆªé™¤ï¼Ÿ') && deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', b.id))} className="text-red-400"><Icons.Trash2 size={16}/></button>
                         </div>
                       ))}
                    </div>
                )}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppointmentApp />);
  </script>
</body>
</html>
