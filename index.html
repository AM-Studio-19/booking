<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AM Studio ç·šä¸Šé ç´„</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* å…¨åŸŸè¨­å®š */
    body { 
      font-family: 'Noto Serif TC', serif; 
      background-color: #FDFCF8; 
      color: #4A4A4A; 
      -webkit-tap-highlight-color: transparent;
    }
    
    /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* V38: ç¾ä»£åŒ–å¡ç‰‡èˆ‡æŒ‰éˆ• */
    .app-card {
      @apply bg-white rounded-3xl p-5 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] border border-[#f0f0f0];
    }

    .service-item {
      @apply relative flex items-center justify-between p-4 rounded-2xl border border-transparent bg-[#FAFAFA] transition-all duration-300 cursor-pointer mb-3;
    }
    .service-item:hover { @apply bg-[#F5F5F5]; }
    .service-item.active { 
      @apply bg-white border-[#C4A48C] shadow-[0_0_0_1px_#C4A48C] bg-[#FFFBF9];
    }

    .pill-tab {
      @apply px-6 py-2.5 rounded-full text-sm font-bold transition-all duration-300 whitespace-nowrap;
    }
    .pill-tab.active { @apply bg-[#C4A48C] text-white shadow-md transform scale-105; }
    .pill-tab.inactive { @apply bg-[#F0F0F0] text-[#999]; }

    .time-chip {
      @apply py-3 rounded-xl text-center text-sm font-bold border border-transparent bg-[#FAFAFA] transition-all duration-200;
    }
    .time-chip.active { @apply bg-[#C4A48C] text-white shadow-md; }
    .time-chip.disabled { @apply opacity-30 cursor-not-allowed bg-[#EEEEEE] text-[#AAAAAA]; }

    /* åº•éƒ¨æ‡¸æµ®æŒ‰éˆ• */
    .sticky-footer {
      @apply fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-8 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-40;
    }

    /* Modal å‹•ç•« */
    .modal-backdrop { @apply fixed inset-0 bg-black/40 z-50 flex items-end justify-center backdrop-blur-[2px] transition-opacity; }
    .bottom-sheet { @apply bg-white w-full max-w-lg rounded-t-3xl p-6 transform transition-transform duration-300 ease-out; }
    
    .spinner {
      border: 3px solid #f3f3f3; border-top: 3px solid #C4A48C; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>

  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    
    // --- Config & Data ---
    const firebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    const LIFF_ID = '2008567948-KGMPJPGe'; 
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';
    
    const BANK_INFO = { code: '822', account: '1234-5678-9012', amountPerPerson: 1000 };
    const LOCATIONS = [{ id: 'tainan', name: 'å°å—å·¥ä½œå®¤' }, { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }];
    const CATEGORIES = ["éœ§çœ‰", "éœ§å”‡"]; 
    const DEFAULT_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];

    // Init Firebase
    let db, auth;
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.error(e); }

    // Icons
    const Icon = ({ name, size=20, className="" }) => {
        const paths = {
            check: <polyline points="20 6 9 17 4 12"/>,
            chevronRight: <path d="m9 18 6-6-6-6"/>,
            chevronLeft: <path d="m15 18-6-6 6-6"/>,
            map: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
            calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
            clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
            settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
            close: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            tag: <><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></>,
        };
        return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{paths[name]}</svg>;
    };

    // --- Sub-components ---
    
    // Bottom Sheet Modal for Selection
    const SelectionSheet = ({ title, isOpen, onClose, children }) => {
        if (!isOpen) return null;
        return (
            <div className="modal-backdrop fade-in" onClick={onClose}>
                <div className="bottom-sheet" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-[#4e342e]">{title}</h3>
                        <button onClick={onClose} className="p-2 bg-gray-100 rounded-full text-gray-500"><Icon name="close" size={16}/></button>
                    </div>
                    {children}
                </div>
            </div>
        );
    };

    const GuestSection = ({ index, guest, services, addons, discounts, onUpdate, onRemove, showRemove }) => {
        const [activeCat, setActiveCat] = useState('éœ§çœ‰');
        const [showTouchupModal, setShowTouchupModal] = useState(false);
        const [modalStage, setModalStage] = useState('session'); // session -> time
        const [touchupSession, setTouchupSession] = useState('');
        const [isDarkLip, setIsDarkLip] = useState(false);

        // Filter services
        const currentCatServices = useMemo(() => services.filter(s => s.category === activeCat), [services, activeCat]);
        const firstTimeSvc = currentCatServices.find(s => s.type === 'é¦–æ¬¡');
        
        // Find existing service for this category in guest
        const selectedSvc = guest.services.find(s => s.category === activeCat);

        const handleSelectFirst = () => {
            if(!firstTimeSvc) return;
            let finalSvc = { ...firstTimeSvc };
            // éœ§å”‡ç‰¹æ®Šé‚è¼¯
            if (activeCat === 'éœ§å”‡' && isDarkLip) {
                finalSvc.name += ' (å«çƒå”‡æ·¡è‰²)';
                finalSvc.price += 1300;
                finalSvc.isDarkLip = true;
            }
            onUpdate('setService', finalSvc);
        };

        const handleTouchupSelect = (timeRange) => {
            const target = currentCatServices.find(s => s.type === 'è£œè‰²' && s.session === touchupSession && s.timeRange === timeRange);
            if(target) {
                onUpdate('setService', target);
                setShowTouchupModal(false);
            } else {
                alert('æŸ¥ç„¡æ­¤æ™‚æ®µè³‡æ–™');
            }
        };

        // Available time ranges for touchup
        const touchupRanges = useMemo(() => {
            return currentCatServices
                .filter(s => s.type === 'è£œè‰²' && s.session === touchupSession)
                .map(s => ({ label: s.timeRange, price: s.price }))
                .filter((v,i,a) => a.findIndex(t => t.label === v.label) === i);
        }, [currentCatServices, touchupSession]);

        return (
            <div className="guest-block">
                <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-2">
                        <span className="bg-[#4e342e] text-white text-xs px-2 py-1 rounded">ç¬¬ {index + 1} ä½</span>
                        {showRemove && <button onClick={onRemove} className="text-red-400 text-xs underline">ç§»é™¤</button>}
                    </div>
                </div>

                {/* Category Tabs */}
                <div className="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">
                    {CATEGORIES.map(c => (
                        <button key={c} onClick={() => setActiveCat(c)} className={`pill-tab ${activeCat===c ? 'active' : 'inactive'}`}>
                            {c}
                        </button>
                    ))}
                </div>

                {/* Service Options (Cards) */}
                <div className="grid gap-3">
                    {/* 1. é¦–æ¬¡ Card */}
                    <div onClick={handleSelectFirst} 
                         className={`service-item ${selectedSvc?.type === 'é¦–æ¬¡' && selectedSvc.category === activeCat ? 'active' : ''}`}>
                        <div>
                            <div className="font-bold text-[#5d4037]">é¦–æ¬¡æ“ä½œ</div>
                            <div className="text-xs text-gray-500 mt-1">${firstTimeSvc?.price || 0}</div>
                        </div>
                        {selectedSvc?.type === 'é¦–æ¬¡' && selectedSvc.category === activeCat && <div className="text-[#C4A48C]"><Icon name="check"/></div>}
                    </div>

                    {/* éœ§å”‡ - çƒå”‡é¸é … (Inline) */}
                    {activeCat === 'éœ§å”‡' && (
                        <div className="mb-3 px-2 flex items-center gap-2" onClick={e=>e.stopPropagation()}>
                            <input type="checkbox" id={`darklip-${index}`} checked={isDarkLip} onChange={e=>setIsDarkLip(e.target.checked)} className="accent-[#C4A48C] w-4 h-4"/>
                            <label htmlFor={`darklip-${index}`} className="text-xs text-gray-600 cursor-pointer">éœ€çƒå”‡/æ·¡è‰²è™•ç† (+$1300)</label>
                        </div>
                    )}

                    {/* 2. è£œè‰² Card */}
                    <div onClick={() => { setModalStage('session'); setShowTouchupModal(true); }} 
                         className={`service-item ${selectedSvc?.type === 'è£œè‰²' && selectedSvc.category === activeCat ? 'active' : ''}`}>
                        <div>
                            <div className="font-bold text-[#5d4037]">è£œè‰²</div>
                            <div className="text-xs text-gray-500 mt-1">{selectedSvc?.type === 'è£œè‰²' && selectedSvc.category === activeCat ? selectedSvc.timeRange : 'é¸æ“‡æ™‚æ®µ...'}</div>
                        </div>
                        {selectedSvc?.type === 'è£œè‰²' && selectedSvc.category === activeCat ? <div className="text-[#C4A48C]"><Icon name="check"/></div> : <Icon name="chevronRight" className="text-gray-300"/>}
                    </div>
                </div>

                {/* Discount Select */}
                <div className="mt-4 pt-4 border-t border-dashed border-gray-200">
                    <label className="text-xs font-bold text-[#8d6e63] mb-1 block">å„ªæƒ èº«ä»½</label>
                    <select className="w-full bg-[#FAFAFA] border border-gray-200 rounded-lg p-2 text-sm outline-none"
                        value={guest.discount?.id || ''}
                        onChange={e => onUpdate('discount', e.target.value)}
                    >
                        <option value="">ç„¡ (åŸåƒ¹)</option>
                        {discounts.filter(d => {
                            // åš´æ ¼éæ¿¾ï¼šè‹¥æœ‰è£œè‰²ï¼Œåªç•™å£½æ˜Ÿ
                            const hasTouchup = guest.services.some(s => s.type === 'è£œè‰²');
                            return hasTouchup ? d.name.includes('å£½æ˜Ÿ') : true;
                        }).map(d => <option key={d.id} value={d.id}>{d.name} (-${d.amount})</option>)}
                    </select>
                </div>

                {/* Touchup Modal */}
                <SelectionSheet title={`${activeCat} - è£œè‰²é¸æ“‡`} isOpen={showTouchupModal} onClose={() => setShowTouchupModal(false)}>
                    {modalStage === 'session' ? (
                        <div className="space-y-3">
                            <p className="text-sm text-gray-500 mb-2">è«‹å•æ˜¯ç¬¬å¹¾æ¬¡å›ä¾†è£œè‰²å‘¢ï¼Ÿ</p>
                            {["ç¬¬ä¸€æ¬¡å›è£œ", "ç¬¬äºŒæ¬¡ä»¥ä¸Š"].map(s => (
                                <button key={s} onClick={() => { setTouchupSession(s); setModalStage('time'); }} className="option-btn bg-gray-50 hover:bg-[#efebe9] border-0">
                                    {s} <Icon name="chevronRight"/>
                                </button>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-3">
                            <button onClick={() => setModalStage('session')} className="text-xs text-gray-400 mb-2 flex items-center"><Icon name="chevronLeft" size={12}/> è¿”å›</button>
                            <p className="text-sm text-gray-500 mb-2">è·é›¢ä¸Šæ¬¡æ“ä½œå¤šä¹…äº†ï¼Ÿ</p>
                            {touchupRanges.length > 0 ? touchupRanges.map(r => (
                                <button key={r.label} onClick={() => handleTouchupSelect(r.label)} className="option-btn bg-gray-50 hover:bg-[#efebe9] border-0 flex justify-between">
                                    <span>{r.label}</span>
                                    <span className="font-bold text-[#8d6e63]">${r.price}</span>
                                </button>
                            )) : <div className="text-center text-gray-300 py-4">ç„¡æ­¤æ™‚æ®µå ±åƒ¹</div>}
                        </div>
                    )}
                </SelectionSheet>
            </div>
        );
    };

    function App() {
        const [user, setUser] = useState(null);
        const [step, setStep] = useState(1);
        const [loc, setLoc] = useState(null);
        
        // Data
        const [services, setServices] = useState([]);
        const [discounts, setDiscounts] = useState([]);
        const [settings, setSettings] = useState({});
        const [booked, setBooked] = useState([]);

        // Form State
        const [guests, setGuests] = useState([{ id: 1, services: [], discount: null }]);
        const [isMulti, setIsMulti] = useState(false);
        const [date, setDate] = useState(new Date());
        const [time, setTime] = useState(null);
        const [customTime, setCustomTime] = useState('');
        const [info, setInfo] = useState({name: '', phone: '', notes: ''});

        useEffect(() => {
            auth.signInAnonymously().catch(console.error);
            if (window.liff) window.liff.init({ liffId: LIFF_ID });
            return auth.onAuthStateChanged(setUser);
        }, []);

        useEffect(() => {
            if(!user) return;
            const pub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
            pub.collection('services').onSnapshot(s => setServices(s.docs.map(d => ({id:d.id, ...d.data()}))));
            pub.collection('discounts').onSnapshot(s => setDiscounts(s.docs.map(d => ({id:d.id, ...d.data()}))));
            pub.collection('settings').onSnapshot(s => { const obj={}; s.forEach(d=>obj[d.id]=d.data()); setSettings(obj); });
        }, [user]);

        useEffect(() => {
            if (!loc) return;
            const dStr = date.toISOString().split('T')[0];
            db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
              .where('locationId', '==', loc.id).where('date', '==', dStr)
              .onSnapshot(s => setBooked(s.docs.map(d => d.data().time)));
        }, [loc, date]);

        // Logic
        const handleGuestUpdate = (idx, type, val) => {
            const newGuests = [...guests];
            if (type === 'setService') {
                // Logic: Replace service of same category, allow diff category
                const existing = newGuests[idx].services.filter(s => s.category !== val.category);
                newGuests[idx].services = [...existing, val];
            } else if (type === 'discount') {
                newGuests[idx].discount = discounts.find(d => d.id === val) || null;
            }
            setGuests(newGuests);
        };

        const calculateTotal = () => {
            let total = 0;
            guests.forEach(g => {
                g.services.forEach(s => total += s.price);
                const hasTouchup = g.services.some(s => s.type === 'è£œè‰²');
                // Discount logic
                if (g.discount) {
                    // Touchup only allow birthday discount
                    if (hasTouchup) {
                        if (g.discount.name.includes('å£½æ˜Ÿ')) total -= 100; // Fixed 100 for touchup birthday
                    } else {
                        total -= g.discount.amount;
                    }
                }
            });
            // Multi-person discount (Only for non-touchup guests)
            if (isMulti && guests.length >= 2) {
                guests.forEach(g => {
                    const hasTouchup = g.services.some(s => s.type === 'è£œè‰²');
                    if (!hasTouchup) total -= 200;
                });
            }
            return total;
        };
        
        const deposit = guests.length * BANK_INFO.amountPerPerson;
        const total = calculateTotal();

        const handleSubmit = async () => {
            if (!info.name || !info.phone) return alert('è«‹å¡«å¯«è¯çµ¡è³‡æ–™');
            
            const batch = db.batch();
            const dStr = date.toISOString().split('T')[0];
            const tVal = time === 'å¾®èª¿æ™‚æ®µç”³è«‹' ? `å¾®èª¿ ${customTime}` : time;
            const groupId = Date.now().toString();

            guests.forEach((g, i) => {
                const ref = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc();
                batch.set(ref, {
                    locationId: loc.id, locationName: loc.name,
                    serviceId: g.services.map(s=>s.id), serviceName: g.services.map(s=>s.name).join('+'),
                    date: dStr, time: tVal,
                    customerName: info.name + (guests.length>1?`(${i+1})`:''), customerPhone: info.phone,
                    notes: info.notes, discountIdentity: g.discount?.name || '',
                    groupId, guestIndex: i + 1, totalPrice: total,
                    status: 'pending', paymentStatus: 'unpaid',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
                });
            });

            await batch.commit();
            
            const msg = `ã€é ç´„ç”³è«‹ã€‘\nğŸ“ ${loc.name}\nğŸ“… ${dStr} ${tVal}\nğŸ‘¤ äººæ•¸ï¼š${guests.length}\nğŸ’° ç¸½é¡ï¼š${total}\nâš ï¸ è¨‚é‡‘ï¼š${deposit}\n\nğŸ”— å›å ±ï¼šhttps://liff.line.me/${LIFF_ID}?p=check`;
            if (window.liff?.isInClient()) window.liff.sendMessages([{type:'text', text:msg}].catch(()=>{}));
            
            alert('é ç´„å·²é€å‡ºï¼');
            setStep(1); setLoc(null); // Reset
        };

        // --- Render Steps ---
        if (!loc) {
            return (
                <div className="min-h-screen flex flex-col justify-center p-6 space-y-6">
                    <div className="text-center space-y-2">
                        <h1 className="text-3xl font-bold text-[#5d4037] tracking-widest">AM Studio</h1>
                        <p className="text-sm text-[#8d6e63] tracking-widest">PROFESSIONAL BEAUTY</p>
                    </div>
                    <div className="grid gap-4">
                        {LOCATIONS.map(l => (
                            <button key={l.id} onClick={() => setLoc(l)} className="app-card flex items-center justify-between hover:border-[#C4A48C] transition-all">
                                <div className="flex items-center gap-4">
                                    <div className="bg-[#FAF5F0] p-3 rounded-full text-[#8d6e63]"><Icon name="map" size={24}/></div>
                                    <div className="text-left">
                                        <div className="font-bold text-lg">{l.name}</div>
                                        <div className="text-xs text-gray-400">é»æ“Šé–‹å§‹é ç´„</div>
                                    </div>
                                </div>
                                <Icon name="chevronRight" className="text-gray-300"/>
                            </button>
                        ))}
                    </div>
                    {/* Admin Access Hidden */}
                    <button className="fixed top-4 left-4 opacity-10" onClick={()=>alert('Admin Login Placeholder')}><Icon name="settings"/></button>
                </div>
            );
        }

        return (
            <div className="min-h-screen pb-24">
                {/* Navbar */}
                <div className="sticky top-0 bg-white/90 backdrop-blur-md p-4 z-20 shadow-sm flex items-center justify-between">
                    <button onClick={() => { if(step===1) setLoc(null); else setStep(s=>s-1); }} className="p-2"><Icon name="chevronLeft" className="text-[#8d6e63]"/></button>
                    <span className="font-bold text-[#5d4037]">é ç´„æµç¨‹</span>
                    <div className="w-8"></div>
                </div>

                <div className="p-4 space-y-6">
                    {/* Step 1: Services */}
                    {step === 1 && (
                        <div className="fade-in">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-bold">é¸æ“‡æœå‹™</h2>
                                <div className="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                                    <button onClick={()=>{setIsMulti(false); setGuests([guests[0]]);}} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${!isMulti ? 'bg-white shadow text-[#5d4037]' : 'text-gray-400'}`}>å–®äºº</button>
                                    <button onClick={()=>{setIsMulti(true); if(guests.length<2) setGuests([...guests, {id:Date.now(), services:[]}]);}} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${isMulti ? 'bg-white shadow text-[#5d4037]' : 'text-gray-400'}`}>åŒè¡Œ</button>
                                </div>
                            </div>
                            
                            {guests.map((g, i) => (
                                <GuestSection 
                                    key={g.id} 
                                    index={i} 
                                    guest={g} 
                                    services={services} 
                                    addons={addons}
                                    discounts={discounts}
                                    onUpdate={(type, val) => handleGuestUpdate(i, type, val)}
                                    showRemove={isMulti && i > 0}
                                    onRemove={() => { const ng = [...guests]; ng.splice(i, 1); setGuests(ng); }}
                                />
                            ))}

                            {isMulti && (
                                <button onClick={() => setGuests([...guests, { id: Date.now(), services: [], discount: null }])} 
                                    className="w-full py-3 border-2 border-dashed border-[#C4A48C] text-[#C4A48C] rounded-2xl flex items-center justify-center gap-2 font-bold hover:bg-[#FFFBF9]">
                                    <Icon name="plus"/> å†åŠ ä¸€ä½
                                </button>
                            )}
                        </div>
                    )}

                    {/* Step 2: Date & Time */}
                    {step === 2 && (
                        <div className="fade-in space-y-6">
                            <div className="app-card">
                                <div className="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
                                    <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()-1))}><Icon name="chevronLeft"/></button>
                                    <span className="font-bold text-lg">{date.getFullYear()} å¹´ {date.getMonth()+1} æœˆ</span>
                                    <button onClick={()=>setDate(new Date(date.getFullYear(), date.getMonth()+1))}><Icon name="chevronRight"/></button>
                                </div>
                                {/* Calendar Grid */}
                                <div className="grid grid-cols-7 gap-2 text-center mb-2">
                                    {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><span key={d} className="text-xs text-gray-400">{d}</span>)}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {Array.from({length: new Date(date.getFullYear(), date.getMonth(), 1).getDay()}).map((_,i)=><div key={'e'+i}/>)}
                                    {Array.from({length: new Date(date.getFullYear(), date.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                        const d = i+1;
                                        const curr = new Date(date.getFullYear(), date.getMonth(), d);
                                        const dStr = curr.toISOString().split('T')[0];
                                        const conf = settings[loc.id];
                                        // Allow if in allowedDates OR open by default?
                                        // Use previous logic: allowedDates whitelist
                                        const isOpen = conf?.allowedDates?.includes(dStr);
                                        const isPast = curr < new Date().setHours(0,0,0,0);
                                        const isSel = d === date.getDate();
                                        
                                        return (
                                            <button key={d} disabled={isPast || !isOpen} 
                                                onClick={() => { setDate(curr); setTime(null); }}
                                                className={`h-9 w-9 rounded-full text-sm flex items-center justify-center transition-all ${isSel ? 'bg-[#8d6e63] text-white shadow-md font-bold' : (isPast || !isOpen) ? 'text-gray-200' : 'hover:bg-[#F5F5F5] font-medium'}`}>
                                                {d}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>

                            {/* Time Slots */}
                            <div className="grid grid-cols-3 gap-3">
                                {DEFAULT_SLOTS.map(t => {
                                    const dStr = date.toISOString().split('T')[0];
                                    const conf = settings[loc.id];
                                    const slots = (conf?.specialRules && conf.specialRules[dStr]) || (conf?.timeSlots || DEFAULT_SLOTS);
                                    
                                    // Check if booked
                                    const isBooked = booked.includes(t);
                                    // Check if valid slot for this day
                                    const isValid = slots.includes(t);

                                    if (!isValid) return null;

                                    return (
                                        <button key={t} disabled={isBooked} 
                                            onClick={() => { setTime(t); setCustomTime(''); }}
                                            className={`time-chip ${time === t ? 'active' : ''} ${isBooked ? 'disabled' : ''}`}>
                                            {t} {isBooked && <span className="block text-[10px] font-normal">å·²æ»¿</span>}
                                        </button>
                                    );
                                })}
                            </div>

                            {time === 'å¾®èª¿æ™‚æ®µç”³è«‹' && (
                                <div className="fade-in bg-[#FFFBF9] border border-[#EBE0D9] p-4 rounded-xl">
                                    <label className="text-xs font-bold text-[#8D6E63] mb-1 block">è«‹è¼¸å…¥å¸Œæœ›æ™‚é–“</label>
                                    <input type="time" className="w-full text-xl font-bold bg-transparent outline-none text-center" value={customTime} onChange={e=>setCustomTime(e.target.value)} />
                                </div>
                            )}
                        </div>
                    )}

                    {/* Step 3: Info */}
                    {step === 3 && (
                        <div className="fade-in space-y-4">
                            <div className="app-card space-y-4">
                                <div><label className="text-xs text-gray-400 font-bold ml-1">è¯çµ¡å§“å</label><input className="w-full p-3 bg-[#FAFAFA] rounded-xl border-none outline-none font-medium focus:ring-1 focus:ring-[#C4A48C]" placeholder="çœŸå¯¦å§“å" value={info.name} onChange={e=>setInfo({...info, name:e.target.value})}/></div>
                                <div><label className="text-xs text-gray-400 font-bold ml-1">é›»è©±</label><input type="tel" className="w-full p-3 bg-[#FAFAFA] rounded-xl border-none outline-none font-medium focus:ring-1 focus:ring-[#C4A48C]" placeholder="09xx-xxx-xxx" value={info.phone} onChange={e=>setInfo({...info, phone:e.target.value})}/></div>
                                <div><label className="text-xs text-gray-400 font-bold ml-1">å‚™è¨»</label><textarea className="w-full p-3 bg-[#FAFAFA] rounded-xl border-none outline-none font-medium focus:ring-1 focus:ring-[#C4A48C] h-24 resize-none" placeholder="æ³¨æ„äº‹é …..." value={info.notes} onChange={e=>setInfo({...info, notes:e.target.value})}/></div>
                            </div>
                            
                            <div className="bg-[#FFFBF9] p-5 rounded-2xl border border-[#EBE0D9] space-y-3">
                                <h3 className="font-bold text-[#5D4037]">è¨‚é‡‘è³‡è¨Š</h3>
                                <div className="flex justify-between text-sm"><span>éŠ€è¡Œ</span><span className="font-bold">{BANK_INFO.code}</span></div>
                                <div className="flex justify-between text-sm"><span>å¸³è™Ÿ</span><span className="font-bold tracking-widest">{BANK_INFO.account}</span></div>
                                <div className="flex justify-between text-sm border-t border-dashed border-[#D7CCC8] pt-2 mt-2">
                                    <span>æ‡‰ä»˜è¨‚é‡‘</span><span className="text-red-500 font-bold text-lg">${deposit}</span>
                                </div>
                            </div>
                            <label className="flex items-center gap-2 justify-center py-2"><input type="checkbox" id="agree" className="w-5 h-5 accent-[#8D6E63]"/> <span className="text-sm font-bold text-[#8D6E63]">æˆ‘åŒæ„æ”¯ä»˜è¨‚é‡‘è¦å‰‡</span></label>
                        </div>
                    )}
                </div>

                {/* Sticky Footer */}
                {step < 4 && (
                    <div className="sticky-footer flex items-center gap-4">
                        <div className="flex-1">
                            <div className="text-xs text-gray-400">é ä¼°ç¸½é¡</div>
                            <div className="text-2xl font-bold text-[#5D4037]">${total}</div>
                        </div>
                        <button onClick={() => {
                            if(step===1 && guests.some(g=>g.services.length===0)) return alert('è«‹é¸æ“‡æœå‹™');
                            if(step===2 && !time) return alert('è«‹é¸æ“‡æ™‚é–“');
                            if(step===3) handleSubmit();
                            else setStep(s=>s+1);
                        }} className="bg-[#2C2C2C] text-white px-8 py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">
                            {step===3 ? 'é€å‡ºé ç´„' : 'ä¸‹ä¸€æ­¥'}
                        </button>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
