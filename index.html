<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·šä¸Šé ç´„ç³»çµ±</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Serif TC', serif; background-color: #f4f1ea; }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #8d6e63; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* ç”¨æ–¼å¾Œå°æœˆæ›†é¸å– */
    .date-cell.selected { background-color: #8d6e63; color: white; border-color: #8d6e63; }
    .date-cell:hover:not(.selected) { background-color: #efebe9; }
  </style>

  <!-- 1. æ ¸å¿ƒç¨‹å¼åº« -->
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin="anonymous" src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <!-- 2. Firebase -->
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <!-- 3. LIFF -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  
  <div id="root">
    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #8d6e63;">
      <div class="spinner"></div>
      <p id="loading-text">ç³»çµ±å•Ÿå‹•ä¸­...</p>
    </div>
  </div>

  <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; padding:20px; text-align:center;">
    <div style="max-width:500px; margin:50px auto; border:2px solid #ef4444; padding:20px; background:#fff; border-radius:8px;">
        <h2 style="color:#ef4444; font-size:24px; margin-bottom:10px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="error-msg" style="color:#333; margin-bottom:20px; word-break:break-all;"></p>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#8d6e63; color:white; border:none; border-radius:4px;">é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <script>
    window.onerror = function(msg, url, line) {
      document.getElementById('root').style.display = 'none';
      document.getElementById('error-box').style.display = 'block';
      let cleanMsg = msg;
      if (msg.includes("Script error")) cleanMsg = "ç€è¦½å™¨é˜»æ“‹äº†ç¨‹å¼ç¢¼è¼‰å…¥ï¼Œé€šå¸¸æ˜¯ Firebase è¨­å®šæœ‰èª¤æˆ–ç¶²è·¯å•é¡Œã€‚";
      document.getElementById('error-msg').innerHTML = `<strong>åŸå› ï¼š</strong>${cleanMsg}<br><br><small>(${url}:${line})</small>`;
      return false;
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // ==========================================
    // â¬‡ï¸ Firebase è¨­å®š â¬‡ï¸
    // ==========================================
    const rawFirebaseConfig = {
      apiKey: "AIzaSyCzCXFgd7VrWHyHrM3GILQ2JHzQaa7yoIw",
      authDomain: "amstudio-booking.firebaseapp.com",
      projectId: "amstudio-booking",
      storageBucket: "amstudio-booking.firebasestorage.app",
      messagingSenderId: "197698776484",
      appId: "1:197698776484:web:818beeea66d470bfc36531"
    };
    // ==========================================

    const LIFF_ID = '2008567948-rNVLPLYb';
    const APP_ID = 'booking-system-web';
    const ADMIN_PIN = '1234';

    let db, auth;
    let initError = null;

    try {
        if (rawFirebaseConfig.apiKey === "è«‹å¡«å…¥æ‚¨çš„apiKey") throw new Error("è«‹å¡«å…¥æ­£ç¢ºçš„ Firebase Config é‡‘é‘°ï¼");
        const config = {};
        for (let key in rawFirebaseConfig) {
            let val = rawFirebaseConfig[key];
            if (typeof val === 'string') val = val.trim(); 
            config[key] = val;
        }
        if (!firebase.apps.length) firebase.initializeApp(config);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) {
        initError = e.message;
        console.error("Init Error", e);
    }

    const Icon = ({ path, size = 24 }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{path}</svg>
    );

    const SvgPaths = {
        map: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
        right: <path d="m9 18 6-6-6-6"/>,
        left: <path d="m15 18-6-6 6-6"/>,
        settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
        user: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
        file: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>,
        check: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
        trash: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
        plus: <><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>,
        info: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>
    };

    const LOCATIONS = [{ id: 'tainan', name: 'å°å—å·¥ä½œå®¤' }, { id: 'kaohsiung', name: 'é«˜é›„å·¥ä½œå®¤' }];
    const DEFAULT_TIME_SLOTS = ["11:00", "13:00", "15:00", "17:00", "18:30", "å¾®èª¿æ™‚æ®µç”³è«‹"];
    const DISCOUNT_NOTE = "â€» å„ªæƒ èº«åˆ†åŒ…å«ï¼šå­¸ç”Ÿã€é†«è­·ã€è»å…¬æ•™ã€ç•¶æœˆå£½æ˜Ÿã€èˆŠå®¢ä»‹ç´¹ (è«‹æ–¼ç¾å ´å‡ºç¤ºè­‰æ˜)";

    // --- ç®¡ç†æ—¥æ›†çµ„ä»¶ ---
    const AdminCalendar = ({ allowedDatesStr, onChange }) => {
        const [viewDate, setViewDate] = useState(new Date());
        
        // è§£æç›®å‰çš„æ—¥æœŸå­—ä¸²ç‚º Setï¼Œæ–¹ä¾¿æŸ¥æ‰¾
        const allowedSet = new Set(allowedDatesStr.split(',').map(d => d.trim()).filter(d => d));

        const toggleDate = (dateStr) => {
            const newSet = new Set(allowedSet);
            if (newSet.has(dateStr)) newSet.delete(dateStr);
            else newSet.add(dateStr);
            onChange(Array.from(newSet).sort().join(','));
        };

        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();

        return (
            <div className="bg-white border rounded p-2 text-center w-full max-w-sm mx-auto">
                <div className="flex justify-between mb-2">
                    <button onClick={() => setViewDate(new Date(year, month - 1))} className="px-2 py-1 bg-gray-100 rounded">&lt;</button>
                    <span className="font-bold">{year}å¹´ {month + 1}æœˆ</span>
                    <button onClick={() => setViewDate(new Date(year, month + 1))} className="px-2 py-1 bg-gray-100 rounded">&gt;</button>
                </div>
                <div className="grid grid-cols-7 gap-1 text-xs mb-1">
                    {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="text-gray-400">{d}</div>)}
                </div>
                <div className="grid grid-cols-7 gap-1">
                    {Array.from({ length: firstDay }).map((_, i) => <div key={'empty'+i} />)}
                    {Array.from({ length: daysInMonth }).map((_, i) => {
                        const d = i + 1;
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const isSelected = allowedSet.has(dateStr);
                        return (
                            <button 
                                key={dateStr}
                                onClick={() => toggleDate(dateStr)}
                                className={`date-cell p-2 rounded text-sm transition-colors border ${isSelected ? 'selected' : 'border-transparent'}`}
                            >
                                {d}
                            </button>
                        );
                    })}
                </div>
                <div className="mt-2 text-xs text-gray-500">
                    é»æ“Šæ—¥æœŸä»¥é–‹æ”¾/é—œé–‰é ç´„
                </div>
            </div>
        );
    };

    function AppointmentApp() {
      if (initError) return <div className="p-10 text-center text-red-600 font-bold">è¨­å®šéŒ¯èª¤: {initError}</div>;

      const [user, setUser] = useState(null);
      const [view, setView] = useState('home'); 
      const [bookingStep, setBookingStep] = useState(1);
      const [selectedLocation, setSelectedLocation] = useState(null);
      const [selectedService, setSelectedService] = useState(null);
      const [selectedAddons, setSelectedAddons] = useState([]);
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedTime, setSelectedTime] = useState(null);
      // æ–°å¢ï¼šå¾®èª¿æ™‚é–“è¼¸å…¥
      const [customTimeInput, setCustomTimeInput] = useState('');
      
      const [customerInfo, setCustomerInfo] = useState({ name: '', phone: '', notes: '' });
      const [services, setServices] = useState([]);
      const [addons, setAddons] = useState([]);
      const [bookedSlots, setBookedSlots] = useState([]); 
      const [locationSettings, setLocationSettings] = useState({});
      const [adminPinInput, setAdminPinInput] = useState('');

      useEffect(() => {
        auth.signInAnonymously().catch(err => console.warn("Auth warning:", err));
        if (window.liff) window.liff.init({ liffId: LIFF_ID }).catch(e => console.log('Liff init skipped', e));
        return auth.onAuthStateChanged(setUser);
      }, []);

      useEffect(() => {
        if (!user) return;
        const dataRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
        dataRef.collection('services').orderBy('name').onSnapshot(s => setServices(s.docs.map(d => ({id:d.id, ...d.data()}))));
        dataRef.collection('addons').onSnapshot(s => setAddons(s.docs.map(d => ({id:d.id, ...d.data()}))));
        dataRef.collection('settings').onSnapshot(s => { const obj = {}; s.forEach(d => obj[d.id] = d.data()); setLocationSettings(obj); });
      }, [user]);

      useEffect(() => {
        if (!user || !selectedLocation || !selectedDate) return;
        const dStr = selectedDate.toISOString().split('T')[0];
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings')
          .where('locationId', '==', selectedLocation.id).where('date', '==', dStr)
          .onSnapshot(s => setBookedSlots(s.docs.map(d => d.data().time)));
      }, [user, selectedLocation, selectedDate]);

      const isDateAvailable = (date) => {
        if (!selectedLocation) return true;
        const set = locationSettings[selectedLocation.id];
        return (!set?.allowedDates?.length) ? true : set.allowedDates.includes(date.toISOString().split('T')[0]);
      };
      const getCurrentTimeSlots = () => {
        if (!selectedLocation) return DEFAULT_TIME_SLOTS;
        const set = locationSettings[selectedLocation.id];
        return (set?.timeSlots?.length) ? set.timeSlots : DEFAULT_TIME_SLOTS;
      };

      const handleSubmit = async () => {
        if (!user) return alert("ç³»çµ±é€£ç·šä¸­...");
        const addonsText = selectedAddons.length > 0 ? selectedAddons.map(a => `${a.name}(+$${a.price})`).join(', ') : 'ç„¡';
        
        // è™•ç†æ™‚é–“ï¼šå¦‚æœæ˜¯å¾®èª¿ï¼Œå‰‡çµ„åˆå­—ä¸²
        let finalTime = selectedTime;
        if (selectedTime === 'å¾®èª¿æ™‚æ®µç”³è«‹') {
            if (!customTimeInput) return alert('è«‹è¼¸å…¥æ‚¨æƒ³å¾®èª¿çš„æ™‚é–“');
            finalTime = `å¾®èª¿ç”³è«‹: ${customTimeInput}`;
        }

        const data = {
          locationId: selectedLocation.id, locationName: selectedLocation.name,
          serviceId: selectedService.id, serviceName: selectedService.name,
          addons: selectedAddons, date: selectedDate.toISOString().split('T')[0],
          time: finalTime, customerName: customerInfo.name,
          customerPhone: customerInfo.phone, notes: customerInfo.notes,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(), userId: user.uid
        };
        try {
          await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add(data);
          
          const msg = `ã€é ç´„é€šçŸ¥ã€‘\n` +
            `ğŸ  åœ°é»ï¼š${data.locationName}\n` +
            `ğŸ“… æ™‚é–“ï¼š${data.date} ${data.time}\n` +
            `ğŸ’† é …ç›®ï¼š${data.serviceName}\n` +
            `â• åŠ è³¼ï¼š${addonsText}\n` +
            `ğŸ‘¤ å§“åï¼š${data.customerName}\n` +
            `ğŸ“± é›»è©±ï¼š${data.customerPhone}\n` +
            `ğŸ“ å‚™è¨»ï¼š${data.customerInfo?.notes || 'ç„¡'}`;
            
          if (window.liff?.isInClient()) {
              await window.liff.sendMessages([{ type: 'text', text: msg }]);
          } else {
              alert("é ç´„æˆåŠŸï¼\nå› æ‚¨åœ¨ç€è¦½å™¨é–‹å•Ÿï¼Œè«‹è¤‡è£½ä¸‹æ–¹æ–‡å­—å‚³é€çµ¦å®˜æ–¹å¸³è™Ÿï¼š\n\n" + msg);
          }
          setBookingStep(5);
        } catch (e) { alert('é ç´„å¤±æ•—: ' + e.message); }
      };

      const reset = () => {
        setBookingStep(1); setSelectedLocation(null); setSelectedService(null); setSelectedAddons([]);
        setSelectedTime(null); setCustomTimeInput(''); setCustomerInfo({name:'',phone:'',notes:''}); setView('home');
      };

      if (view === 'admin-login') {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="bg-white p-8 rounded shadow-lg w-80 text-center border">
              <h2 className="text-xl font-bold mb-4">å¾Œå°ç™»å…¥</h2>
              <input type="password" placeholder="PIN" className="w-full border p-2 mb-4" value={adminPinInput} onChange={e=>setAdminPinInput(e.target.value)} />
              <div className="flex gap-2">
                <button onClick={()=>setView('home')} className="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button>
                <button onClick={()=>adminPinInput===ADMIN_PIN?setView('admin-dashboard'):alert('å¯†ç¢¼éŒ¯èª¤')} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">ç™»å…¥</button>
              </div>
            </div>
          </div>
        );
      }
      if (view === 'admin-dashboard') return <AdminDashboard onBack={()=>setView('home')} user={user} services={services} addons={addons} settings={locationSettings} />;
      if (view === 'home') {
        return (
          <div className="min-h-screen p-6 flex flex-col items-center justify-center bg-[#f4f1ea]">
             <button onClick={()=>setView('admin-login')} className="absolute top-4 left-4 p-2 opacity-30"><Icon path={SvgPaths.settings}/></button>
             <div className="bg-[#fdfbf7] p-8 rounded-sm shadow-xl border border-[#e8e4dc] max-w-md w-full text-center">
                <h1 className="text-3xl font-bold mb-2 text-[#4e342e] tracking-widest">ç·šä¸Šé ç´„</h1>
                <p className="text-[#8d6e63] mb-8 text-sm">è«‹é¸æ“‡æœå‹™æ“šé»</p>
                <div className="space-y-4">
                  {LOCATIONS.map(loc => (
                    <button key={loc.id} onClick={()=>{setSelectedLocation(loc); setView('booking'); setBookingStep(2)}} 
                      className="w-full bg-white border-2 border-[#d7ccc8] hover:border-[#8d6e63] p-6 rounded-lg flex items-center justify-between group transition-all">
                      <div className="flex items-center gap-4"><span className="bg-[#efebe9] p-3 rounded-full text-[#5d4037]"><Icon path={SvgPaths.map}/></span><h3 className="text-xl font-bold text-[#4e342e]">{loc.name}</h3></div><span className="text-[#d7ccc8] group-hover:text-[#8d6e63]"><Icon path={SvgPaths.right}/></span>
                    </button>
                  ))}
                </div>
             </div>
          </div>
        );
      }
      return (
        <div className="min-h-screen py-6 px-4 bg-[#f4f1ea]">
          <div className="max-w-lg mx-auto bg-[#fdfbf7] min-h-[85vh] rounded-sm shadow-xl border border-[#e8e4dc] flex flex-col">
            <div className="p-6 border-b border-[#e8e4dc] flex items-center justify-between bg-white/50">
               <button onClick={()=>bookingStep===2?reset():setBookingStep(s=>s-1)} className="text-[#8d6e63]"><Icon path={SvgPaths.left}/></button>
               <span className="font-bold text-[#4e342e]">{bookingStep===2?'é¸æ“‡æœå‹™':bookingStep===3?'é¸æ“‡æ™‚é–“':'è³‡æ–™ç¢ºèª'}</span><div className="w-6"></div>
            </div>
            <div className="flex-1 p-6 overflow-y-auto">
              {bookingStep===2 && (
                <div className="space-y-6">
                  <div className="bg-[#efebe9]/50 p-4 rounded text-xs text-[#6d4c41] flex gap-2"><span className="mt-0.5"><Icon path={SvgPaths.info} size={16}/></span>{DISCOUNT_NOTE}</div>
                  <div className="grid gap-3">{services.map(s=>(<label key={s.id} className={`flex items-center justify-between p-4 border rounded-lg cursor-pointer ${selectedService?.id===s.id?'border-[#8d6e63] bg-[#efebe9]':'border-gray-200'}`}><div className="flex items-center gap-3"><input type="radio" name="svc" className="accent-[#8d6e63] w-5 h-5" checked={selectedService?.id===s.id} onChange={()=>setSelectedService(s)}/><div><div className="font-bold">{s.name}</div><div className="text-sm text-[#8d6e63]">${s.price} / {s.duration}åˆ†</div></div></div></label>))}</div>
                  {addons.length > 0 && (
                      <div className="mt-6 border-t pt-4 border-[#d7ccc8]">
                          <h3 className="font-bold text-[#4e342e] mb-3">åŠ è³¼å­é …ç›®</h3>
                          <div className="grid gap-2">
                              {addons.map(ad => {
                                  const isChecked = selectedAddons.some(a => a.id === ad.id);
                                  return (
                                    <label key={ad.id} className={`flex items-center justify-between p-3 border rounded cursor-pointer ${isChecked ? 'bg-[#efebe9] border-[#8d6e63]' : 'border-gray-200'}`}>
                                        <div className="flex items-center gap-2">
                                            <input type="checkbox" className="accent-[#8d6e63]" checked={isChecked} onChange={e => { if(e.target.checked) setSelectedAddons([...selectedAddons, ad]); else setSelectedAddons(selectedAddons.filter(a => a.id !== ad.id)); }} />
                                            <span>{ad.name}</span>
                                        </div>
                                        <span className="text-sm text-[#8d6e63]">+${ad.price}</span>
                                    </label>
                                  );
                              })}
                          </div>
                      </div>
                  )}
                </div>
              )}
              {bookingStep===3 && (
                 <div className="space-y-6">
                   <div className="bg-white p-4 rounded border shadow-sm">
                     <div className="flex justify-between items-center mb-4"><button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()-1)))} className="p-1 hover:bg-gray-100"><Icon path={SvgPaths.left}/></button><span className="font-bold">{selectedDate.getFullYear()}/{selectedDate.getMonth()+1}</span><button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()+1)))} className="p-1 hover:bg-gray-100"><Icon path={SvgPaths.right}/></button></div>
                     <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d} className="text-xs text-gray-400">{d}</div>)}</div>
                     <div className="grid grid-cols-7 gap-1">{Array.from({length:new Date(selectedDate.getFullYear(),selectedDate.getMonth(),1).getDay()}).map((_,i)=><div key={'e'+i}/>)}{Array.from({length:new Date(selectedDate.getFullYear(),selectedDate.getMonth()+1,0).getDate()}).map((_,i)=>{const d=i+1,cur=new Date(selectedDate.getFullYear(),selectedDate.getMonth(),d),avail=isDateAvailable(cur),past=cur<new Date().setHours(0,0,0,0),isSel=d===selectedDate.getDate();return <button key={d} disabled={past||!avail} onClick={()=>{setSelectedDate(cur);setSelectedTime(null)}} className={`h-8 w-8 rounded-full text-sm mx-auto flex items-center justify-center relative ${isSel?'bg-[#8d6e63] text-white':past||!avail?'text-gray-200':'hover:bg-[#efebe9]'}`}>{d}{!past&&avail&&!isSel&&<div className="absolute bottom-1 w-1 h-1 bg-[#8d6e63] rounded-full"/>}</button>})}</div>
                   </div>
                   
                   {/* æ™‚æ®µé¸æ“‡å€ */}
                   {isDateAvailable(selectedDate)? (
                       <div>
                           <div className="grid grid-cols-2 gap-3 mb-4">
                               {getCurrentTimeSlots().map(t=>(
                                   <button key={t} disabled={bookedSlots.includes(t)} 
                                     onClick={()=>{setSelectedTime(t); setCustomTimeInput('')}} 
                                     className={`py-3 rounded border text-sm ${selectedTime===t?'bg-[#8d6e63] text-white':bookedSlots.includes(t)?'bg-gray-100 text-gray-300':'bg-white hover:border-[#8d6e63]'}`}
                                   >
                                     {t} {bookedSlots.includes(t) && '(å·²æ»¿)'}
                                   </button>
                               ))}
                           </div>
                           
                           {/* ğŸŒŸ å¾®èª¿æ™‚æ®µè¼¸å…¥æ¡†ï¼šåªæœ‰ç•¶é¸æ“‡ã€Œå¾®èª¿æ™‚æ®µç”³è«‹ã€æ™‚æ‰å‡ºç¾ */}
                           {selectedTime === 'å¾®èª¿æ™‚æ®µç”³è«‹' && (
                               <div className="p-4 bg-[#efebe9]/50 rounded border border-[#d7ccc8] animate-fade-in">
                                   <label className="block text-sm font-bold text-[#6d4c41] mb-2 flex items-center gap-2">
                                       <Icon path={SvgPaths.clock} size={16}/> è«‹é¸æ“‡æ‚¨å¸Œæœ›çš„å¾®èª¿æ™‚é–“ï¼š
                                   </label>
                                   <input 
                                     type="time" 
                                     className="w-full p-2 rounded border border-[#d7ccc8] bg-white text-lg text-center font-bold text-[#5d4037]"
                                     value={customTimeInput}
                                     onChange={e => setCustomTimeInput(e.target.value)}
                                   />
                                   <p className="text-xs text-[#8d6e63] mt-2">â€» å¯¦éš›å®‰æ’éœ€å¾…æˆ‘å€‘ç¢ºèªå¾Œå›è¦†ã€‚</p>
                               </div>
                           )}
                       </div>
                   ) : <div className="text-center text-red-400 text-sm">æ­¤æ—¥æœŸæœªé–‹æ”¾é ç´„</div>}
                 </div>
              )}
              {bookingStep===4 && (
                <div className="space-y-4">
                  <div className="bg-[#efebe9] p-4 rounded text-sm space-y-2 border border-[#d7ccc8]"><div className="flex justify-between"><span className="text-[#a1887f]">åœ°é»</span><b>{selectedLocation?.name}</b></div><div className="flex justify-between"><span className="text-[#a1887f]">æ™‚é–“</span><b>{selectedDate.toLocaleDateString()} {selectedTime === 'å¾®èª¿æ™‚æ®µç”³è«‹' ? `å¾®èª¿ ${customTimeInput}` : selectedTime}</b></div><div className="flex justify-between"><span className="text-[#a1887f]">é …ç›®</span><b>{selectedService?.name}</b></div>
                  {selectedAddons.length > 0 && <div className="flex justify-between"><span className="text-[#a1887f]">åŠ è³¼</span><b>{selectedAddons.map(a=>a.name).join(', ')}</b></div>}
                  </div>
                  <input type="text" placeholder="å§“å" className="w-full border-b-2 bg-transparent py-2 outline-none" value={customerInfo.name} onChange={e=>setCustomerInfo({...customerInfo,name:e.target.value})}/><input type="tel" placeholder="é›»è©±" className="w-full border-b-2 bg-transparent py-2 outline-none" value={customerInfo.phone} onChange={e=>setCustomerInfo({...customerInfo,phone:e.target.value})}/><textarea placeholder="å‚™è¨»" className="w-full border-b-2 bg-transparent py-2 outline-none resize-none" rows={2} value={customerInfo.notes} onChange={e=>setCustomerInfo({...customerInfo,notes:e.target.value})}/>
                </div>
              )}
              {bookingStep===5 && <div className="text-center py-10"><div className="text-green-600 mb-4 flex justify-center"><Icon path={SvgPaths.check} size={48}/></div><h2 className="text-2xl font-bold mb-6">é ç´„æˆåŠŸï¼</h2><button onClick={reset} className="bg-[#8d6e63] text-white px-8 py-3 rounded">å›é¦–é </button></div>}
            </div>
            {bookingStep<5 && <div className="p-6 border-t bg-white/50"><button onClick={()=>{
                if(bookingStep===2&&!selectedService)return alert('è«‹é¸æ“‡æœå‹™');
                if(bookingStep===3) {
                    if(!selectedTime) return alert('è«‹é¸æ“‡æ™‚é–“');
                    if(selectedTime === 'å¾®èª¿æ™‚æ®µç”³è«‹' && !customTimeInput) return alert('è«‹è¼¸å…¥å¾®èª¿æ™‚é–“');
                }
                if(bookingStep===4&&(!customerInfo.name||!customerInfo.phone))return alert('è«‹å¡«å¯«è³‡æ–™');
                bookingStep===4?handleSubmit():setBookingStep(s=>s+1);
            }} className="w-full bg-[#8d6e63] text-white py-3 rounded shadow hover:bg-[#795548]">{bookingStep===4?'ç¢ºèªé ç´„':'ä¸‹ä¸€æ­¥'}</button></div>}
          </div>
        </div>
      );
    }

    function AdminDashboard({ onBack, user, services, addons, settings }) {
      const [tab, setTab] = useState('set');
      const [books, setBooks] = useState([]);
      const [kaD, setKaD] = useState(settings['kaohsiung']?.allowedDates?.join(',')||'');
      const [kaT, setKaT] = useState(settings['kaohsiung']?.timeSlots?.join(',')||DEFAULT_TIME_SLOTS.join(','));
      const [taD, setTaD] = useState(settings['tainan']?.allowedDates?.join(',')||'');
      const [taT, setTaT] = useState(settings['tainan']?.timeSlots?.join(',')||DEFAULT_TIME_SLOTS.join(','));
      const [loading, setLoading] = useState(false);
      const [showManual, setShowManual] = useState(false);
      
      const [mLoc, setMLoc] = useState('tainan');
      const [mDate, setMDate] = useState('');
      const [mTime, setMTime] = useState('');
      const [mSvc, setMSvc] = useState('');
      const [mName, setMName] = useState('');
      const [mPhone, setMPhone] = useState('');

      useEffect(()=>{
        if(!user)return;
        db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').orderBy('date','desc').onSnapshot(s=>setBooks(s.docs.map(d=>({id:d.id,...d.data()}))));
      },[user]);

      const save = async (id, d, t) => {
        setLoading(true);
        try {
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('settings').doc(id).set({
              allowedDates: d.split(',').map(x=>x.trim()).filter(x=>x), 
              timeSlots: t.split(',').map(x=>x.trim()).filter(x=>x)
            }); 
            alert('å„²å­˜æˆåŠŸï¼');
        } catch(e) {
            alert('å„²å­˜å¤±æ•—ï¼\néŒ¯èª¤åŸå› ï¼š' + e.message);
        }
        setLoading(false);
      };

      const addSvc = async () => {
         const n = prompt('æœå‹™åç¨±'); const p = prompt('åƒ¹æ ¼'); const d = prompt('æœå‹™æ™‚é–“(åˆ†é˜)', '90');
         if(n&&p&&d) await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').add({name:n,price:Number(p),duration:Number(d)});
      };

      const addAddon = async () => {
         const n = prompt('åŠ è³¼é …ç›®åç¨±'); const p = prompt('åŠ è³¼åƒ¹æ ¼');
         if(n&&p) await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('addons').add({name:n,price:Number(p)});
      };
      
      const submitManual = async () => {
        if(!mDate || !mTime || !mSvc || !mName) return alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
        const locName = LOCATIONS.find(l=>l.id===mLoc)?.name || 'æœªçŸ¥';
        const svcName = services.find(s=>s.id===mSvc)?.name || 'æ‰‹å‹•é …ç›®';
        
        try {
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').add({
                locationId: mLoc, locationName: locName,
                serviceId: mSvc, serviceName: svcName,
                date: mDate, time: mTime,
                customerName: mName, customerPhone: mPhone,
                notes: 'å¾Œå°æ‰‹å‹•æ–°å¢',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: user.uid
            });
            alert('æ–°å¢æˆåŠŸï¼');
            setShowManual(false);
            setMName(''); setMPhone('');
        } catch(e) {
            alert('å¤±æ•—: '+e.message);
        }
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4">
           <div className="bg-white rounded shadow max-w-4xl mx-auto overflow-hidden">
             <div className="flex justify-between p-4 border-b"><b>å¾Œå°ç®¡ç†</b><button onClick={onBack} className="bg-gray-500 text-white px-3 py-1 rounded text-sm">é›¢é–‹</button></div>
             <div className="flex border-b text-sm"><button onClick={()=>setTab('set')} className={`flex-1 py-3 ${tab==='set'?'text-[#8d6e63] font-bold':''}`}>è¨­å®š</button><button onClick={()=>setTab('svc')} className={`flex-1 py-3 ${tab==='svc'?'text-[#8d6e63] font-bold':''}`}>æœå‹™</button><button onClick={()=>setTab('addons')} className={`flex-1 py-3 ${tab==='addons'?'text-[#8d6e63] font-bold':''}`}>åŠ è³¼</button><button onClick={()=>setTab('book')} className={`flex-1 py-3 ${tab==='book'?'text-[#8d6e63] font-bold':''}`}>é ç´„</button></div>
             <div className="p-4">
               {loading && <div className="text-center text-[#8d6e63] mb-4">è™•ç†ä¸­...</div>}
               {tab==='set' && (
                 <div className="space-y-8 text-sm">
                   
                   {/* é«˜é›„è¨­å®š - å‡ç´šç‚ºæœˆæ›† */}
                   <div className="border p-4 rounded bg-orange-50">
                     <b className="text-orange-800 block mb-4 text-lg">é«˜é›„å·¥ä½œå®¤ - é–‹æ”¾æ—¥æœŸè¨­å®š</b>
                     <div className="flex flex-col md:flex-row gap-6">
                         <div className="flex-shrink-0">
                             <AdminCalendar allowedDatesStr={kaD} onChange={newStr => setKaD(newStr)} />
                         </div>
                         <div className="flex-1 space-y-4">
                             <div>
                                 <label className="block font-bold mb-1">é–‹æ”¾æ™‚æ®µ (é€—è™Ÿåˆ†éš”)</label>
                                 <input className="w-full border p-2 bg-white rounded" value={kaT} onChange={e=>setKaT(e.target.value)}/>
                             </div>
                             <div>
                                 <label className="block font-bold mb-1">å·²é¸æ—¥æœŸé è¦½</label>
                                 <textarea className="w-full border p-2 h-20 bg-gray-100 text-gray-500 rounded" readOnly value={kaD} />
                             </div>
                             <button onClick={()=>save('kaohsiung',kaD,kaT)} className="bg-orange-600 text-white px-6 py-2 rounded shadow hover:bg-orange-700 w-full md:w-auto">å„²å­˜é«˜é›„è¨­å®š</button>
                         </div>
                     </div>
                   </div>

                   {/* å°å—è¨­å®š - å‡ç´šç‚ºæœˆæ›† */}
                   <div className="border p-4 rounded bg-blue-50">
                     <b className="text-blue-800 block mb-4 text-lg">å°å—å·¥ä½œå®¤ - é–‹æ”¾æ—¥æœŸè¨­å®š</b>
                     <div className="flex flex-col md:flex-row gap-6">
                         <div className="flex-shrink-0">
                             <AdminCalendar allowedDatesStr={taD} onChange={newStr => setTaD(newStr)} />
                         </div>
                         <div className="flex-1 space-y-4">
                             <div>
                                 <label className="block font-bold mb-1">é–‹æ”¾æ™‚æ®µ (é€—è™Ÿåˆ†éš”)</label>
                                 <input className="w-full border p-2 bg-white rounded" value={taT} onChange={e=>setTaT(e.target.value)}/>
                             </div>
                             <div>
                                 <label className="block font-bold mb-1">å·²é¸æ—¥æœŸé è¦½ (ç•™ç©ºä»£è¡¨æ¯æ—¥é–‹æ”¾)</label>
                                 <textarea className="w-full border p-2 h-20 bg-gray-100 text-gray-500 rounded" readOnly value={taD} />
                             </div>
                             <button onClick={()=>save('tainan',taD,taT)} className="bg-blue-800 text-white px-6 py-2 rounded shadow hover:bg-blue-700 w-full md:w-auto">å„²å­˜å°å—è¨­å®š</button>
                         </div>
                     </div>
                   </div>

                 </div>
               )}
               {tab==='svc' && (
                 <div>
                   <button onClick={addSvc} className="mb-4 border border-[#8d6e63] text-[#8d6e63] px-4 py-2 rounded flex items-center gap-2 text-sm"><Icon path={SvgPaths.plus} size={16}/>æ–°å¢æœå‹™</button>
                   <div className="space-y-2">{services.map(s=><div key={s.id} className="flex justify-between border p-2 rounded text-sm"><span>{s.name} (${s.price}) {s.duration}åˆ†</span><button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('services').doc(s.id).delete()} className="text-red-500"><Icon path={SvgPaths.trash} size={16}/></button></div>)}</div>
                 </div>
               )}
               {tab==='addons' && (
                 <div>
                   <button onClick={addAddon} className="mb-4 border border-[#8d6e63] text-[#8d6e63] px-4 py-2 rounded flex items-center gap-2 text-sm"><Icon path={SvgPaths.plus} size={16}/>æ–°å¢åŠ è³¼é …ç›®</button>
                   <div className="space-y-2">{addons.map(a=><div key={a.id} className="flex justify-between border p-2 rounded text-sm"><span>{a.name} (+$${a.price})</span><button onClick={()=>db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('addons').doc(a.id).delete()} className="text-red-500"><Icon path={SvgPaths.trash} size={16}/></button></div>)}</div>
                 </div>
               )}
               {tab==='book' && (
                 <div>
                    <button onClick={()=>setShowManual(true)} className="mb-4 bg-[#8d6e63] text-white px-4 py-2 rounded text-sm flex items-center gap-2"><Icon path={SvgPaths.plus} size={16}/>æ‰‹å‹•æ–°å¢é ç´„</button>
                    <div className="space-y-2">{books.map(b=><div key={b.id} className="border-b p-2 text-sm flex justify-between"><div><div className="font-bold text-[#8d6e63]">{b.date} {b.time} <span className="text-xs bg-gray-200 px-1 rounded">{b.locationName}</span></div><div>{b.serviceName} {b.addons?.length > 0 && `(+${b.addons.length})`} - {b.customerName}</div></div><button onClick={()=>confirm('åˆªé™¤é ç´„?')&&db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bookings').doc(b.id).delete()} className="text-red-400"><Icon path={SvgPaths.trash} size={16}/></button></div>)}</div>
                    
                    {showManual && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded shadow-lg w-full max-w-sm">
                                <h3 className="font-bold mb-4 text-lg">æ–°å¢é ç´„</h3>
                                <div className="space-y-3 text-sm">
                                    <select className="w-full border p-2 rounded" value={mLoc} onChange={e=>setMLoc(e.target.value)}>{LOCATIONS.map(l=><option key={l.id} value={l.id}>{l.name}</option>)}</select>
                                    <input type="date" className="w-full border p-2 rounded" value={mDate} onChange={e=>setMDate(e.target.value)} />
                                    <input type="time" className="w-full border p-2 rounded" value={mTime} onChange={e=>setMTime(e.target.value)} />
                                    <select className="w-full border p-2 rounded" value={mSvc} onChange={e=>setMSvc(e.target.value)}>
                                        <option value="">é¸æ“‡æœå‹™</option>
                                        {services.map(s=><option key={s.id} value={s.id}>{s.name}</option>)}
                                    </select>
                                    <input type="text" placeholder="é¡§å®¢å§“å" className="w-full border p-2 rounded" value={mName} onChange={e=>setMName(e.target.value)} />
                                    <input type="text" placeholder="é›»è©± (é¸å¡«)" className="w-full border p-2 rounded" value={mPhone} onChange={e=>setMPhone(e.target.value)} />
                                </div>
                                <div className="mt-6 flex gap-2">
                                    <button onClick={()=>setShowManual(false)} className="flex-1 bg-gray-200 py-2 rounded">å–æ¶ˆ</button>
                                    <button onClick={submitManual} className="flex-1 bg-[#8d6e63] text-white py-2 rounded">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                 </div>
               )}
             </div>
           </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AppointmentApp />);
  </script>
</body>
</html>
